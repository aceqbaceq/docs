iproute2


никаких ip link set dev ens160 down
а только ifup ens160
ifdown ens160

s$ cat /etc/iproute2/rt_tables
#
# reserved values
#
255     local
254     main
253     default
0       unspec
#
# local
#
#1      inr.ruhep
200 net192_168_1_0
201 net192_168_0_0
203 net192_168_7_0



$ cat /etc/network/interfaces

k-kub2-06:~#
root@mk-kub2-06:~# cat /etc/network/interfaces
# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

source /etc/network/interfaces.d/*

# The loopback network interface
auto lo
iface lo inet loopback

# The primary network interface



auto ens160

iface ens160 inet static
        address 192.168.1.56
        netmask 255.255.255.0
        gateway 192.168.1.1

        dns-nameservers 192.168.1.1
        dns-search m9.local


         post-up ip route add   192.168.1.0/24 dev ens160  table T1
         post-up ip route add  default   via 192.168.1.1  dev ens160 table T1
         post-up ip rule add from 192.168.1.0/24 table T1

         post-down ip rule del from 192.168.1.0/24 table T1


auto ens192

iface ens192 inet static
        address 192.168.7.243
        netmask 255.255.255.0


        post-up ip route add   192.168.7.0/24 dev ens192      table T7
        post-up ip route add  default   via 192.168.7.1  dev ens192    table T7
        post-up ip rule add from 192.168.7.0/24 table T7

        post-down ip rule del from 192.168.7.0/24 table T7



iface ens192 inet static
        address 192.168.0.243
        netmask 255.255.255.0


        post-up ip route add   192.168.0.0/24 dev ens192  table T0
        post-up ip route add  default   via 192.168.0.1  dev ens192  table T0
        post-up ip rule add from 192.168.0.0/24 table T0


        post-down ip rule del from 192.168.0.0/24 table T0








также упомянть что src в маршуртах играет рояль для пакетов которые рождаются на самом компе и нужно понять какой srcip им подставить.
а для пакетов ответ он неиспользуется. таким образом если на компе скажем несколько ip из одной сети 192.168.0.243 и 192.168.0.30 то ненадо 
бояться что записи в маршрутах src 192.168.0.243 будут перебивать 192.168.0.30 это нетак.

далее вызла проблема я. то указал 
	ip rule add from 192.168.1.0/24
то есть для всей подсети. и тошгда почему то на подах (они то тут причем) переестали на дата ноде liveness пинги проходить

а когда я сузил правило до ip rule add from 192.168.1.56
то на подах нормализовалось

что за фигня*?!?!?

обычная таблица маршрутизации она позволяет управлять в какую сетевую карту пихать пакет на основе его dst ip. 
при этом мы вобще неучитваем его src ip.

iprpute2 через ip rule позволяет маршуртиизровать также учитывая src ip
идетв связке с нескольмии dst таблицами маршрутизации

вообще таблицы марщрутизации можно всегда назвать dst ip таблицы маррутизауии

 в итоге пришось дополнительно написать службу systemd котораф встатлвяет маршруты
 
 ( см. "systemd сервис для iproute cni0.txt" )
 
 что это нам даст.
 
 у нас будет вот такая кастомная таблица маршрутизауии T0
 
default via 192.168.0.1 dev ens192
10.254.0.0/16 dev cni0  scope link
192.168.0.0/24 dev ens192  scope link


в которую будут лететь пакеты у которых src ip = 192.168.0.0/24  

# ip rule
0:      from all lookup local
32763:  from 192.168.0.0/24 lookup T0
32766:  from all lookup main
32767:  from all lookup default


это будут ответны пакеты когда обращались к IP хоста и они летят обратно.
прикол в том что если у на будет в таблице T0 толко две строки

default via 192.168.0.1 dev ens192
192.168.0.0/24 dev ens192  scope link

тогда пакеты возращающиеся от подов которые изнутри сделали запрос к
IP компа эти пакеты будут лететь на внешний гейтвей. что полная катастрофа.

а вот  с этой строкой которую мы вставили через systemd сервис самопмсный
10.254.0.0/16 dev cni0  scope link


default via 192.168.0.1 dev ens192
10.254.0.0/16 dev cni0  scope link
192.168.0.0/24 dev ens192  scope link

наши пакеты будут кидаться на cni0 и таким макаром они смогут вернуться 
на под который их породил.


еще раз схема такая пода имеет ip = 10.254.0.0\16 он лезет пингует
сервис которы крутится на сетевой карточке хоста 192.168.0.X так вот туда то пакеты долетают а обратно уже нет.

изначально проблема началась из за того что на хосте куба
стоит два ip

192.168.1.56
192.168.0.243

с клиентского компа 192.168.0.141 я образщаюсь через гейтвей на 
192.168.1.56 та как у хоста есть доп карта 192.168.0.243 то обратно пакеты вылетают не через 1.56 а через 0.243 это вызывает проблемы.

поэтому я заюзал кастомные таблицы марщрутизации от iproute2
которые заставляют маршрутизироватся пакеыт нетолко по dst ip но и по srcip таким макаром пакеты которые влетели в 1.56 они возвращаются обратно через 1.56 сет карту. а которые влетели в 0.243 возврашаются тоэе тольеко через нее.

но это породило другую проблемы что внутренняя сеть подов 10.254.0.0\16 оня для таблицы маршрутизации кастомной 

default via 192.168.0.1 dev ens192
192.168.0.0/24 dev ens192  scope link

выглядит как некая чужая сет в интернете и когда под обращшатся к IP хоста
то они туда долетают а кодга летят обратно к поду то таблциа маршрутзации
их кидает НАРУЖУ! на внешний гейтвей.

поэтому нужно в кажду кастомную таблицу машрутизации ( а их столько сколько  IP на хосте в штуках например у меня щас их три
192.168.1.56
192.168.0.243
192.168.7.243
так вот а каждую их трех кастмных таблиц надо всавтит строку

10.254.0.0/16 dev cni0  scope link

которуб можно вставить только через systemd сапоисный сервис.

--

| iproute2

| iproute2

вроде бы все что я делаю через 

  ip ....

оно не сохарнится после перезагрузки.
например если создать порт то он несохранистя..
поэтому надо юзать ncmli . он сохраняет то что 
сделано .

| tap

 # ip tuntap add dev tap5 mode tap user 1000


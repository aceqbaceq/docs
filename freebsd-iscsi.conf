| freebsd
| iscsi 


гоготовим хост iscsi сервера

freebsd-lagg.txt


pkg install screen


устанвока ntpd

server 89.109.251.23 iburst     # ntp3.vniiftri.ru
server 89.109.251.21 iburst     # ntp1  
server 89.109.251.22 iburst     # ntp2



sysrc ntpd_sync_on_start="YES"
sysrc ntpd_flags="-g"



pkg install htop
# htop -C


ставим smartd

## **1. Установка пакета:**
pkg install smartmontools

## **2. Автозапуск в /etc/rc.conf:**
smartd_enable="YES"
smartd_flags="-l local3"



## **3. Настройка /usr/local/etc/smartd.conf:**
cp /usr/local/etc/smartd.conf.sample /usr/local/etc/smartd.conf
vi /usr/local/etc/smartd.conf


## **4. Логирование в /etc/syslog.conf:**
local3.*    /var/log/smartd.log

## **5. Создай лог файл:**
touch /var/log/smartd.log
chmod 644 /var/log/smartd.log
killall -1 syslogd  # перезапуск syslogd

## **6. Запуск сервиса:**
service smartd start
service smartd status

включаем на всех диска кеш на запись
for i in $( seq 0 13); do echo "da=da$i"; smartctl --set=wcache,on /dev/da$i ; done

Проверка что кеш на запись у дисков включен
for i in $( seq 0 13); do echo "da=da$i"; smartctl -x /dev/da$i | grep -i Cache | grep -i disable ; done









echo 'ctld_enable="YES"' >> /etc/rc.conf



# for i in  0 1 2 3 4 5 6 7 8 9 10 13; do echo disk=da$i; smartctl -i /dev/da$i | grep -E "Serial|Logical Unit"; echo ; done 
disk=da0
Logical Unit id:      0x5000c500591bd82b
Serial number:        Z1X2W8B50000W4513NXK

disk=da1
Logical Unit id:      0x5000c500591c04fb
Serial number:        Z1X2X1SE0000W4513KNK

disk=da2
Logical Unit id:      0x5000c500591b6b33
Serial number:        Z1X2WB2000009445CDJ1



КАК ДОБАВЯЛТЬ ЛУНЫ ПОТОМ ПОЗЖЕ Я ОПИСАЛ НИЖЕ



# camcontrol devlist
# for i in 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16; do smartctl --set=wcache,on /dev/da$i; done


# >/etc/ctl.conf
# chmod 600 /etc/ctl.conf

# cat /etc/ctl.conf 
portal-group "default" {
}

portal-group "pg1" {
    tag "0x0001"
    discovery-filter "portal-name"
    discovery-auth-group "no-authentication"
    listen "100.69.11.5:3260"
    option "ha_shared" "on"
}

lun "da0" {
    ctl-lun "0"
    path "/dev/da0"
    blocksize "4096"
    device-id "FR-5 da0"
    option "vendor" "FR-5"
    option "product" "Z1X2WAX10000W4513PTR"    
    serial "Z1X2WAX10000W4513PTR"
    option "naa" "0x5000c500591b779b"
    option "insecure_tpc" "on"
    option "rpm" "7200"
    option "writecache" "off" 
    option "readcache" "on" 

}



lun "da1" {
    ctl-lun "1"
    path "/dev/da1"
    device-id "FR-5 da1"
    option "vendor" "FR-5"
    option "product" "Z1X2WB6J0000W45140VV"
    blocksize "4096"
    serial "Z1X2WB6J0000W45140VV"
    option "naa" "0x5000c500591b608f"
    option "insecure_tpc" "on"
    option "rpm" "7200"
    option "readcache" "on" 

}






auth-group "ag4tg1_1" {
    initiator-name "iqn.1994-09.org.freebsd:fr-1:01:abcd1234567890fr-1"
    auth-type "none"
}

target "iqn.2005-10.org.freenas.ctl:fr-5" {
    alias "fr-5"
    #portal-group "pg1" "ag4tg1_1"

   portal-group "pg1"          
   auth-group "ag4tg1_1"      

    lun "0" "da0"
    lun "1" "da1"
}





вот эти два поля
    option "vendor" "FR-5"
    option "product" "Z1X2WAX10000W4513PTR"    

они дают то что на клиенте в camcontrol devlist
будет видно вот это. тоесть легко будет понять с какго хоста и какой диск сидит на луне
на клиенте будет 
    # camcontrol devlist
...
...
<FR-5 Z1X2WAX10000W451 0001>       at scbus1 target 0 lun 0 (da14,pass15)
<FR-5 Z1X2WB6J0000W451 0001>       at scbus1 target 0 lun 1 (da15,pass16)




двигаем даьше установку сревера

# service ctld onestart


    # service ctld status
ctld is running as pid 4963.

    # ctladm islist 
  ID Portal           Initiator name                       Target name                         

    # ctladm lunlist 
(7:1:0/0): <FREEBSD CTLDISK 0001> Fixed Direct Access SPC-5 SCSI device
(7:1:1/1): <FREEBSD CTLDISK 0001> Fixed Direct Access SPC-5 SCSI device

    # ctladm devlist
LUN Backend       Size (Blocks)   BS Serial Number    Device ID       
  0 block             488378646 4096 Z1X2WAX10000W451 MYDEVID0000     
  1 block             488378646 4096 Z1X2WB6J0000W451 MYDEVID0001     


вот это даст автомзпукск

 # echo 'ctld_enable="YES"' >> /etc/rc.conf


установка сервера закончена












УСТАНОВКА клиента iscsi

 # > /etc/iscsi.conf 
 # chmod 600 /etc/iscsi.conf 
 # cat /etc/iscsi.conf 

fr-4-target {
    initiatorname  = "iqn.1994-09.org.freebsd:fr-1:01:abcd1234567890fr-1";
    TargetName = "iqn.2005-10.org.freenas.ctl:fr-4";
    TargetAddress = "100.69.11.4:3260";
}

 

initiatorname  (как мы будем предтсавлтся удаленному iscsi серурверу)
TargetName  (iqn удаденного iscsi сервера куда будем подключаться)
TargetAddress (адрес удаенного сервера)


запустить руками сервис
    # service iscsid onestart



поключиться
    # iscsictl -An fr-4-target


проверить статус
    # iscsictl -An fr-4-target
    # iscsictl -L
Target name                          Target portal    State
iqn.2005-10.org.freenas.ctl:fr-5     100.69.11.5:3260 Connected: da14 da15 da16 
iqn.2005-10.org.freenas.ctl:fr-4     100.69.11.4:3260 Connected: da17 da18 



отключиться от iscsi сервера
    # iscsictl -R -a



в автомзпуск

echo 'iscsi_initiator_load="YES"' >> /boot/loader.conf



в rc.conf
  

netwait_enable="YES"
netwait_ip="100.69.11.4 100.69.11.5" # Укажите IP вашего iSCSI таргета (хранилища)
netwait_if="vlan11"
netwait_timeout="30"
iscsid_enable="YES"        # демон iSCSI
iscsictl_enable="YES"      # контроллер сессий  
iscsictl_flags="-Aa"









когда на iscsic сервере мы добавили новый лун то на клиенте его можно увидеть вот так 
сервер  # service ctld reload

на клиенте делаем рексан лунов

       # camcontrol rescan 1





на сервер создаем пул

[root@fr-1 ~]# camcontrol devlist
<FR-5 Z1X2WAX10000W451 0001>       at scbus1 target 0 lun 0 (da14,pass15)
<FR-5 Z1X2WB6J0000W451 0001>       at scbus1 target 0 lun 1 (da15,pass16)
<FR-5 Z1X2W8DM0000W451 0001>       at scbus1 target 0 lun 2 (da17,pass18)
<FR-4 Z1X2W8B50000W451 0001>       at scbus2 target 0 lun 0 (da16,pass17)
<FR-4 Z1X2X1SE0000W451 0001>       at scbus2 target 0 lun 1 (da18,pass19)


# gpart destroy -F da14
# gpart destroy -F da15
...
# gpart destroy -F da18



[root@fr-1 ~]# gpart add -b 2048 -t freebsd-zfs -i 1 da15
da15p1 added
[root@fr-1 ~]# gpart add -b 2048 -t freebsd-zfs -i 1 da16
da16p1 added
[root@fr-1 ~]# gpart add -b 2048 -t freebsd-zfs -i 1 da17
da17p1 added
[root@fr-1 ~]# gpart add -b 2048 -t freebsd-zfs -i 1 da18
da18p1 added
[root@fr-1 ~]# gpart add -b 2048 -t freebsd-zfs -i 1 da19
gpart: No such geom da19.
[root@fr-1 ~]# gpart add -b 2048 -t freebsd-zfs -i 1 da14
da14p1 added




[root@fr-1 ~]# gpart list da14 | grep uuid
   rawuuid: 931fee20-dd1e-11f0-97a7-a4dcbef12d36
[root@fr-1 ~]# gpart list da16 | grep uuid
   rawuuid: 886ebc3a-dd1e-11f0-97a7-a4dcbef12d36


[root@fr-1 ~]# gpart list da15 | grep uuid
   rawuuid: 86dffca7-dd1e-11f0-97a7-a4dcbef12d36
[root@fr-1 ~]# gpart list da18 | grep uuid
   rawuuid: 8b26b2e5-dd1e-11f0-97a7-a4dcbef12d36
[root@fr-1 ~]# 


[root@fr-1 ~]# zpool create -o ashift=12 POOL-01 mirror  /dev/gptid/931fee20-dd1e-11f0-97a7-a4dcbef12d36  /dev/gptid/886ebc3a-dd1e-11f0-97a7-a4dcbef12d36  mirror /dev/gptid/86dffca7-dd1e-11f0-97a7-a4dcbef12d36 /dev/gptid/8b26b2e5-dd1e-11f0-97a7-a4dcbef12d36


[root@fr-1 ~]# zpool list
NAME      SIZE  ALLOC   FREE  CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP    HEALTH  ALTROOT
POOL-01  3.62T   468K  3.62T        -         -     0%     0%  1.00x    ONLINE  -
zroot2    556G  1.30G   555G        -         -     0%     0%  1.00x    ONLINE  -
[root@fr-1 ~]# 
[root@fr-1 ~]# 
[root@fr-1 ~]# zpool status -v POOl-01
cannot open 'POOl-01': no such pool
[root@fr-1 ~]# zpool status -v POOL-01
  pool: POOL-01
 state: ONLINE
config:

    NAME                                            STATE     READ WRITE CKSUM
    POOL-01                                         ONLINE       0     0     0
      mirror-0                                      ONLINE       0     0     0
        gptid/931fee20-dd1e-11f0-97a7-a4dcbef12d36  ONLINE       0     0     0
        gptid/886ebc3a-dd1e-11f0-97a7-a4dcbef12d36  ONLINE       0     0     0
      mirror-1                                      ONLINE       0     0     0
        gptid/86dffca7-dd1e-11f0-97a7-a4dcbef12d36  ONLINE       0     0     0
        gptid/8b26b2e5-dd1e-11f0-97a7-a4dcbef12d36  ONLINE       0     0     0

errors: No known data errors
[root@fr-1 ~]# 


# pkg install screen


[root@fr-1 ~]# 
[root@fr-1 ~]# zfs create -V 500G  -o compression=off -o  primarycache=metadata  -o secondarycache=metadata -o volblocksize=128KiB  POOL-01/zvol-01-128K
[root@fr-1 ~]# 
[root@fr-1 ~]# # fio --randrepeat=1 --ioengine=psync --direct=1 --gtod_reduce=1 --name=test --filename=/dev/zvol/POOL-01/zvol-01-128K   --bs=$((1024 *1024)) --iodepth=1  --size=500G  --readwrite=write --numjobs=1  --group_reporting         


--

КАК ДОБАВЛЯТЬ ЛУНЫ
открываем /etc/ctl.conf

добавляем сецию



lun "da10" {
    ctl-lun "10"
    path "/dev/da10"
    device-id "FR-4 da10"
    option "vendor" "FR-4"
    option "product" "Z1X2W89T0000W4513R4W"
    blocksize "4096"
    serial "Z1X2W89T0000W4513R4W"
    option "naa" "0x5000c500591bda73"
    option "insecure_tpc" "on"
    option "rpm" "7200"
    option "readcache" "on" 

}


и обязательно добавляем также в эту сецию


target "iqn.2005-10.org.freenas.ctl:fr-4" {
    alias "fr-4"

   portal-group "pg1"          
   auth-group "ag4tg1_1"      

    lun "0" "da0"
    lun "1" "da1"
    lun "2" "da2"
    lun "3" "da3"
    lun "4" "da4"
    lun "5" "da5"
    lun "6" "da6"
    lun "7" "da7"
    lun "8" "da8"
    lun "9" "da9"
    lun "10" "da10"   **<<<
    lun "13" "da13"

}



далее перегружаем сервис
    # service ctld reload

дсалее можно посмтреть статус


[root@fr-4 /etc]# ctladm lunlist
(7:1:0/0): <FR-4 Z1X2W8B50000W451 0001> Fixed Direct Access SPC-5 SCSI device
(7:1:1/1): <FR-4 Z1X2X1SE0000W451 0001> Fixed Direct Access SPC-5 SCSI device
(7:1:2/2): <FR-4 Z1X2WB2000009445 0001> Fixed Direct Access SPC-5 SCSI device
(7:1:3/3): <FR-4 Z1X2W8VZ0000W451 0001> Fixed Direct Access SPC-5 SCSI device
(7:1:4/4): <FR-4 Z1X2WAXN0000W451 0001> Fixed Direct Access SPC-5 SCSI device
(7:1:5/5): <FR-4 Z1X2W8Y50000W451 0001> Fixed Direct Access SPC-5 SCSI device
(7:1:6/6): <FR-4 Z1X2WB3D0000W451 0001> Fixed Direct Access SPC-5 SCSI device
(7:1:7/7): <FR-4 Z1X2W8VB0000W451 0001> Fixed Direct Access SPC-5 SCSI device
(7:1:8/8): <FR-4 Z1X2WB9Q0000W448 0001> Fixed Direct Access SPC-5 SCSI device
(7:1:9/9): <FR-4 Z1X2WB3500009445 0001> Fixed Direct Access SPC-5 SCSI device
(7:1:10/10): <FR-4 Z1X2W89T0000W451 0001> Fixed Direct Access SPC-5 SCSI device   **<<<
(7:1:13/13): <FR-4 Z1X4SMSL0000R535 0001> Fixed Direct Access SPC-5 SCSI device
[root@fr-4 /etc]# 
[root@fr-4 /etc]# ctladm devlist
LUN Backend       Size (Blocks)   BS Serial Number    Device ID       
  0 block             488378646 4096 Z1X2W8B50000W451 FR-4 da0        
  1 block             488378646 4096 Z1X2X1SE0000W451 FR-4 da1        
  2 block             488378646 4096 Z1X2WB2000009445 FR-4 da2        
  3 block             488378646 4096 Z1X2W8VZ0000W451 FR-4 da3        
  4 block             488378646 4096 Z1X2WAXN0000W451 FR-4 da4        
  5 block             488378646 4096 Z1X2W8Y50000W451 FR-4 da5        
  6 block             488378646 4096 Z1X2WB3D0000W451 FR-4 da6        
  7 block             488378646 4096 Z1X2W8VB0000W451 FR-4 da7        
  8 block             488378646 4096 Z1X2WB9Q0000W448 FR-4 da8        
  9 block             488378646 4096 Z1X2WB3500009445 FR-4 da9        
 10 block             488378646 4096 Z1X2W89T0000W451 FR-4 da10       **<<<
 13 block             488378646 4096 Z1X4SMSL0000R535 FR-4 da13       


только проблема в том что эта хуйня покзыает непонятно что.

скажем я забыл добавить диск в эту сецию

target "iqn.2005-10.org.freenas.ctl:fr-4" {
    alias "fr-4"

   portal-group "pg1"          
   auth-group "ag4tg1_1"      

    lun "0" "da0"
    lun "1" "da1"
    lun "2" "da2"
    lun "3" "da3"
    lun "4" "da4"
    lun "5" "da5"
    lun "6" "da6"
    lun "7" "da7"
    lun "8" "da8"
    lun "9" "da9"
    lun "10" "da10"   **<<<
    lun "13" "da13"

}


а вышеобзозанынеые команлы все равно показывали что лун10 типа расшаен. он только создан но нихуя не расшеарен 
по сети!


потом идет на клиента
узнаем номерсс iscsi сессиии

[root@fr-1 /etc]# camcontrol devlist
<FR-5 Z1X2WAX10000W451 0001>       at scbus1 target 0 lun 0 (da14,pass15)
<FR-5 Z1X2WB6J0000W451 0001>       at scbus1 target 0 lun 1 (da15,pass16)
<FR-5 Z1X2W8DM0000W451 0001>       at scbus1 target 0 lun 2 (da17,pass18)
<FR-4 Z1X2W8B50000W451 0001>       at scbus2 target 0 lun 0 (da16,pass17)
<FR-4 Z1X2X1SE0000W451 0001>       at scbus2 target 0 lun 1 (da18,pass19)
<FR-4 Z1X2WB2000009445 0001>       at scbus2 target 0 lun 2 (da19,pass20)
<FR-4 Z1X2W8VZ0000W451 0001>       at scbus2 target 0 lun 3 (da20,pass21)
<FR-4 Z1X2WAXN0000W451 0001>       at scbus2 target 0 lun 4 (da21,pass22)
<FR-4 Z1X2W8Y50000W451 0001>       at scbus2 target 0 lun 5 (da22,pass23)
<FR-4 Z1X2WB3D0000W451 0001>       at scbus2 target 0 lun 6 (da23,pass24)
<FR-4 Z1X2W8VB0000W451 0001>       at scbus2 target 0 lun 7 (da24,pass25)
<FR-4 Z1X2WB9Q0000W448 0001>       at scbus2 target 0 lun 8 (da25,pass26)
<FR-4 Z1X2WB3500009445 0001>       at scbus2 target 0 lun 9 (da26,pass27)
<FR-4 Z1X2W89T0000W451 0001>       at scbus2 target 0 lun a (da27,pass28)
<FR-4 Z1X4SMSL0000R535 0001>       at scbus2 target 0 lun d (da28,pass29)



я добавил луны на fr-4 поэтому сессия имеет номер  scbus2  тоесть 2
тогда 

# camcontrol rescan 2
Re-scan of bus 2 was successful

и после этого мы на клиенте должны увидеть новые добавленные луны!

------

когда я добавил новые луны на клиента.
нужно их добавить в zpool
для этого для начала нужно поеределить какие диски уже добавлены в пул.
делаю это вот так

[root@fr-1 /etc]# zpool status -v
  pool: POOL-01
 state: ONLINE
config:

        NAME                                            STATE     READ WRITE CKSUM
        POOL-01                                         ONLINE       0     0     0
          mirror-0                                      ONLINE       0     0     0
            gptid/931fee20-dd1e-11f0-97a7-a4dcbef12d36  ONLINE       0     0     0
            gptid/886ebc3a-dd1e-11f0-97a7-a4dcbef12d36  ONLINE       0     0     0
          mirror-1                                      ONLINE       0     0     0
            gptid/86dffca7-dd1e-11f0-97a7-a4dcbef12d36  ONLINE       0     0     0
            gptid/8b26b2e5-dd1e-11f0-97a7-a4dcbef12d36  ONLINE       0     0     0

errors: No known data errors




[root@fr-1 /etc]# gpart list | grep -i 931fee20 -B 10
first: 6
entries: 128
scheme: GPT
Providers:
1. Name: da14p1
   Mediasize: 2000390524928 (1.8T)
   Sectorsize: 4096
   Stripesize: 0
   Stripeoffset: 8388608
   Mode: r1w1e2
   efimedia: HD(1,GPT,931fee20-dd1e-11f0-97a7-a4dcbef12d36,0x800,0x1d1c0911)
   rawuuid: 931fee20-dd1e-11f0-97a7-a4dcbef12d36
[root@fr-1 /etc]# gpart list | grep -i 931fee20 -B 8
scheme: GPT
Providers:
1. Name: da14p1
   Mediasize: 2000390524928 (1.8T)
   Sectorsize: 4096
   Stripesize: 0
   Stripeoffset: 8388608
   Mode: r1w1e2
   efimedia: HD(1,GPT,931fee20-dd1e-11f0-97a7-a4dcbef12d36,0x800,0x1d1c0911)
   rawuuid: 931fee20-dd1e-11f0-97a7-a4dcbef12d36
[root@fr-1 /etc]# 
[root@fr-1 /etc]# 
[root@fr-1 /etc]# gpart list | grep -i 886ebc3a  -B 8
scheme: GPT
Providers:
1. Name: da16p1
   Mediasize: 2000390524928 (1.8T)
   Sectorsize: 4096
   Stripesize: 0
   Stripeoffset: 8388608
   Mode: r1w1e2
   efimedia: HD(1,GPT,886ebc3a-dd1e-11f0-97a7-a4dcbef12d36,0x800,0x1d1c0911)
   rawuuid: 886ebc3a-dd1e-11f0-97a7-a4dcbef12d36
[root@fr-1 /etc]# gpart list | grep -i 86dffca7  -B 8
scheme: GPT
Providers:
1. Name: da15p1
   Mediasize: 2000390524928 (1.8T)
   Sectorsize: 4096
   Stripesize: 0
   Stripeoffset: 8388608
   Mode: r1w1e2
   efimedia: HD(1,GPT,86dffca7-dd1e-11f0-97a7-a4dcbef12d36,0x800,0x1d1c0911)
   rawuuid: 86dffca7-dd1e-11f0-97a7-a4dcbef12d36
[root@fr-1 /etc]# gpart list | grep -i 8b26b2e5  -B 8
scheme: GPT
Providers:
1. Name: da18p1
   Mediasize: 2000390524928 (1.8T)
   Sectorsize: 4096
   Stripesize: 0
   Stripeoffset: 8388608
   Mode: r1w1e2
   efimedia: HD(1,GPT,8b26b2e5-dd1e-11f0-97a7-a4dcbef12d36,0x800,0x1d1c0911)
   rawuuid: 8b26b2e5-dd1e-11f0-97a7-a4dcbef12d36





получается da14 da16 da15 da18 уже состоят в пуле


[root@fr-1 /etc]# camcontrol devlist | grep FR
<FR-5 Z1X2WAX10000W451 0001>       at scbus1 target 0 lun 0 (da14,pass15)  **
<FR-5 Z1X2WB6J0000W451 0001>       at scbus1 target 0 lun 1 (da15,pass16)  **
<FR-5 Z1X2W8DM0000W451 0001>       at scbus1 target 0 lun 2 (da17,pass18)
<FR-5 Z1X2W8E20000W451 0001>       at scbus1 target 0 lun 3 (da29,pass30)
<FR-5 Z1X2RSTA00009438 0001>       at scbus1 target 0 lun 4 (da30,pass31)
<FR-5 Z1X2W8FD0000W451 0001>       at scbus1 target 0 lun 5 (da31,pass32)
<FR-5 Z1X2W94N0000W451 0001>       at scbus1 target 0 lun 6 (da32,pass33)
<FR-5 Z1X2W8YY0000W451 0001>       at scbus1 target 0 lun 7 (da33,pass34)
<FR-5 Z1X2W8A00000W451 0001>       at scbus1 target 0 lun 8 (da34,pass35)
<FR-5 Z1X2W84M0000W451 0001>       at scbus1 target 0 lun 9 (da35,pass36)
<FR-5 Z1X2W8GN0000W451 0001>       at scbus1 target 0 lun a (da36,pass37)
<FR-5 Z1X2WB3L00009445 0001>       at scbus1 target 0 lun d (da37,pass38)

<FR-4 Z1X2W8B50000W451 0001>       at scbus2 target 0 lun 0 (da16,pass17) **
<FR-4 Z1X2X1SE0000W451 0001>       at scbus2 target 0 lun 1 (da18,pass19) **
<FR-4 Z1X2WB2000009445 0001>       at scbus2 target 0 lun 2 (da19,pass20)
<FR-4 Z1X2W8VZ0000W451 0001>       at scbus2 target 0 lun 3 (da20,pass21)
<FR-4 Z1X2WAXN0000W451 0001>       at scbus2 target 0 lun 4 (da21,pass22)
<FR-4 Z1X2W8Y50000W451 0001>       at scbus2 target 0 lun 5 (da22,pass23)
<FR-4 Z1X2WB3D0000W451 0001>       at scbus2 target 0 lun 6 (da23,pass24)
<FR-4 Z1X2W8VB0000W451 0001>       at scbus2 target 0 lun 7 (da24,pass25)
<FR-4 Z1X2WB9Q0000W448 0001>       at scbus2 target 0 lun 8 (da25,pass26)
<FR-4 Z1X2WB3500009445 0001>       at scbus2 target 0 lun 9 (da26,pass27)
<FR-4 Z1X2W89T0000W451 0001>       at scbus2 target 0 lun a (da27,pass28)
<FR-4 Z1X4SMSL0000R535 0001>       at scbus2 target 0 lun d (da28,pass29)


добавляем диски в мирроры по тому принципу чтобы один диск лежал на одном iscsi сервере 
а второй диск в мирроре обазятельно на другом. таким образом исчзеновнеие связи с одной из полок
недолжно убить пул. просто в каждом мирроре станет нерабочим один диск

для начала нужно на новых дисках стереть GPT лейбел

for i in  17 29 30 31 32 33 34 35 36 37 19 20 21 22 23 24 25 26 27 28; do gpart destroy -F /dev/da$i; done
da17 destroyed
gpart: arg0 'da29': Invalid argument
gpart: arg0 'da30': Invalid argument
gpart: arg0 'da31': Invalid argument
gpart: arg0 'da32': Invalid argument
gpart: arg0 'da33': Invalid argument
gpart: arg0 'da34': Invalid argument


если пишет invalid argument то этовсего навсего значит что данный диск неимел gpt лейбла толко и всего.
тоесть это окей
создаем новый лебел GPT

for i in  17 29 30 31 32 33 34 35 36 37 19 20 21 22 23 24 25 26 27 28; do gpart create -s gpt /dev/da$i; done
da17 created
da29 created
da30 created
da31 created


создаем на диске раздел под зфс

for i in  17 29 30 31 32 33 34 35 36 37 19 20 21 22 23 24 25 26 27 28; do  gpart add -b 2048 -t freebsd-zfs -i 1 da$i; done
da17p1 added
da29p1 added
da30p1 added
da31p1 added
da32p1 added
da33p1 added


теперь добавляем мирроры в zpool помня что каждый диск должен лежат на разных серверах
дболавляем на основе gptid



[root@fr-1 /etc]# camcontrol devlist | grep FR
<FR-5 Z1X2WAX10000W451 0001>       at scbus1 target 0 lun 0 (da14,pass15)  **
<FR-5 Z1X2WB6J0000W451 0001>       at scbus1 target 0 lun 1 (da15,pass16)  **
<FR-5 Z1X2W8DM0000W451 0001>       at scbus1 target 0 lun 2 (da17,pass18)
<FR-5 Z1X2W8E20000W451 0001>       at scbus1 target 0 lun 3 (da29,pass30)
<FR-5 Z1X2RSTA00009438 0001>       at scbus1 target 0 lun 4 (da30,pass31)
<FR-5 Z1X2W8FD0000W451 0001>       at scbus1 target 0 lun 5 (da31,pass32)
<FR-5 Z1X2W94N0000W451 0001>       at scbus1 target 0 lun 6 (da32,pass33)
<FR-5 Z1X2W8YY0000W451 0001>       at scbus1 target 0 lun 7 (da33,pass34)
<FR-5 Z1X2W8A00000W451 0001>       at scbus1 target 0 lun 8 (da34,pass35)
<FR-5 Z1X2W84M0000W451 0001>       at scbus1 target 0 lun 9 (da35,pass36)
<FR-5 Z1X2W8GN0000W451 0001>       at scbus1 target 0 lun a (da36,pass37)
<FR-5 Z1X2WB3L00009445 0001>       at scbus1 target 0 lun d (da37,pass38)

<FR-4 Z1X2W8B50000W451 0001>       at scbus2 target 0 lun 0 (da16,pass17) **
<FR-4 Z1X2X1SE0000W451 0001>       at scbus2 target 0 lun 1 (da18,pass19) **
<FR-4 Z1X2WB2000009445 0001>       at scbus2 target 0 lun 2 (da19,pass20)
<FR-4 Z1X2W8VZ0000W451 0001>       at scbus2 target 0 lun 3 (da20,pass21)
<FR-4 Z1X2WAXN0000W451 0001>       at scbus2 target 0 lun 4 (da21,pass22)
<FR-4 Z1X2W8Y50000W451 0001>       at scbus2 target 0 lun 5 (da22,pass23)
<FR-4 Z1X2WB3D0000W451 0001>       at scbus2 target 0 lun 6 (da23,pass24)
<FR-4 Z1X2W8VB0000W451 0001>       at scbus2 target 0 lun 7 (da24,pass25)
<FR-4 Z1X2WB9Q0000W448 0001>       at scbus2 target 0 lun 8 (da25,pass26)
<FR-4 Z1X2WB3500009445 0001>       at scbus2 target 0 lun 9 (da26,pass27)
<FR-4 Z1X2W89T0000W451 0001>       at scbus2 target 0 lun a (da27,pass28)
<FR-4 Z1X4SMSL0000R535 0001>       at scbus2 target 0 lun d (da28,pass29)

значит вот они новые мирроры

da17 
da19 

 
da29 
da20 


da30 
da21 



da31  
da22  




da32
da23


da33
da24


da34
da25


da35
da26


da36
da27


da37
da28



===
выясяем gptid для этих дисков

# echo $( gpart list da31 | grep uuid | awk '{print $2}' )
5488d46c-dd96-11f0-97a7-a4dcbef12d36


    # for pair in "da17,da19" "da29,da20" "da30,da21"  "da31,da22"  "da32,da23" "da33,da24"  "da34,da25"  "da35,da26"  "da36,da27" "da37,da28"; do    disk1=${pair%,*} ;   disk2=${pair#*,} ;  gptid1=$( gpart list $disk1 | grep uuid | awk '{print $2}' ) ; gptid2=$( gpart list $disk2 | grep uuid | awk '{print $2}' );  echo "mirror  $disk1 $gptid1 $disk2 $gptid2" ; done
mirror  da17 5456d33b-dd96-11f0-97a7-a4dcbef12d36 da19 54fc0a17-dd96-11f0-97a7-a4dcbef12d36
mirror  da29 5467b4c1-dd96-11f0-97a7-a4dcbef12d36 da20 550dc32b-dd96-11f0-97a7-a4dcbef12d36
mirror  da30 5478c15d-dd96-11f0-97a7-a4dcbef12d36 da21 551faee9-dd96-11f0-97a7-a4dcbef12d36
mirror  da31 5488d46c-dd96-11f0-97a7-a4dcbef12d36 da22 552fa020-dd96-11f0-97a7-a4dcbef12d36
mirror  da32 5499b935-dd96-11f0-97a7-a4dcbef12d36 da23 554212c1-dd96-11f0-97a7-a4dcbef12d36
mirror  da33 54a99693-dd96-11f0-97a7-a4dcbef12d36 da24 555387a6-dd96-11f0-97a7-a4dcbef12d36
mirror  da34 54baf50d-dd96-11f0-97a7-a4dcbef12d36 da25 5564dc8a-dd96-11f0-97a7-a4dcbef12d36
mirror  da35 54cc74d6-dd96-11f0-97a7-a4dcbef12d36 da26 55755599-dd96-11f0-97a7-a4dcbef12d36
mirror  da36 54dbc3be-dd96-11f0-97a7-a4dcbef12d36 da27 5585e63a-dd96-11f0-97a7-a4dcbef12d36
mirror  da37 54ebe09e-dd96-11f0-97a7-a4dcbef12d36 da28 55967289-dd96-11f0-97a7-a4dcbef12d36

                        

добавляем новые мирроры в пул

[root@fr-1 ~]# export POOL_NAME="POOL-01"; echo -e "\nPOOL_NAME=$POOL_NAME"; for pair in "da17,da19" "da29,da20" "da30,da21"  "da31,da22"  "da32,da23" "da33,da24"  "da34,da25"  "da35,da26"  "da36,da27" "da37,da28"; do    disk1=${pair%,*} ;   disk2=${pair#*,} ;  gptid1=$( gpart list $disk1 | grep uuid | awk '{print $2}' ) ; gptid2=$( gpart list $disk2 | grep uuid | awk '{print $2}' );  echo "mirror  $disk1 $gptid1 $disk2 $gptid2" ; zpool add $POOL_NAME mirror  /dev/gptid/$gptid1  /dev/gptid/$gptid2  ;  done

POOL_NAME=POOL-01
mirror  da17 5456d33b-dd96-11f0-97a7-a4dcbef12d36 da19 54fc0a17-dd96-11f0-97a7-a4dcbef12d36
mirror  da29 5467b4c1-dd96-11f0-97a7-a4dcbef12d36 da20 550dc32b-dd96-11f0-97a7-a4dcbef12d36
mirror  da30 5478c15d-dd96-11f0-97a7-a4dcbef12d36 da21 551faee9-dd96-11f0-97a7-a4dcbef12d36
mirror  da31 5488d46c-dd96-11f0-97a7-a4dcbef12d36 da22 552fa020-dd96-11f0-97a7-a4dcbef12d36
mirror  da32 5499b935-dd96-11f0-97a7-a4dcbef12d36 da23 554212c1-dd96-11f0-97a7-a4dcbef12d36
mirror  da33 54a99693-dd96-11f0-97a7-a4dcbef12d36 da24 555387a6-dd96-11f0-97a7-a4dcbef12d36
mirror  da34 54baf50d-dd96-11f0-97a7-a4dcbef12d36 da25 5564dc8a-dd96-11f0-97a7-a4dcbef12d36
mirror  da35 54cc74d6-dd96-11f0-97a7-a4dcbef12d36 da26 55755599-dd96-11f0-97a7-a4dcbef12d36
mirror  da36 54dbc3be-dd96-11f0-97a7-a4dcbef12d36 da27 5585e63a-dd96-11f0-97a7-a4dcbef12d36
mirror  da37 54ebe09e-dd96-11f0-97a7-a4dcbef12d36 da28 55967289-dd96-11f0-97a7-a4dcbef12d36



а вот как добавит диски в SLOG
#  for pair in "da0,da1" "da2,da3" "da4,da5"  "da6,da7" ; do    disk1=${pair%,*} ;   disk2=${pair#*,} ;  gptid1=$( gpart list $disk1 | grep uuid | awk '{print $2}' ) ; gptid2=$( gpart list $disk2 | 
grep uuid | awk '{print $2}' );  echo "mirror  $disk1 $gptid1 $disk2 $gptid2" ;    zpool add POOL-01 log  mirror  /dev/gptid/$gptid1  /dev/gptid/$gptid2  ;    done




====


multipath

на серерверер



[root@fr-4 ~]# cat /etc/ctl.conf 
portal-group "default" {
}

# ПОРТАЛ 1 (ix0 10G)
portal-group "pg1" {
    tag "0x0001"
    discovery-filter "portal-name"
    discovery-auth-group "no-authentication"
    listen "100.69.11.4:3260"      
    option "ha_shared" "on"
}

# ПОРТАЛ 2 (ix1 10G) ← НОВЫЙ!
portal-group "pg2" {
    tag "0x0002"                   # РАЗНЫЙ TAG!
    discovery-filter "portal-name"
    discovery-auth-group "no-authentication"
    listen "100.69.12.4:3260"     
    option "ha_shared" "on"
}






lun "da0" {
    ctl-lun "0"
    path "/dev/da0"
    blocksize "4096"
    device-id "FR-4 da0"
    option "vendor" "FR-4"  
    option "product" "Z1X2W8B50000W4513NXK"
    serial "Z1X2W8B50000W4513NXK"
    option "naa" "0x5000c500591bd82b"
    option "insecure_tpc" "on"
    option "rpm" "7200"
    option "writecache" "off" 
    option "readcache" "on" 

}



lun "da1" {
    ctl-lun "1"
    path "/dev/da1"
    device-id "FR-4 da1"
    option "vendor" "FR-4"
    option "product" "Z1X2X1SE0000W4513KNK"
    blocksize "4096"
    serial "Z1X2X1SE0000W4513KNK"
    option "naa" "0x5000c500591c04fb"
    option "insecure_tpc" "on"
    option "rpm" "7200"
    option "readcache" "on" 

}






lun "da2" {
    ctl-lun "2"
    path "/dev/da2"
    device-id "FR-4 da2"
    option "vendor" "FR-4"
    option "product" "Z1X2WB2000009445CDJ1"
    blocksize "4096"
    serial "Z1X2WB2000009445CDJ1"
    option "naa" "0x5000c500591b6b33"
    option "insecure_tpc" "on"
    option "rpm" "7200"
    option "readcache" "on" 

}









lun "da3" {
    ctl-lun "3"
    path "/dev/da3"
    device-id "FR-4 da3"
    option "vendor" "FR-4"
    option "product" "Z1X2W8VZ0000W45140TG"
    blocksize "4096"
    serial "Z1X2W8VZ0000W45140TG"
    option "naa" "0x5000c500591bbd9b"
    option "insecure_tpc" "on"
    option "rpm" "7200"
    option "readcache" "on" 

}







lun "da4" {
    ctl-lun "4"
    path "/dev/da4"
    device-id "FR-4 da4"
    option "vendor" "FR-4"
    option "product" "Z1X2WAXN0000W4513NAA"
    blocksize "4096"
    serial "Z1X2WAXN0000W4513NAA"
    option "naa" "0x5000c500591b755b"
    option "insecure_tpc" "on"
    option "rpm" "7200"
    option "readcache" "on" 

}






lun "da5" {
    ctl-lun "5"
    path "/dev/da5"
    device-id "FR-4 da5"
    option "vendor" "FR-4"
    option "product" "Z1X2W8Y50000W451410Q"
    blocksize "4096"
    serial "Z1X2W8Y50000W451410Q"
    option "naa" "0x5000c500591bba03"
    option "insecure_tpc" "on"
    option "rpm" "7200"
    option "readcache" "on" 

}






lun "da6" {
    ctl-lun "6"
    path "/dev/da6"
    device-id "FR-4 da6"
    option "vendor" "FR-4"
    option "product" "Z1X2WB3D0000W4513QV5"
    blocksize "4096"
    serial "Z1X2WB3D0000W4513QV5"
    option "naa" "0x5000c500591b679f"
    option "insecure_tpc" "on"
    option "rpm" "7200"
    option "readcache" "on" 

}



lun "da7" {
    ctl-lun "7"
    path "/dev/da7"
    device-id "FR-4 da7"
    option "vendor" "FR-4"
    option "product" "Z1X2W8VB0000W45141LM"
    blocksize "4096"
    serial "Z1X2W8VB0000W45141LM"
    option "naa" "0x5000c500591bbdef"
    option "insecure_tpc" "on"
    option "rpm" "7200"
    option "readcache" "on" 

}





lun "da8" {
    ctl-lun "8"
    path "/dev/da8"
    device-id "FR-4 da8"
    option "vendor" "FR-4"
    option "product" "Z1X2WB9Q0000W448X9P9"
    blocksize "4096"
    serial "Z1X2WB9Q0000W448X9P9"
    option "naa" "0x5000c500591b5cdf"
    option "insecure_tpc" "on"
    option "rpm" "7200"
    option "readcache" "on" 

}




lun "da9" {
    ctl-lun "9"
    path "/dev/da9"
    device-id "FR-4 da9"
    option "vendor" "FR-4"
    option "product" "Z1X2WB3500009445CRWQ"
    blocksize "4096"
    serial "Z1X2WB3500009445CRWQ"
    option "naa" "0x5000c500591b668f"
    option "insecure_tpc" "on"
    option "rpm" "7200"
    option "readcache" "on" 

}



lun "da10" {
    ctl-lun "10"
    path "/dev/da10"
    device-id "FR-4 da10"
    option "vendor" "FR-4"
    option "product" "Z1X2W89T0000W4513R4W"
    blocksize "4096"
    serial "Z1X2W89T0000W4513R4W"
    option "naa" "0x5000c500591bda73"
    option "insecure_tpc" "on"
    option "rpm" "7200"
    option "readcache" "on" 

}


lun "da13" {
    ctl-lun "13"
    path "/dev/da13"
    device-id "FR-4 da13"
    option "vendor" "FR-4"
    option "product" "Z1X4SMSL0000R535Y8QK"
    blocksize "4096"
    serial "Z1X4SMSL0000R535Y8QK"
    option "naa" "0x5000c5008391cf5b"
    option "insecure_tpc" "on"
    option "rpm" "7200"
    option "readcache" "on" 

}











auth-group "ag4tg1_1" {
    initiator-name "iqn.1994-09.org.freebsd:fr-1:01:abcd1234567890fr-1"
    auth-type "none"
}

# TARGET С ОБОИМИ ПОРТАЛАМИ!
target "iqn.2005-10.org.freenas.ctl:fr-4" {
    alias "fr-4"
    auth-group "ag4tg1_1"      

    # ОБОИ ПОРТАЛА!
    portal-group "pg1"           # IP1 100.69.11.4
    portal-group "pg2"           # IP2 100.69.12.4

    lun "0" "da0"
    lun "1" "da1"
    lun "2" "da2"
    lun "3" "da3"
    lun "4" "da4"
    lun "5" "da5"
    lun "6" "da6"
    lun "7" "da7"
    lun "8" "da8"
    lun "9" "da9"
    lun "10" "da10"
    lun "13" "da13"
}


[root@fr-4 ~]# 
[fr-4][                                                                       0 bash  1 bash  2 bash  3- bash  (4* bash)                                                                        ][12/20/25 18:01]






на клиенте
поключкние


[root@fr-1 ~/zfs/scripts]# cat /etc/iscsi.conf 

fr-4-target-vlan11 {
    initiatorname  = "iqn.1994-09.org.freebsd:fr-1:01:abcd1234567890fr-1";
    TargetName = "iqn.2005-10.org.freenas.ctl:fr-4";
    TargetAddress = "100.69.11.4:3260";
}




fr-4-target-vlan12 {
    initiatorname  = "iqn.1994-09.org.freebsd:fr-1:01:abcd1234567890fr-1";
    TargetName = "iqn.2005-10.org.freenas.ctl:fr-4";
    TargetAddress = "100.69.12.4:3260";
}





fr-5-target-vlan11 {
    initiatorname  = "iqn.1994-09.org.freebsd:fr-1:01:abcd1234567890fr-1";
    TargetName = "iqn.2005-10.org.freenas.ctl:fr-5";
    TargetAddress = "100.69.11.5:3260";
}


fr-5-target-vlan12 {
    initiatorname  = "iqn.1994-09.org.freebsd:fr-1:01:abcd1234567890fr-1";
    TargetName = "iqn.2005-10.org.freenas.ctl:fr-5";
    TargetAddress = "100.69.12.5:3260";
}





создание мулььтпаф усрйств




[root@fr-1 ~/zfs/scripts]# cat multipath.bash 
#!/usr/local/bin/bash

ISCSI_HOSTNAME="fr-5"
echo ISCSI_HOSTNAME=$ISCSI_HOSTNAME



camcontrol devlist | grep -i $ISCSI_HOSTNAME | awk '{print $2}' | sort | uniq | while read S_N_FULL; do
    echo ""
    echo ">>"
    echo S_N_FULL=$S_N_FULL

    S_N=${S_N_FULL:0:10}
    echo S_N=$S_N

    MULTIPATH_NAME=$ISCSI_HOSTNAME-$S_N
    echo MULTIPATH_NAME=$MULTIPATH_NAME

    camcontrol devlist  | grep -i $ISCSI_HOSTNAME | grep S_N_FULL

    DISK1=$(camcontrol devlist  | grep -i $ISCSI_HOSTNAME | grep $S_N | head -n1 | awk -F "," '{print $1}' |  grep -o 'da[0-9]\+')
    DISK2=$(camcontrol devlist  | grep -i $ISCSI_HOSTNAME | grep $S_N | tail -n1 | awk -F "," '{print $1}' |  grep -o 'da[0-9]\+')
    echo DISK1=$DISK1
    echo DISK2=$DISK2


    gmultipath status $MULTIPATH_NAME

    if [ $? -eq 0 ]; then 
        echo "multipath disk ALREADY EXISTS!";
        #gmultipath configure -A  $MULTIPATH_NAME 
    else
        echo "Добавляю диск в мультипаф"
        gmultipath label $MULTIPATH_NAME   $DISK1 $DISK2
        gmultipath configure -A  $MULTIPATH_NAME 
        gmultipath status $MULTIPATH_NAME

    fi



done



====
настройка чтобы при отвале дисков зфс не вставал коолом


zpool set failmode=continue POOL-01


то это даст: Если диски отвалились, ZFS не будет «вешать» всю систему. Она выдаст ошибку конкретной операции, увидит, что зеркало повреждено (DEGRADED), но продолжит работать на оставшемся диске.




Также проверь параметры sysctl для iSCSI, чтобы система быстрее отдавала ошибку уровню GEOM:
bash


# Разрешаем немедленно отдавать ошибку при дисконнекте
sysctl kern.iscsi.fail_on_disconnection=1

# Уменьшаем время ожидания демона (60 сек - это слишком долго для зеркала)
sysctl kern.iscsi.iscsid_timeout=10


/etc/sysctl.conf
kern.iscsi.fail_on_disconnection=1
kern.iscsi.iscsid_timeout=10


Когда полка fr-5 загрузилась и iscsictl -L показывает, что сессии восстановились, выполните:
bash
Иногда iSCSI-диски возвращаются, но gmultipath или gpart «не замечают» их появления сразу. Чтобы помочь системе, можно добавить правило в devd (но это сложно) или использовать простую команду для сканирования:
bash

# Если после clear диски не ожили:
gmultipath taste
zpool clear POOL-01


Чтобы ZFS сама подхватывала диски, как только они появляются в системе, нужно включить свойство autoreplace. Хотя оно создано для замены дисков, во FreeBSD оно помогает и при «мигании» внешних хранилищ.
Выполните на хосте:
bash

zpool set autoreplace=on POOL-01


Добавь это в /etc/rc.conf:
bash

zfsd_enable="YES"

Используйте код с осторожностью.
Почему это важно:

    Автоматизация: Без zfsd тебе придется каждый раз после сбоя вручную писать zpool online или zpool clear.
    Интеллект: zfsd слушает системные события (через devd). Как только он видит, что в /dev/gpt/ появилось устройство, которое ранее «отвалилось» от пула, он сам посылает команду ядру на его подключение.





если часть дисков осталась removed
то
2. Пните ZFS для конкретных устройств
Если zpool clear не помог всему пулу, попробуйте сделать online конкретно для «ленивых» дисков:
bash

zpool online POOL-01 gpt/fr-5-Z1X2W84M00
zpool online POOL-01 gpt/fr-5-Z1X2W8A000
zpool online POOL-01 gpt/fr-5-Z1X2W8DM00

а вот это так и непорообвал не приголидос пока
Иногда ссылки в /dev/gpt/ не обновляются автоматически. Выполните команду, которая заставит систему пересканировать метки на «пропавших» дисках:
bash

true > /dev/da17  # замените на da-имена тех дисков, которые сидят в REMOVED
gmultipath taste





sas2ircu скопррвать на все среверры

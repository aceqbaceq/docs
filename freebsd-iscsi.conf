| freebsd
| iscsi 


гоготовим хост iscsi сервера

freebsd-lagg.txt




ставим smartd

## **1. Установка пакета:**
pkg install smartmontools

## **2. Автозапуск в /etc/rc.conf:**
sysrc smartd_enable="YES"

## **3. Настройка /usr/local/etc/smartd.conf:**
cp /usr/local/etc/smartd.conf.sample /usr/local/etc/smartd.conf
vi /usr/local/etc/smartd.conf

**Пример конфига для всех дисков:**
/dev/da* -d disk -a -o on -S on -s (S/../.././02|L/../../6/02)
/dev/ada* -d disk -a -o on -S on -s (S/../.././02|L/../../6/02)

## **4. Логирование в /etc/syslog.conf:**
local3.*    /var/log/smartd.log

## **5. Создай лог файл:**
touch /var/log/smartd.log
chmod 644 /var/log/smartd.log
killall -1 syslogd  # перезапуск syslogd

## **6. Запуск сервиса:**
service smartd start
service smartd status

## **7. Проверка:**
smartctl -a /dev/da0     # SMART одного диска
smartctl --scan          # все диски
tail -f /var/log/smartd.log  # логи









echo 'ctld_enable="YES"' >> /etc/rc.conf



# smartctl -x /dev/da0 | grep "Logical Unit"
Logical Unit id:      0x5000c500591bd3e7




# smartctl -x /dev/da0 | grep "Serial"
Serial number:        Z1X2W8DM0000W4513NCS


# camcontrol devlist
# for i in 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16; do smartctl --set=wcache,on /dev/da$i; done


# >/etc/ctl.conf
# chmod 600 /etc/ctl.conf

# cat /etc/ctl.conf 
portal-group "default" {
}

portal-group "pg1" {
    tag "0x0001"
    discovery-filter "portal-name"
    discovery-auth-group "no-authentication"
    listen "100.69.11.5:3260"
    option "ha_shared" "on"
}

lun "da0" {
    ctl-lun "0"
    path "/dev/da0"
    blocksize "4096"
    device-id "FR-5 da0"
    option "vendor" "FR-5"
    option "product" "Z1X2WAX10000W4513PTR"    
    serial "Z1X2WAX10000W4513PTR"
    option "naa" "0x5000c500591b779b"
    option "insecure_tpc" "on"
    option "rpm" "7200"
    option "writecache" "off" 
    option "readcache" "on" 

}



lun "da1" {
    ctl-lun "1"
    path "/dev/da1"
    device-id "FR-5 da1"
    option "vendor" "FR-5"
    option "product" "Z1X2WB6J0000W45140VV"
    blocksize "4096"
    serial "Z1X2WB6J0000W45140VV"
    option "naa" "0x5000c500591b608f"
    option "insecure_tpc" "on"
    option "rpm" "7200"
    option "readcache" "on" 

}






auth-group "ag4tg1_1" {
    initiator-name "iqn.1994-09.org.freebsd:fr-1:01:abcd1234567890fr-1"
    auth-type "none"
}

target "iqn.2005-10.org.freenas.ctl:fr-5" {
    alias "fr-5"
    #portal-group "pg1" "ag4tg1_1"

   portal-group "pg1"          
   auth-group "ag4tg1_1"      

    lun "0" "da0"
    lun "1" "da1"
}





вот эти два поля
    option "vendor" "FR-5"
    option "product" "Z1X2WAX10000W4513PTR"    

они дают то что на клиенте в camcontrol devlist
будет видно вот это. тоесть легко будет понять с какго хоста и какой диск сидит на луне
на клиенте будет 
    # camcontrol devlist
...
...
<FR-5 Z1X2WAX10000W451 0001>       at scbus1 target 0 lun 0 (da14,pass15)
<FR-5 Z1X2WB6J0000W451 0001>       at scbus1 target 0 lun 1 (da15,pass16)




двигаем даьше установку сревера

# service ctld onestart


    # service ctld status
ctld is running as pid 4963.

    # ctladm islist 
  ID Portal           Initiator name                       Target name                         

    # ctladm lunlist 
(7:1:0/0): <FREEBSD CTLDISK 0001> Fixed Direct Access SPC-5 SCSI device
(7:1:1/1): <FREEBSD CTLDISK 0001> Fixed Direct Access SPC-5 SCSI device

    # ctladm devlist
LUN Backend       Size (Blocks)   BS Serial Number    Device ID       
  0 block             488378646 4096 Z1X2WAX10000W451 MYDEVID0000     
  1 block             488378646 4096 Z1X2WB6J0000W451 MYDEVID0001     


вот это даст автомзпукск

 # echo 'ctld_enable="YES"' >> /etc/rc.conf


установка сервера закончена












УСТАНОВКА клиента iscsi

 # > /etc/iscsi.conf 
 # chmod 600 /etc/iscsi.conf 
 # cat /etc/iscsi.conf 

fr-4-target {
    initiatorname  = "iqn.1994-09.org.freebsd:fr-1:01:abcd1234567890fr-1";
    TargetName = "iqn.2005-10.org.freenas.ctl:fr-4";
    TargetAddress = "100.69.11.4:3260";
}

 

initiatorname  (как мы будем предтсавлтся удаленному iscsi серурверу)
TargetName  (iqn удаденного iscsi сервера куда будем подключаться)
TargetAddress (адрес удаенного сервера)


запустить руками сервис
    # service iscsid onestart



поключиться
    # iscsictl -An fr-4-target


проверить статус
    # iscsictl -An fr-4-target
    # iscsictl -L
Target name                          Target portal    State
iqn.2005-10.org.freenas.ctl:fr-5     100.69.11.5:3260 Connected: da14 da15 da16 
iqn.2005-10.org.freenas.ctl:fr-4     100.69.11.4:3260 Connected: da17 da18 



отключиться от iscsi сервера
    # iscsictl -R -a



в автомзпуск

echo 'iscsi_initiator_load="YES"' >> /boot/loader.conf



в rc.conf
  
iscsid_enable="YES"        # демон iSCSI
iscsictl_enable="YES"      # контроллер сессий  
iscsi_target="fr-4-target  fr-5-target"  # имя из /etc/iscsi.conf








когда на iscsic сервере мы добавили новый лун то на клиенте его можно увидеть вот так 
сервер  # service ctld reload

на клиенте делаем рексан лунов

       # camcontrol rescan 1





на сервер создаем пул

[root@fr-1 ~]# camcontrol devlist
<FR-5 Z1X2WAX10000W451 0001>       at scbus1 target 0 lun 0 (da14,pass15)
<FR-5 Z1X2WB6J0000W451 0001>       at scbus1 target 0 lun 1 (da15,pass16)
<FR-5 Z1X2W8DM0000W451 0001>       at scbus1 target 0 lun 2 (da17,pass18)
<FR-4 Z1X2W8B50000W451 0001>       at scbus2 target 0 lun 0 (da16,pass17)
<FR-4 Z1X2X1SE0000W451 0001>       at scbus2 target 0 lun 1 (da18,pass19)


# gpart destroy -F da14
# gpart destroy -F da15
...
# gpart destroy -F da18



[root@fr-1 ~]# gpart add -b 2048 -t freebsd-zfs -i 1 da15
da15p1 added
[root@fr-1 ~]# gpart add -b 2048 -t freebsd-zfs -i 1 da16
da16p1 added
[root@fr-1 ~]# gpart add -b 2048 -t freebsd-zfs -i 1 da17
da17p1 added
[root@fr-1 ~]# gpart add -b 2048 -t freebsd-zfs -i 1 da18
da18p1 added
[root@fr-1 ~]# gpart add -b 2048 -t freebsd-zfs -i 1 da19
gpart: No such geom da19.
[root@fr-1 ~]# gpart add -b 2048 -t freebsd-zfs -i 1 da14
da14p1 added




[root@fr-1 ~]# gpart list da14 | grep uuid
   rawuuid: 931fee20-dd1e-11f0-97a7-a4dcbef12d36
[root@fr-1 ~]# gpart list da16 | grep uuid
   rawuuid: 886ebc3a-dd1e-11f0-97a7-a4dcbef12d36


[root@fr-1 ~]# gpart list da15 | grep uuid
   rawuuid: 86dffca7-dd1e-11f0-97a7-a4dcbef12d36
[root@fr-1 ~]# gpart list da18 | grep uuid
   rawuuid: 8b26b2e5-dd1e-11f0-97a7-a4dcbef12d36
[root@fr-1 ~]# 


[root@fr-1 ~]# zpool create -o ashift=12 POOL-01 mirror  /dev/gptid/931fee20-dd1e-11f0-97a7-a4dcbef12d36  /dev/gptid/886ebc3a-dd1e-11f0-97a7-a4dcbef12d36  mirror /dev/gptid/86dffca7-dd1e-11f0-97a7-a4dcbef12d36 /dev/gptid/8b26b2e5-dd1e-11f0-97a7-a4dcbef12d36


[root@fr-1 ~]# zpool list
NAME      SIZE  ALLOC   FREE  CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP    HEALTH  ALTROOT
POOL-01  3.62T   468K  3.62T        -         -     0%     0%  1.00x    ONLINE  -
zroot2    556G  1.30G   555G        -         -     0%     0%  1.00x    ONLINE  -
[root@fr-1 ~]# 
[root@fr-1 ~]# 
[root@fr-1 ~]# zpool status -v POOl-01
cannot open 'POOl-01': no such pool
[root@fr-1 ~]# zpool status -v POOL-01
  pool: POOL-01
 state: ONLINE
config:

    NAME                                            STATE     READ WRITE CKSUM
    POOL-01                                         ONLINE       0     0     0
      mirror-0                                      ONLINE       0     0     0
        gptid/931fee20-dd1e-11f0-97a7-a4dcbef12d36  ONLINE       0     0     0
        gptid/886ebc3a-dd1e-11f0-97a7-a4dcbef12d36  ONLINE       0     0     0
      mirror-1                                      ONLINE       0     0     0
        gptid/86dffca7-dd1e-11f0-97a7-a4dcbef12d36  ONLINE       0     0     0
        gptid/8b26b2e5-dd1e-11f0-97a7-a4dcbef12d36  ONLINE       0     0     0

errors: No known data errors
[root@fr-1 ~]# 


# pkg install screen


[root@fr-1 ~]# 
[root@fr-1 ~]# zfs create -V 500G  -o compression=off -o  primarycache=metadata  -o secondarycache=metadata -o volblocksize=128KiB  POOL-01/zvol-01-128K
[root@fr-1 ~]# 
[root@fr-1 ~]# # fio --randrepeat=1 --ioengine=psync --direct=1 --gtod_reduce=1 --name=test --filename=/dev/zvol/POOL-01/zvol-01-128K   --bs=$((1024 *1024)) --iodepth=1  --size=500G  --readwrite=write --numjobs=1  --group_reporting         



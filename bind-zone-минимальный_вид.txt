| bind
| dns
| soa
| ns
| zone

я хотел расказать что такое зона
какая у нее связь с доменом
и какие записи минимум должны быть в зоне

днс сервер это база данных.
в ней хранятся записи
записи имеют неколко полей


имя  TTL  IN   тип  значение


кллиент делает запрос и указывает 

имя + тип

это используется как ключ. 
также клиент указывает какой алогрим нужно
юзать при поиске рекурсивный или итератиный  
по ним днс сервер
ищет запист или записи

днс сервер хранит данные в локальной базе тоесть
в своих файлах и в кеше.
в кеше сервер хранит разорозенные записи которые
он узнал от других серверов по сети

а вот в локальных файлах днс сервер хранит
записи толко группаами. одна группа хранится
в одном файле. группа записей называется зона.
что общегоу записей в одной зоне?

при создании зоны мы укаызаем домен
например зона для vasya.loc
так вот в файле зоны могу быть записи только 
которые имеют имя vasya.loc либо его поддомены
тоесть общий шаблон имен записей в файле зоны

  (*.)vasya.loc

тоеть

  vasya.loc. 
  123.vasya.loc.
  kuku.pp.vasya.loc.

доменно имя всегда закачниатеся на точку. 
то что  в бразуере мы не укызаем точку это просто
уебки придумавие браузер скаазали что ее можно
не писать. на самом деле она там есть

тепер вопрос если мы создаем зону то 
сколько и какие минимально записи там должны быть.

ответ в зоне должны быть записи :

  SOA одна штука
  NS  одна а лучше две штуки
  А   может быть а может не быть

также в зоне выгодно разменсить директиву 

$TTL	604800

дело в том что каждая днс запись должна иметь 
рпараметр TTL чтобы его каждый раз не писать
можно задать его сразу для всех записей

тепрт про записи
SOA


@	IN	SOA	ns1.kukushka.loc. admin.kukushka.loc. (
			    31		; Serial
			 604800		; Refresh
			  86400		; Retry
			2419200		; Expire
			 604800 )	; Negative Cache TTL
;


знак @ всего навсего значит vasya.loc. тоесть имя
домена который указан при создании зоны. и все.
типа алиас

сама запись чисто технически нужна не для резволвинга
а только для того чтобы секндари днс сервер мог
из этой записи узнать какое имя у примари днс
сервера где хранится исходная основаня превинчная
копия зоны. только на мастере в нее можно внсоить
изменения руками. а секондари только в себя ее 
копируют.  

параметр ns1.kukushka.loc как раз укываеает как
днс имя примари днс сервера.
по болшой счету болльше ни для чего эта запист
ненужна

admin.kukushka.loc. это почта админа который отве
чает за зону означает admin@kukushka.loc.

			    31		; Serial
			 604800		; Refresh
			  86400		; Retry
			2419200		; Expire
			 604800 )	; Negative Cache TTL


это разные таймауты о них щас говорить нет 
большого смысла

604800 )	; Negative Cache TTL
вот этот параетр означает какой ТТЛ назначается
пустому ответу. если сервер вернул клиенту
пустой ответ то он тоже должен иметь ттл.

итак со смыслом соа стало понятно

дальше про NS

она укзывает доменное имя серверов которые 
хостят эту зону. миниму один а лучше хотя бы два

напрмиер зона vasya.loc

vasya.loc.   IN  NS    ns1.vasya.loc.
vasya.loc.   IN  NS    ns2.vasya.loc.


домен vasya.loc. можно замени на @

@   IN  NS    ns1.vasya.loc.
@   IN  NS    ns2.vasya.loc.

если я уберу точку на конце то это будет  значить
для бинда что к доменному имени в файле нужно 
присоединить доменое имя в названии зоны
поэтому аналогично

@   IN  NS    ns1
@   IN  NS    ns2


третий вид записи которйы может быть в зоне
а может и не быть это ИП адреса указанных 
днс серверов. если мы указали  в зоне днс имя
днс сервера то в добавое мы обызаны указать какой
у него ип. иначе как к ним связаться на прпаткие
и тут стуть такая. этот ип конкретно в этом
файле указывать нужно не всегда. потому что  
в одних случаях этот ип можно найти из фйлов других
зон. а вот если в других зонах эттого ип быть  не
может тогда мы обязые конечно его конечно указаоть
в нашей зоне

если у меня
вот такой вариант

@   IN  NS    ns1.petya.loc.
@   IN  NS    ns2.petya.loc.

то записи А тоесть ип адреса этих серверов в зону
вставлять ненужно. почему? потом что данные
днс имена никак не связаны с доменом зоны vasya.loc.
тоест домен petya.loc и  vasya.loc они незавиимы
а значит ип адреса *.petya.loc. хранятся где то
точно в другом месте.
более того положим я бы указал их ип

ns1.petya.loc.  IN NS 1.1.1.1
ns2.petya.loc.  IN NS 2.2.2.2

но это было бы грубо неверно потому что домены
ns1.petya.loc.    и  ns2.petya.loc.
не являся подоменами vasya.loc. поэтмоу таких
записей быть в файле не может


если у нас такая ситуация

@   IN  NS    ns1.vasya.loc.
@   IN  NS    ns2.vasya.loc.

то ип адреса нужно добавит обядательно

@   IN  NS    ns1.vasya.loc.
@   IN  NS    ns2.vasya.loc.

ns1 IN  NS    1.1.1.1
ns2 IN  NS    2.2.2.2

потому что домены ns1.vasya.loc. и ns2.vasya.loc. 
являются поддоменами домена нашей зоны vasya.loc.
а это значит что записи этих доменов должны и могут
содрежатья только в этой зоне и больше ни в какой зоне. потому что как я ранее сказал что если
у нас есть зона с доменом vasya.loc то эта и только эта 
зона содержит в себе зааиси с именами равными
этому домену vasya.loc и все его поддомены 
*.vasya.loc , поддомены не могу содержаться в других
зонах.

есть еще вариант когда нужно добавить ип адрсе
нс сверов в файл.
для начала нужно вот что  еще скзаать. если я 
создаю зону для домена vasya.loc. то как я сказал
в этом файле могут быть записи с именами vasya.loc.
а также записи с имнами поддоменов этого домена 
*.vasya.loc. 
так вот часть записей нашей зоны можно делегиротваь
на хостинг другому серверу а еси быть точнее 
часть записей можно выделить в отдельную зону а эту
зону можно разметсить на другом сервере но также
ее можно размеитсть  и на этом сервере. но чаще
ее суют на другой. это назвыается делегивоание.
при делеегировании обычно подчеркивают что часть
записей выделются на другой сервер. но это не верый
аквент. делегиварние это прежде всего выделение
части записей в друугую отдельру зону!(отдедьный файл) а уж где этот файл будет хранисят на другом
сервере или на этом это уже дело второй важности.
пример. я хочу выделить записи для домена www.vasya.loc. и 
все его поддомены в отедьную зону тогда 
это вынлядит вот так


www.vasya.loc.   IN  NS   имя_днс_сервера


тоест елси бинд в файле зоны встерчает запист
с типом NS и в имени стоит домен зоны


vasya.loc.   IN  NS    ...

то бинд понимает что это днс сервер который 
отвечает хостит ЭТУ зону

а если он встречает НС запись у которой имя
домена другое то днс сервер считает что таким
макаром мы обьявляем что укзаанный субдомен мы
делегировали в отдельную зону а имя днс сервера
которое указано в занчении гвоорт на каком 
сервере хранится эта зона. пример у меня зона vasya.loc и она выгляди вот так

@ IN SOA ....

@ IN NS ...

www IN  NS ...

это значит что субдомен www.vasya.loc. и его записи
и заиси его поддоменов хостятся не в этой зоне
а в отдельной зоне. тепрь более конерктно


@ IN SOA ....

@ 	IN NS 	ns1.petya.loc.

www IN  NS  ns1.kuku.loc.


это значит что записи для домена vasya.loc 
хостстя на днс сервере ns1.petya.loc
и в тоже время часть записей зоны vasya.loc.
а точнее записи для www.vasya.loc. хранится 
не на сервере ns1.petya.loc а на другом на
ns1.kuku.loc.

так как petya.loc и kuku.loc ни коми образом
ни связаны с vasya.loc то ип адреса этих 
серверов мы не вклюачаем в наш файл зоны. да
мы и не можем  потому то 


ns1.petya.loc.
ns1.kuku.loc.

ни коим образом не входят в щаблон *.vasya.loc
тех имен записей которым разрееешено быть 
в этом файле

теперь сморим такой случай


@ IN SOA ....

@ 	IN NS 	ns.www.vasya.loc

www IN  NS  ns1.kuku.loc.


что мы имеем. у нас получается данная зона 
отвечает за зону vasya.loc и уего субдомены
но при этом записи вида *.www.vasya.loc исклюены
из данной зоны и хранятся гдето в другом месте
а тончнее на сервере   ns1.kuku.loc. тоесть 
в этом файле записей вида

www.vasya.loc
er.www.vasya.loc

быть не может. они хрантся в другом файле. вдругой
зоне. 

правда тутже можно замеитить что сама запись
которая обявляет о делегировании

www IN  NS  ns1.kuku.loc.

противорчеичит сама себе!
потому что она экивалентна

www.vasya.loc. IN  NS  ns1.kuku.loc.

а мы толко что обьявили что в нашем файле
записей вида www.vasya.loc. быть неможет.
да! в этом дебилизм бинда и днс. быть не может
за исключенеим самой делегирующей записи!

так вот еще раз 


@ 	IN NS 	ns.www.vasya.loc

www IN  NS  ns1.kuku.loc.

делегирующая строка нам говорит что записи
с именем www.vasya.loc. в нашем файле не хостятся
при этом можно зметить что в записи для днс
серера который отвечает за нашу зону

@ 	IN NS 	ns.www.vasya.loc

указано доменное имя ns.www.vasya.loc которое
явлтся поддоменом www.vasya.loc 
в самой этой записи проблемы нет в том плане
что делегирование запрещает в файле зоны
размещать записи у которых ИМЯ равно *.www.vasya.loc
а у нас в этой записи

@ 	IN NS 	ns.www.vasya.loc

запрещенное доеменное имя содержися в поле ЗНАЧЕНИЕ
, а в поле значение у нас может быть любое 
доменное имя. так что с этой точки зрения все чисто.
но! у нас получается прикол. у нас доменный 
сервер который обслуживает НАШУ зону имеет
доменное имя ns.www.vasya.loc которое является
субдоменом для домена нашей зоны vasya.loc
но также оно явлется субдоменом для зоны www.vasya.loc
которая с нашей зоны убрана.
так вот есть такое правило - что если у нас
в нашей зоне указан днс сервер (через запись NS)
и если в зоне есть делегиорванная зона
и если этот днс лежит в этой делегированной
зоне то несмотря на то что наша зоне не хостит
в себе записи из делегированной зоны в порядке
исключения мы в нашей зоне обязаны разместить 
запись тип-А про данный днс сервер



@ 	IN NS 	ns.www.vasya.loc

www IN  NS  ns1.kuku.loc.

ns.www.vasya.loc   IN  A   1.1.1.1


это я рассмотрел случай когда у нас днс сервер
нашей зоны лежит вне в субдомене зоны но внутри
делегированной зоны.

ровно тоже самое если мы говорим о днс сервере
который хостит делегированную зону. с ним
тоже самое


@ 	IN NS 	ns1.vasya.loc

www IN  NS  ns1.www.vasya.loc.

ns1.www.vasya.loc   IN  A   1.1.1.1


тут  я  хочу сказать что если у нас в файле
зоны есть запись которой быть недолжно ,
за которую наша зона не отвечает (а просто разме
щает ее) то она называется неавтортивная. эту 
запись мой сервер не выдаст на ркуурсивный запрос
а выдаст только на итератиный запрос (ищи файл
про итеративные и рекурсинвые запросы что это )
в даннос лучае эта запсь

ns1.www.vasya.loc   IN  A   1.1.1.1

является неавтортивиной 
впрочем как и эта

www IN  NS  ns1.www.vasya.loc.
 
тоже навтортирвная.

так вот в этом случае


@ 	IN NS 	ns1.vasya.loc

www IN  NS  ns1.www.vasya.loc.

ns1.www.vasya.loc   IN  A   1.1.1.1

нужно добавить еще запись это А-запись для
днс сервера нашей зоны. только она уже счтается
автортиная 


@ 	IN NS 	ns1.vasya.loc

www IN  NS  ns1.www.vasya.loc.

ns1.www.vasya.loc   IN  A   1.1.1.1


ns1.vasya.loc  IN  A   2.2.2.2  (эта запись)

она раскрывает чему равен ип адрес нашего
днс сервера. она автортиивная. потому что 
она соглсно имени домена является субдоменом для
ддомена нашей зоны vasya.loc и при этом она не принадлежит делегированному домену. тоесть
она записана в файл зоны абослютно законно.
она автортиная. (что такое автортинав не автотиная
ищи опть же отдельный файл с обьяснением)



а может быть и все вместе оба днс сервера
и нащей зоны и делегированной лежит в делегированной
зоне. тогда 


@ 	IN NS 	ns1.www.vasya.loc

www IN  NS  ns2.www.vasya.loc.

ns1.www.vasya.loc   IN  A   1.1.1.1
ns2.www.vasya.loc   IN  A   2.2.2.2  


оба А-записи явлсяются неавтртивными.
они обе формально хостятся в другой зоне.
а здесь они просто размещены. 
размещены они для того чтобы избежать
петель при поиске и\или чтобы облегчить
поиск ип адреса чтобы никуда дполинтельно
ненужно было лазить


я попытаюсь обяснить коротко что такое автортивные
записи. если днс сервер нам верул запись и 
флаг АА то он от утверждает что эта запись 
автортиная. что это значит. это значит что она
100% верна подлинная истинная. днс так утсроен
что отдельная запись  у нее есть срвер владелец
который уполномочен ее хранить. прикол в том что
при запросе к днс серверу он может спросить
запсись у других днс серверов. и преедать ее 
нам. даже если наш серер получил запись от 
друогого сревера который сообщил ему что 
она автортиинвая но на сервер пердавая нам эту 
запись флаг АА недаст потому что хотя запис 100%
поддинная но! эту запись наш сервер не хостити
не отваечает за нее не владеет.
есть и другой вариант. мы на нашем сервере можем
размести запись в файл тоест она хстится на нашем
сревере но вообщето это не ее основное место 
хранилища. наш сервер в целом не уполномчен
ее храниь у себя. это исключение из правил. 
он отдаст эту запись только если мы в запросе
ему скажем что мы в ответе допусукаем что он 
будет искать запись в своих локальыных записях
но при этом не требуем чтобы запись была автортивная.
вобщем мудота та еще.
автортинвая запись означает что 

 1) она физиески хранится на лоалном файле
    а не получаена из сети
 2) сервер является уполномоченным
    истчником ее хранения

тоест запись может хранится локально а может 
быть получена из сети.

у кадой записи есть всегда только один уполеномен
ный сервер котому дано право ее хранить и при
ее выдаче говрить что он автортитивный для этой
записи. другие сервера если они эту запись 
хранят и отадют или если они ее получили из сети
и отдают они не имеют права сообщать что она
якобы автотинвая.

мудота полная.


в общем и  в целом я в этм посте 
хотел распастьа  какой миимальный вид 
имеет зона. 

вот такой



$ORIGIN vasya.loc.
$TTL	604800


@	IN	SOA	ns1.vasya.loc. admin.vasya.loc. (
			    31		; Serial
			 604800		; Refresh
			  86400		; Retry
			2419200		; Expire
			 604800 )	; Negative Cache TTL
;

; NS servers
@	IN      NS      ns1.vasya.loc.

; name servers - A records
ns1		IN      A       172.16.100.26


эта диркетива
$ORIGIN vasya.loc.
она здает чему равно @
ее можно не завать тогда @=тому домену что
указан при создании зоны в другом файле

# cat ../named.conf.local 

zone "vasya.loc" {
    type master;
    file "/etc/bind/zones/db.vasya.loc";
    allow-transfer { 172.16.100.27; };   
};


это 
$TTL	604800
деволтовый ттл для всех записей чтобы
при их написании не пришлось его постоянно
вбивать

далее соа
далее нс от текущего домена

ну и А-запсь которая раскрвает чему равен ип
адрес днс сервера теукщего домена как я распиывал
выше иногда ее можно не указать. но обычно надо.


в принципе ее можно и нужно не укзавыать только в
одном случае есдл днс имя домен срвера
не является доменом или субдоменом домена зоны
тоест вот у нас домен зоны vasya.loc
а сжкаем

@	IN      NS      ns1.petya.loc.

днс имя днс сервера ns1.petya.loc.
не явялетяс ни донменом vasya.loc ни его 
субдоменом.

тогда мы не должны и даже не можем в наш файл
вставить эту запсь

ns1.petya.loc.  IN    A 1.1.1.1

потому что доменное имя ns1.petya.loc. не 
вкыдается в разрешенный шаблон для имен
котоыре можно твставлять в этот файл

  *.vasya.loc.

поэтмоу есили  бы мы даже хотели мы не можем
вставить



ровно такая ситуация у нас напрмиер  для зоны "com."
эта зона имеет NS сервера вот с таким домен 
именем

dig -4 @1.1.1.1  -t NS "com."  +recurse

com.			161836	IN	NS	a.gtld-servers.net.
com.			161836	IN	NS	b.gtld-servers.net.

тоесть домен имя "a.gtld-servers.net."
не является доменом или субдоменом от ".com"
значит мы никак не можем размеить в файле зоны ".net"
запись с именем 


a.gtld-servers.net.    IN   A  1.1.1.1

щас мы это проверим.
делаю реквест к серверу который хостит зону ".com"
и запрашиваю оттуда запись a.gtld-servers.net. (тип А)

# dig -4 @a.gtld-servers.net.  -t A "a.gtld-servers.net."  +norecurse

ответ пустой. что мы и ожидаем
опция +norecurse задает то чтобы сервер искал
толко в своих локлаьых файлах но не в сети(упрощенно)

тоесть у нас есть зона "com."
в ней есть запись соа

# dig -4 @a.gtld-servers.net.  -t SOA "com."  +norecurse

;; ANSWER SECTION:
com.			900	IN	SOA	a.gtld-servers.net. nstld.verisign-grs.com. 1748441752 1800 900 604800 900


и в ней есть запись NS

# dig -4 @a.gtld-servers.net.  -t NS "com."  +norecurse

;; ANSWER SECTION:
com.			172800	IN	NS	a.gtld-servers.net.
com.			172800	IN	NS	b.gtld-servers.net.

тоесть
файл зоны примерно вот такой



com.			900	IN	SOA	a.gtld-servers.net. nstld.verisign-grs.com. 1748441752 1800 900 604800 900


com.			172800	IN	NS	a.gtld-servers.net.
com.			172800	IN	NS	b.gtld-servers.net.


записей вида

a.gtld-servers.net.   IN   A  x.x.x.x

в этой зоне нет
еще раз потому что домен a.gtld-servers.net. 
не явлатеся субдоменом от  com.
и значит запсь с таким именем пихать в эту зону
нельзя


вот счиаетс что у нас есть ирерахия днс серверов
на саомом деле у нас есть иеррархия зон а срервера
лишь носители этих зон.

напрмимер вот эта иерархия

   vasya.loc.
      \
       \
        \
         www.vasya.loc.
         \
          \
           \
            balancer.www.vasya.loc


иерархия отображает лишь тот факт что записи
в данной зоне являются сумножеством которое
было вычленено из более широкой парент зоны
то оно явлется частью парент зоны.( и в парент
зоне этих записей соовсвтенно нет)

у нас зона и ее субзона не обязаны быть на разных
серверах они могут быть и на одном сервере. 
(так чисто для понимания)


расмотрю вот что как выглядит делегирование
зоны "com."  в зоне "."

делаю запрос на серерве который хостит зону "."

# dig -4 @199.7.83.42  -t NS "com."  +norecurse

;; AUTHORITY SECTION:
com.			172800	IN	NS	a.gtld-servers.net.

;; ADDITIONAL SECTION:
a.gtld-servers.net.	172800	IN	A	192.5.6.30

это дает мне право считат что зона "."
выглядит вот так в плане делегации из себя зоны "com."

зона ".":

com.			172800	IN	NS	a.gtld-servers.net.
a.gtld-servers.net.	172800	IN	A	192.5.6.30


тажкже  у нас зона net. делегирована из "."
поэтому

net.			172800	IN	NS	a.gtld-servers.net.


тоесть

зона ".":

com.			172800	IN	NS	a.gtld-servers.net.
net.			172800	IN	NS	a.gtld-servers.net.
a.gtld-servers.net.	172800	IN	A	192.5.6.30

это дает то что вот эти две записи 
они неавтортивные в зоне "."


com.			    172800	IN	NS	a.gtld-servers.net.
a.gtld-servers.net.	172800	IN	A	192.5.6.30


причем первая запис нзыватеся делегирующая
а вторая называется GLUE

в кавестве неавтортиных обе записи валидно иметь
в зоне "." потому что 
оба домена и 'com.' и 'a.gtld-servers.net.'
являтся субдоменами от домена зоны "."

ну а в самой зоне ".com"
у нас только запись



зона "com.":
com.			172800	IN	NS	a.gtld-servers.net.


котоаря в ней уже автортивная


итак еще раз 


зона ".":
com.			172800	IN	NS	a.gtld-servers.net.
net.			172800	IN	NS	a.gtld-servers.net.
a.gtld-servers.net.	172800	IN	A	192.5.6.30


зона "com.":
com.			172800	IN	NS	a.gtld-servers.net.


также 
зона "gtld-servers.net.": 
a.gtld-servers.net.	172800	IN	A	192.5.6.30


соотвасвтенно если я хочу поменять днс
сервер зоны "com." то мне надо сдедать кучу работы


 

зона ".":
com.			172800	IN	NS	nscom.vasya.ru.
ru .			172800	IN	NS	ns1.ru.
nscom.vasya.ru.	172800	IN	A	19.19.19.19


зона "com.":
com.			172800	IN	NS	nscom.vasya.ru.


зона "ru.": 
nscom.vasya.ru.	172800	IN	A	19.19.19.19

дохрена работы


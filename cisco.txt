cisco 

Easyvpn
Easyvpn?
Easyvpn!
Easyvpn..


во первых easyvpn это не l2tp\ipsec хотя он 
на него и похож потому что использует похожие хрени:
это как я понял отдельный вид впн, разработка 
самой циско. другими словами встроенный в виндовс клиент l2tp\ipsec
он с этим впн неумеет соединяться.

с esyvpn нужно использовать либо цисковский клиент
либо shrew client.

итак поняли что easyvpn и l2tp\ipsec это разные впны.
и клиенты к ним разные значит.

easyvpn использует всего два порта:
500 UDP (ISAKMP)
4500 UDP (NAT-T)

я проверил на практике что именно достаточно этих двух портов. 

в инете много конфигов кооторые совершенно неработают.
и только в одном месте я нашел конфиг который реально работает

https://ker-laeda.livejournal.com/2274.html

значит конфиг со страницы

aaa new-model

aaa authentication login vpn_xauth_1 local
aaa authorization network vpn_group_1 local

crypto isakmp policy 1
 encr 3des
 authentication pre-share
 group 2

crypto isakmp client configuration group remote-clients
 key megakey123
 dns 192.168.1.10
 domain domain.local
 pool POOL_1
 acl 100

access-list 100 permit ip 192.168.7.0 0.0.0.255 any
ip local pool POOL_1 192.168.7.1 192.168.7.100


crypto isakmp profile ike-profile-1
   match identity group remote-clients
   client authentication list vpn_xauth_1
   isakmp authorization list vpn_group_1
   client configuration address respond
   virtual-template 1

crypto ipsec transform-set transform-1 esp-3des esp-sha-hmac

crypto ipsec profile Cisco_Profile1
 set transform-set transform-1
 set isakmp-profile ike-profile-1

interface Virtual-Template1 type tunnel
 ip unnumbered GigabitEthernet0/1
 tunnel mode ipsec ipv4
 tunnel protection ipsec profile Cisco_Profile1


ремарка:
	access-list 100 
это аксес лист в котором  src указыаем vpn ip сеть а dest указываем локальную сеть за циско. впн сеть у нас это 192.168.7.0  и если хотим разрешить из впн клиента шариться везде то в в правиле указываем 
	access-list 100 permit ip 192.168.7.0 0.255.255.255 any


 	

теперь привожу уже свой рабочий конфиг на cisco 1811

aaa new-model

aaa authentication login vpn_xauth_1 local
aaa authorization network vpn_group_1 local

crypto isakmp policy 1
 encr 3des
 authentication pre-share
 group 2


crypto isakmp client configuration group remote-clients
 key megakey123
 pool POOL_1
 acl 100

ip local pool POOL_1 172.16.30.10 172.16.30.200
access-list 100 permit ip 172.16.30.0 0.0.0.255 192.168.0.0 0.0.255.255


crypto isakmp profile ike-profile-1
   match identity group remote-clients
   client authentication list vpn_xauth_1
   isakmp authorization list vpn_group_1
   client configuration address respond
   virtual-template 1


crypto ipsec transform-set transform-1 esp-3des esp-sha-hmac

crypto ipsec profile Cisco_Profile1
 set transform-set transform-1
 set isakmp-profile ike-profile-1


interface Virtual-Template1 type tunnel
 ip unnumbered FastEthernet0
 tunnel mode ipsec ipv4
 tunnel protection ipsec profile Cisco_Profile1

конфиг 100% рабочий проверенный.

сразу скажу что в easyvpn клиенте обязательно нужно указать 
так назвыаему группу. она задана в строке

	match identity group remote-clients
	
и равна remote-clients

(?????? здесь ссылка на shrew на aceqbaceq с картинками shrew, и easyvpn
клиента)

также надо сказать (повторить) что если на WAN интерфейсе применен какойто acceess list
то для того чтобы заработал ipsec vpn надо на этом access листе открыть

isakmp port = UDP 500
non500-isakmp port(NAT-T) = UDP 4500

еще пишут что якобы надо разрешить: 
 - esp

но пофакту мне непришлось его разрешать.
вот как выглядит мой аксеесс лист на WAN интерфейсе

interface FastEthernet0
 ip address xx.85.85.114 255.255.255.0
 ip access-group wan-in-acl-ver2 in
 ip nat outside
 ip virtual-reassembly in
 load-interval 30
 duplex auto
 speed auto
 
 Extended IP access list wan-in-acl-ver2
    50 permit udp any any eq isakmp (12 matches)
    60 permit udp any any eq non500-isakmp
    500 deny ip any any (356 matches)

как видно никаких esp у меня неразрешено.однако 
впн к впн успешно я подключаюсь.



если же на WAN интерфейсе нет никаких acl то и париться ненужно.


?????????? тут еще настройки shrew должны были быть картинки 

циско умеет работать только с диффи хельман 2 ( group 2) для ipsec\l2tp это его такой баг.

в shrew в строке  "key id string " надо указать то что прописано в 

crypto isakmp client configuration group remote-clients

то есть в данном случае

 "key id string " = remote-clients

без этого параметра шрью незаработает это просто невозможно.
это такой же неотебмлимый параметр как shared key.

Тажке есть еще один очень важный нюанс. Сопряжение NAT и vpn.
дело в том что если на циске есть нат и также мы настроили впн
то при подключении клиента сам клиент успешно подключится но пинговать
никакие сети в локалке за циско мы несможем. почему. потому что 
обратный трафик летящий от компа из локальной сети за циско будет 
попадать под NAT правило и у него насколько я помню будет заменяться 
src ip (на WAN IP) а далее пакет уже доходит до таблицы маршрутизации
и успешно улетает в интернет а не в впн интерфейс.
поэтому надо запретить натить трафик из локалки в впн сеть.
только для начала вспомним как нат задается на циско.
мы указываем какой интерфейс внешний и какой внутренний

interface FastEthernet0
...
 ip nat outside

interface FastEthernet1
...
 ip nat inside

теперт циско знает какой lan итерфейс а какой wan.
но этого мало. надо еще указать циске какой именно IP трафик
втекающий в LAN надо натить. 

ip nat inside source list nat interface FastEthernet0 overload

в ней указано что натить надо трафик который прописан в аксес листе 
с именем "nat" (имя могло быть любое другое)

скажем если мы разрешает любым LAN сетям быть натнутыми то аксес 
лист будет выглядеть так

ip access-list extended nat
 permit ip any any


возврашается к впн.
если 
  сеть локалки это 192.168.10\24 
  а впн сеть это 172.16.30.0.24
  
  то для нат правило надо поправить так
  
 ip access-list extended nat
 deny   ip 192.168.10.0 0.0.0.255 172.16.30.0 0.0.0.255
 permit ip any any
 
 
 еще раз про этот момент. что мы прописалив правиле.
 трафик идущий от впн клиента 172.16.30.0 0.0.0.255 он натиться небудет
 сам по себе. почему - потому что интерфейс через который втекает 
 впн трафик он необозначем как ip nat inside.
 значит трафик от впн клиента в LAN натом незатрагивается и он проходит в LAN. а вот обратный трафик от LAN копа к впн клиенту он уже по деолфту
втекает в интерфейс который обозначее как ip nat inside и циско смотрит 
что он совпадает с трафиком указанным в правиле nat. поэтому по дефолту
обратный трафик к впн клиенту будет натится. и это значит что впн клиент
ответ получать не будет. поэтму мы исключаем из ната обратный трафик
к впн клиенту. обратный тарфик выгдядит как
		src 192.168.10.0
		dest 172.16.30.0 
	вот мы его в access-list nat и добавляем  с припиской deny
	теперь обратный трафик от LAN  к впн клиенту хотя он и втекает 
	через FastEthernet1 который оброзначем как ip nat inside но приэтом 
	он отвергается аксесс-листом nat поэтому нат этот трафик нетрогает
	
	
 
 
 Также хочу разобрать еще один момент.
 
 из конфига выше видим
 
 aaa authentication login vpn_xauth_1 local
 
 что оно значит а еще точнее что в нем значит  vpn_xauth_1
 и какая разница если бы было написанро
 
 
 aaa authentication login vpn_xauth_1 local
 
 
 или даже в конфиге было бы прописано сразу две строчки 
 
 aaa authentication login default local
 aaa authentication login vpn_xauth_1 local

щас обьясню
	в целом 
		aaa authentication login 
	означает где циско когда на нее стучат (по консоли , по ssh, по впн)
	где она ищет логины пароли. а где она вцелом может их искать. 
	она их может искать в локальной базе тоесть юзеры которые прописаны 
	в самом конфиге циски, на радиус сервере, на tacacs сервере.
	
	далее после слова login циска ожидает увидеть название списка.
	это именно тупо название списка и больше ничего.
	пример
		aaa authentication login vasya ...
		aaa authentication login kuku ...
		
	vasya и kuku это название списка.
	есть название списка по умолчанию
	
		aaa authentication login default ...
	
	default это не метод входа а название списка.
	а гдеже циска хранит содержимое списка? а прям тутже. далее
	после названия списка через пробел идет содержимое списка.
	и в этом содержимом уже указываются места где надло искать логины
	пароли.
	места бывают:
		local - указывает что логин пароль искать в конфиге циски
		group - указывает что логин пароль искать на радиус сервере
		
	таким образом собираем всю шарманку вместе:
	
		aaa authentication login vpn_xauth_1 local
		
	vpn_xauth_1 local = список вместек с содержимым
	vpn_xauth_1 = название списка
	local = содержимое списка. конкретно означает ищи логины в конфиге
	
		aaa authentication login default local
	
	тоже самое что и предыдущее только название списка = default
	
		aaa authentication login default local
		aaa authentication login vpn_xauth_1 local
	
	а это тот случай когда на циске определено сразу два списка.
	а можно задать сто списков? можно хоть двести. 
	а зачем иметь на циско сто списков входа? а затем что 
	условно говоря можно тогда регулировать что например если заходищь
	через провод консольный или ssh то мол используй один список
	а если заходишт через vpn то используй другой список.
	
	например

		aaa authentication login default local
		aaa authentication login vpn_xauth_1 group R1 

	этот конфиг даст то что при заходе через провод консольный циска
	будет искать (использовать) логины из конфига. а если заходить через впн то будет искать логины на радиус сервере R1
	вот зачем можно иметь сто  списков на циске в конфиге.
	
	также. насколко я понял если мы собираемся описывать список default
	то его можно опускать в команде
	пример
	
		aaa authentication login local
		
	тоесть это одно и тоже с 
	
		aaa authentication login default local
		
	еще раз default это имя списка. а local это уже в каком месте искать
	логины пароли.
	
	такой тупизм потому что циско хранит содержимое списка в той же строке
	что и название списка.
	
	вопрос - а где прописано какой списко использовать когда мы входим по проводу а когда по впн. ответ: насколько я понял при входе по проводу используется всегда default список. а список который будет
	использоваться при входе по впн он указывается руками вот здесь
	
		crypto isakmp profile ike-profile-1
		match identity group remote-clients
		client authentication list vpn_xauth_1
		isakmp authorization list vpn_group_1
		client configuration address respond
		virtual-template 1
		radius
		
	таким макаром циска знает какой список ей использовать при входе по впн.


	мы поговорили про аутентифкацию. и мы сказали что 
	при входе через радиус на в строке authenticaion указать group имя_радиус группы
	
		aaa authentication login vpn_xauth_1 group R1 

	так вот для входу мало одной строки authentication у нас еще
	должна быть строка authorization ( аутентифкация говорит кто вошел, а авторизация говорит что ему можно делать )
	
	так вот для случая входа через радиус авторизация таого юзера обычно 
	идет не через радиус а локальная
	
		aaa authorization login vpn_xauth_1 local

	тоесть кто вошел циске подтверждает радиус сервер. а что ему делать
	циска решает локально сама. что интересно что при локальной авторизации и радиус аутентификации на самой циске в плане авторизации
	ничего прописывать ненадо. то есть мы с одной стороны сказале циске
	что вошедший пользователь облдаает правами которые ищи в локальной базе но в локальной базе ничего нет. однако вход все равно сработает.
	это прикол.
	в отличие от случая когда мы используем и локальную акутентификациб и локальнуюб авторизацию. тогда все понятно у нас в конфиге прописано
	
	username vasya privleige 15 0 пароль
	
	и для линии указано
	
	line vty 0 15
	authentication default
	authoriztion default
	
	чтото типа того. 
	
	и тут все понятно. юзер есть  ? есть. чтобы войти на линию 
	прописано что юзерам локальным можно входить. 
	уровенть привилегий в username относится уже к другому. вот ты вошел
	и как глубоко к командам имеешть доступ.
	
	
далее идут доп заметки про easyvpn.
значит оказалось что vpn это безумно сложная штука.
так что будут какието кусочки знания.



как я понимаю easyvpn онбазируется на ipsec,
какие там детали разницы непонятно,
позиционируется что easyvpn круче тем что на стороне клиента
надо делать меньше настроек чем в классическом ipsec(темныйлес),

IPSEC это толи целый стек протоколов. то ли это вообще концепция в целом
без конкретной реализации.

IKE(Internet Key Exchange) = ISAKMP + SKEME + OAKLEY

причем встретил в инете что цисковский IKE якобы состоит 
только из одного ISAKMP.

из того что прочитал на сайт ibm - когда ipsec пакет проходит nat
то с ним происходмт жопа так как nat подменяет src ip а внутри 
пакета ipsec шифрует все данные при отправлении пакета которые при 
получении можно проверить. и получается что как бутто пакет был злона
меренно изменен и приемник такой пакет отбрастывает. поэтому чтобы 
ipsec мог работать через NAT как я понял используют esp. 

????? здесь доложно быть какето описание ipsec воообще. как оно там работает.

IKE(Internet Key Exchange) якобы работает по порту UDP 500
AH неделает шифрования. но он удостоверяет достоверность пакета.
как я понял AH наверно упрощенно делает хэш из полного содержимого
ip пакета. поэтому никакая часть этого пакета неможет быть изменена.
иначе он уже недостоверный. поэтому AH неможет проходить через 
NAT.
ESP аналог AH.
как я понял AH неумеет шифровать. а умеет только удостоверять.
ESP умеет и шифровать и удостоверять пакет причем можно выбирать что 
будет включено то и другое или чтото одно.
возникет вопрос если esp умеет делать все что умеет AH нафиг нужен 
Ah. как я понял из инета если продавец железки хочет гарантировать 
что покупатель несможет шифровать а только удостоверять то 
он ему продаст реализацию на AH. типа относится к древним временам
и древним законам.
атак получается esp умеет делать все что умеет AH и даже больше.и все это можно выбирать и контролировать
как я понял AH добавляет типа хэша от содержимого пакета. а этот 
хэш зашифрован shared key. поэтому вторая сторона имеющая этот key дешифрует зашированный хэш и может сравнить подсунули ей оригинал
или подделку. злодей неможет подделать хэш потому что у него не шаред кей чтобы потом его зашифровать.
AH нам дает то что к нам прибывают достоверные данные но нет конфиденциальность. злодей неомжет подделать но может читать нашы данные.
как  я понял может одновременно применяться над пакетом и esp и ah.

прежде чем данные можно зашифровать и передать туда надо чтобы приемник
и передатчик имели друг о друге точную информацию : ключи которыми шифровать , адрес друг друга, метод шифрования. тоесть каждлый из сторон
должен иметь инфо о всех параметрах шифрованного сеанса связи.
это походуи и назвается у циско SA (security assosiations)

как я понял IKE хрень происхоодит в самом начале сеанса. 
и его задача безопасно и достоверно узнать обоим участникам обо всех 
параметрах сенаса связи который будет. передать друг другу SA.
типа это происходит через UDP 500.
как только мы обменялись SA мы можем начинать передавать шифрованный трафик друг другу.

в тунельном режиме ( есть два режима Ipsec тунельный и транспортный)
esp он берет весь ip пакет целиком и сверху на него наворачивает 
новый IP header (src_ip_new, dest_ip_new+ свое контрольное поле) а старый 
ip пакет полностью внутри вложен и зашифирован.
новый ip header имеет src_ip_new = ip нашего гейтвейя а des_ip_new= ip гейтвея
получателя

итак при esp в тунельном режиме будет  [старый ip пакет зашифрованный][esp header][src_ip_new,des_ip_new]

внутри пакета который зашифрован там обычно в качестве ip адресов
лежать ip адреса 19x.16x.*.* тоесть адреса интервала локальных сетей.
оно и логично потому что мы же через впн свядзываем две локалки
теперь становится понятна разница между ip внутри esp пакета и ip которые находятся в головном хидере.

AH в тунельном режиме делает с пакетом почти тоже самое.
он берет исходный ip пакет и сверху на него наворачтивает новый IP header
и свое Ah контрольное поле. чего он неделает это он нешифрует заинкапсилированный пакет. хотя и esp тоже этого может при желании неделать. итак вот как выглядит пакет после AH

[старый ip пакет НЕзашифрованный][ah header][src_ip_new,des_ip_new]


НО! что умеет делать AH чегонеумеет делать ESP. 
в контрольном поле [ah header] содержится инфо об головном IP хидере 
  [src_ip_new,des_ip_new]
 вот что умеет AH чего неумеет ESP.
 AH у нас умеет защищать в плане аутентичность нетолько исходный пакет
 но и новый головной хидер!
 
 получается что на самом деле вообще говоря ESP неумеет делать все 
 что умеет AH(как этообычно утверждается). ну и конечно AH не умеет делать все что умеет ESP.
 
 интересно а как тоода шифруется трафик если используется AH. кто это делает за него.
 
 что такое транспортный режим в отличие от туннельного наверно позже будет понятно. 
 
 также теперь понятно что в тунельном режиме может быть задейтстовван одновременно и ESP и AH протоколы. ESP шифрует и аутенфтифициурет 
 исхоный ip пакет из локалки. а AH к этому добавляет аутентифицирование
 головного хидера.
 
 что дает аутентифкация головного хидера. как я понимаю  злодей может слать
 мусор на наш гейтвей и это станет понятно только после того как мы расшифровали esp хэдер у пакета.
 а если используется AH то это становится понятно уже сразу при приеме 
 пакета. смотрим в головной AH хидер.расшифроваывем его. и понимаем коректный ли он. я так понимаю что злодей просто несможет сгенерировать 
 верный AH хэдер потому что унего нет шаред ключа. тоесть src ip и dest ip головного хэдера ему известны конечно. но AH хэдер он сгененироваь неможет. поэтому если мыполучаем пакет от злодея с ожидаемым src ip dest ip (гейт на той и нашей стороне) то у него небудет верного AH хэдера и мы сразу понимаем что этот пакет от злодея.
 тоесть какой внещний ip хидер ему посылать понятно . но как его "подписать" ему невозможно. потому мы понимаем что пакет прилетел 
 не от хорошего человека. сразу отсюда вылезает что esp можно использовать
 через NAT а AH нельзя. потому что как только AH пролетит через NAT нашего провайдера то у него сменится src_ip. и мы пуолчим несовпадение
 инфо о src_ip головного хидера с инфо о том же в AH хидере.
 и приемник сразу посчитает такой пакет подделанным.
 Тогда сразу стаовится неопнятнго а как же в реальных сетях интернета 
 можно использовать AH.
 видимо станет понятно дальше
 
 дальше важно понять что как я понял есть 
 isakmp SA
 а есть 
 IPSEC SA
 
щас мы разберем
при установке vpn 
 есть фаза 1. на ее стадии рутеры обмениваются isakmp SA.
 как я понял отсюда) (https://www.youtube.com/watch?v=rwu8__GG_rw&ab_channel=RyanLindfield
 
 isakmp sa - это параметры шифрованной связи для организации канала
 котоырй относится не к каналу шифрованной связи по которому пойдут 
 данные от клиента. это шифрованный канал связи для между самих рутеров
 по которрому они будут обмениваться данными друг с другом о состоянии 
 и здоровье шифрованного канала по которым уже гонятся данные клиента.
 
 тоесть как бы вначале организуется управляющий канал. а потом
 уже будет оргаизован уже следуюший канал по которму погонятся данные.
 а в управляющем канале рутеры друг другу сооббщают служебную 
 информацию о состоянии главного канала.
 
 тоест как бы организщуется два канала: mgmt, data.
 оба криптованные. но разного назначения. по дата каналу гонятся 
 данные пользователся. по mgmt каналу рутеры друг с другом
 обмениваются инфо о состоянии этого дата канала.
 и соотсвтевенно параметры шифрования - SA они разные у mgmt и data
 каналов.
 
 фаза1 - это обмен isakmp sa. который для mgmt канал организации предназначен. фаза 1 в циско обозначается как policy
 а фаза2 как transform-set или еще profile
 
 вобще все логично. на первой стаиии рутерам надо друг с другом
 наладить безопасный канал связи по которому уже после этого они могут 
 договориться и передать параметры ключи о том как же они будут шифровать
 пользовательские данные. поскольку на стадии фаза 1 очень важно чтобы
 злодей не смог ничего подменить и данных надо пеерредавать мало то как я понимаю фаза 1 идет через ассиметричное шифрование. оно сильное
 но хорошо подходит только для малых обьемов передаваемых данных.
 
 
видно что для easyvpn используется два порта 
500 UDP 
4500 UDP

далее в том видео говорятчто isakmp SA он один на оба конца соединения. а ipsec SA их два. isakmp sa действует в обе стороны
	а ipsec sa действует в одну сторону.
	
	что вдруг дальше важно понять. зашифраоныее дата пакеты летят в сеть 
	в виде [ip header][esp header][esp payaload]. это значит что никаких 
	udp\tcp в нем нет. опа!
	
	так вот если у нас на WAТ интерфейсе есть акссес-лист на входящий трафик то получается что надо разрешить прохождение ESP трафика.
	так вот странно что я его неразрешал а eazyvpn у меня по факту работает.
	
	вот WAN интерфейс 
	interface FastEthernet0
    ip access-group wan-in-acl-ver2 in

	и его аксеесс-лист
	
	Extended IP access list wan-in-acl-ver2
    permit udp any any eq isakmp (103 matches)
    permit udp any any eq non500-isakmp (2 matches)
    deny ip any any (3722 matches)

	как видно ESP недолжен быть пропущен входящий. однако работает. 
	????? пока непонятно.
	
	ясно другое. как я понял в esp там нет портов как в udp\tcp
	но там есть spi. как я понял для каждого соединения междуц сервер 
	клиент в esp записыватся видимо два spi. один идентифицирует 
	хост на нашей стороне а другойхост на той стороне. имеется ввиду
	гейтвеи.
	spi можно видеть в wireshark.
	как я понял циско смотрит в spi приходящего пакета и сразу понимает
	через какой набор правил его расшифровывать.
	
	получается чтобы vpn ipsec easyvpn заработаал надо чтобы вначале
	прошла 1 фаза  , потом 2 фаза.
	
	для того чтобы понять что 1 фаза прошла смотрим
	
	#sh crypto isakmp sa
		IPv4 Crypto ISAKMP SA
		dst             src             state          conn-id status
		85.85.85.114    85.85.85.113    QM_IDLE           2006 ACTIVE

	на второй фазе вот это должно быть в порядке:
	#sh crypto ipsec sa
	там целая портянка вылезает
	
	из того что япрочитал ранее следует что при отправке в интернет
	пакет выглядит как
	
	[исходный ip пакет зашифрован][esp header][новый ip header]
	
	причем esp header никак не описывает новый ip header.
	таким образом я невижу проблемы прохождение пакета через NAT.
	да NAT будет колбасить [новый ip header] и когда он прибует 
	на тот гейтвей то он будет другой. но esp header это никак не 
	описывает так что по мне все должно быть хорошо. 
	однако у циско я читаю что нет. мол это плохо. при исполтьзовании
	esp нельзя менять заголовок нового ip header. в чем проблема я не понял. это же не AH. который да в своем заголовке описывает параметры нового ip hader. ладно. так вот циско пишет что это нарешать. как они решают. как я понял то ли в esp то ли в внутри 
	там на стадии устанвления соденияенеия но циско шифрует 
	где то там в кишках пакета ip адрес отправителя и получается имеются ввтиду именно параметры  [новый ip header] - там где указаны адреса
	гейтвеев на той и другой сторне.  в общем передают на ту сторону. и там сверяют с тем что в итоге пришо. и таким макаром короче определяют есть ли между двумя гейтвейями NAT. передача происходит через udp порт 500. по какому протоколу пока незнаю.
	так вот. если нат есть то циска автоматом без всякой доп настройки со стороны пользователя активирует фичу под названием NAT-T (nat traversal). это значит то что после этого передача начинает идти 
	через порт 4500 по протоколу UDP.
	
	и как же выглядит пакет
	
	[исходный ip пакет зашифрован][esp header][новый ip header][UDP header][[superновый ip header]
	
	таким образом когда данный пакет летит по интернету и проходит через 
	nat то изменяется  у него только вот эта часть [UDP header][[superновый ip header]
	осталная же часть неменяется. поэтому на гейтвей принимающий в его кишки неизменной доходит вот эта часть 
	
	[исходный ip пакет зашифрован][esp header][новый ip header]
	
	чего собственно циско и хотела добиться.
	
	хотя по мне это надо делать только в случае Ah протокла.
	anyway. 
	
	зато стало известно что NAT-T конфигурировать никак ненадо. это авто
	функция. если между концами тонеля есть nat то нужно обязательно
	на цисках открывать и 500 UDP и 4500 UDP.
	таже сталопонятно почему ненужно на WAN интерфейсе 
	на его in acl разрешать ESP протокол. потому что никакой esp  в него влетать небдует. в него из за доп инкапсуляции esp в udp будет 
	влетаь иключательно UDP трафик.
	
	таким образром я постулирую что для easyvpn на фарйволле
	надо открывать порты и протоколы только:
	 - 500 UDP
	 - 4500 UDP
	 
	 никакие esp , ah на нем разрешать ненадо. абсолютно.
	 
	 остатется проясниить как же все таки фазы происходят и 
	 как это настройками настраивается.
	 


============
казус циско.
накатываение конфига.
облом.

была 1811 с ios 12 - сломалась.
купили такую же но с ios 15.
накатил на нее конфиг. а она почему то вобще непингует 
ни один свой ip.

пришлось руками перебивать конфиг строчка по строчке
через терминал.

тогда только все сработало. 
может без вот это хрени которая появилась на новой циско

license udi pid CISCO1811W-AG-A/K9 sn FTX0946Z06C 

циско и неработала.

еще после загрузки конфига на новую циско нужно перегенерировать
rsa ключи

# crypto key generate rsa

иначе ssh доступ небудет работать


полезная команда показывает способность шифровать железки

#sh crypto eli
Hardware Encryption : ACTIVE
 Number of hardware crypto engines = 1

 CryptoEngine Onboard VPN details: state = Active
 Capability    : IPPCP, DES, 3DES, AES, IPv6, GDOI, FAILCLOSE

 IPSec-Session :     2 active,   300 max, 0 failed

далее нашел у циско такое

Cisco no longer recommends using DES, 3DES, MD5 (including HMAC variant), and Diffie-Hellman (DH) groups 1, 2 and 5; instead, you should use AES, SHA and DH Groups 14 or higher. For more information about the latest Cisco cryptographic recommendations, see the Next Generation Encryption (NGE) white paper.

des, 3des - это симметричное шифрование
диффи-хельман - это несимметричное шифрование

в плане дифи-хельмана циско рекомендует у него юзать Cisco recommends using 2048-bit or larger DH key exchange, or ECDH key exchange.

( фаза 1 бывает main и aggressive поканепонятна разница)

по крайней мере теперь стало понятно что вот этти строчки


crypto isakmp policy 10
 encr aes
 authentication pre-share
 group 14

отвечают за параметры Phase 1.

когда я задал такие параметры в циско и подключился к впн,
то про фазу 1 можно посмотреть на циске вот что

#sh crypto isakmp sa detail

C-id  Local           Remote          I-VRF    Status Encr Hash Auth DH

2009  85.85.85.114    85.85.85.113             ACTIVE aes  sha        14


сотвесвтенно в статистике нациско видно что 
впн между двумя точками идет по aes + sha + DH 14 (дифи-хельман) 




ipsec может:
 - шифровать даныные
 - запрету их менять
 - подтвредить что они пришли именно от васи
 - запрет на повтор пакетов

дальше походу я нашел у циско как у нее работает ipsec
когда не случай клиент-циско а когда между двумя рутерами.
тоесть когда заранее известны IP обоих сторон.
 
 ipsec - устанаваливает тонель между двумя точками.
 

мы создаем аксес лист. в которо проставляем src ip dest ip 
и также можно ряд layer 4 опций. 

и накатыаваем это аксесс лист на WAN интерфейс через крипто-мап.

таким макаром когда идет пакет от 192.168.1.1 на 192.168.5.1 
и на основе таблица маршрутизации он летит на WAN интерфейс то 
попав в аксес лист криптомапа на интерфейсе циска понимает что 
данный пакет надо непросто там через NAT выполунуть в интернет 
а надо криптовать в туннель IPSEC

остановился на том что через криптом -мап можно между 
двумя рутерами поднять ipsec vpn. надо посавтьи gns3
и сделать. после этого надо в  офисе делать.






=============	
	
L2TP



данный vpn имеет целую кучу подлянок и подьебок.


одна из: если поставить L2TP\IPSEC  в локалке
и через гейтвей пробросить наружу то виндовс клиент сука
он по дефолту неможет подключиться к такому впн.
чтобы виндовс клиент смог подключиться к таокму впн 
нужно на виндовсе в реестер внести ключ

HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\PolicyAgent
AssumeUDPEncapsulationContextOnSendRule = 2 (тип dword32)

нашел в этой ссылке - https://docs.microsoft.com/ru-ru/troubleshoot/windows-server/networking/configure-l2tp-ipsec-server-behind-nat-t-device

и перезагрузитьь виндовс.

поэтому лучше чтобы l2tp\ipsec сервер был выставлен непосредственн
в интернет напрямую чтобынепришлось мудить с настройками на клиентах.


терминология l2tp
LAC - это client
LNS - это server

еще подьебка:
окзаалось ! если мы в l2tp юзаем локальную базу логинов
паролей то пароль юзера нельзя чтобы содержал  символы !@#$...
при попытке залогтиниться под таким юзером виндовс будет писать что 
the remote connection was denied because the user name and 
password и дальге чтотио там про неверный логин и пароль или неверный протокол.

это решение нашел здесь - https://community.cisco.com/t5/small-business-routers/pptp-not-recognzing-accounts-in-local-database-rv340/td-p/3052636/page/2


кусок конфига отвечающий за l2tp\ipsec который 
реально работает.
аутентифкикация из локальной базы.



!

aaa authentication ppp VPDN_AUTH local


vpdn enable

!

vpdn-group L2TP

! Default L2TP VPDN group

accept-dialin

protocol l2tp

virtual-template 1

no l2tp tunnel authentication

!

!

!

username cisco privilege 15 password 0 cisco

!

!

crypto isakmp policy 1

encr 3des

hash sha

authentication pre-share

group 2

lifetime 86400

!

!

crypto isakmp key cisco123 address 0.0.0.0 0.0.0.0

!

!

crypto ipsec transform-set L2TP-Set2 esp-3des esp-sha-hmac

mode transport

!

crypto dynamic-map dyn-map 10

set nat demux

set transform-set L2TP-Set2 L2TP-Set

!

!

crypto map outside_map 65535 ipsec-isakmp dynamic dyn-map

!

!

!

interface Loopback0

ip address 192.168.47.1 255.255.255.0

ip nat inside

ip virtual-reassembly

!

interface Loopback1

description loopback for IPsec-pool

ip address 1.1.1.11 255.255.255.255

!

interface FastEthernet0/0

ip address 47.47.47.2 255.255.255.0

ip nat outside

ip virtual-reassembly

duplex auto

speed auto

crypto map outside_map

!

!

interface Virtual-Template1

ip unnumbered Loopback1

peer default ip address pool l2tp-pool

ppp authentication ms-chap-v2 VPDN_AUTH

!

!

!

ip local pool l2tp-pool 1.1.1.1 1.1.1.10

ip route 0.0.0.0 0.0.0.0 47.47.47.1

!

ip nat inside source list NAT interface FastEthernet0/0 overload

!

ip access-list extended NAT

deny ip 192.168.47.0 0.0.0.255 1.1.1.0 0.0.0.255

permit ip 192.167.47.0 0.0.0.255 any

!

!

конфиг взят отсюда - https://khomenko.org/?p=468

еще подьебка:
оказалось что данный конфиг неполучится вбиить в
ios версии  12.4(24)T3 а а получится только в версии Version 15.1(2)T1

потому что в версии ios 12.4(24)T3 нет вот этих вот команд

peer default ip address pool l2tp-pool

ppp authentication ms-chap-v2 VPDN_AUTH

в режиме интерфейса interface Virtual-Template1

они там просто отсутствуют.

далее.
если l2tp\ipsec сервер смотрим не в интернет а сидит в LAn
то на гейтвее надо пробросить порты

500 UDP
4500 UDP
1701 UDP

я проверил они все реально нужны. так как где то писали что 1701 ненужен.
хуйня и брехня.

при таких проброшенных портах точно все работает я проверял.

=======

cisco 

Easyvpn
Easyvpn?
Easyvpn!
Easyvpn..


во первых easyvpn это не l2tp\ipsec хотя он 
на него и похож потому что использует похожие хрени:
это как я понял отдельный вид впн, разработка 
самой циско. другими словами встроенный в виндовс клиент l2tp\ipsec
он с этим впн неумеет соединяться.

с esyvpn нужно использовать либо цисковский клиент
либо shrew client.

итак поняли что easyvpn и l2tp\ipsec это разные впны.
и клиенты к ним разные значит.

easyvpn использует всего два порта:
500 UDP (ISAKMP)
4500 UDP (NAT-T)

я проверил на практике что именно достаточно этих двух портов. 

в инете много конфигов кооторые совершенно неработают.
и только в одном месте я нашел конфиг который реально работает

https://ker-laeda.livejournal.com/2274.html

значит конфиг со страницы

aaa new-model

aaa authentication login vpn_xauth_1 local
aaa authorization network vpn_group_1 local

crypto isakmp policy 1
 encr 3des
 authentication pre-share
 group 2

crypto isakmp client configuration group remote-clients
 key megakey123
 dns 192.168.1.10
 domain domain.local
 split-dns domain.local
 pool POOL_1
 acl 100
 

access-list 100 permit ip 192.168.7.0 0.0.0.255 any
ip local pool POOL_1 192.168.7.1 192.168.7.100


crypto isakmp profile ike-profile-1
   match identity group remote-clients
   client authentication list vpn_xauth_1
   isakmp authorization list vpn_group_1
   client configuration address respond
   virtual-template 1

crypto ipsec transform-set transform-1 esp-3des esp-sha-hmac

crypto ipsec profile Cisco_Profile1
 set transform-set transform-1
 set isakmp-profile ike-profile-1

interface Virtual-Template1 type tunnel
 ip unnumbered GigabitEthernet0/1
 tunnel mode ipsec ipv4
 tunnel protection ipsec profile Cisco_Profile1


ремарка:
	access-list 100 
это аксес лист в котором  src указыаем vpn ip сеть а dest указываем локальную сеть за циско. впн сеть у нас это 192.168.7.0  и если хотим разрешить из впн клиента шариться везде то в в правиле указываем 
	access-list 100 permit ip 192.168.7.0 0.255.255.255 any


 
!!!! 
а вот еще один конфиг сервера как настроить eazyvpn но 
через криптом мапы


aaa session-id common
aaa authorization console
aaa authentication login default local
aaa authentication login vpn_xauth_1 local
aaa authorization network vpn_group_1 local
aaa authorization exec default local


crypto isakmp policy 1
 encr 3des
 authentication pre-share
 group 2

crypto isakmp client configuration group remote-clients
 key qwe45y!-190!
 dns 192.168.20.5
 domain m9.local
 split-dns domain.local
 pool POOL_1
 acl 100
 split-dns m9.local
 
ip local pool POOL_1 10.16.16.10 10.16.16.200

access-list 100 permit ip 192.168.9.0 0.0.0.255 10.16.16.0 0.0.0.255
access-list 100 permit ip 192.168.1.0 0.0.0.255 10.16.16.0 0.0.0.255
access-list 100 permit ip 192.168.0.0 0.0.0.255 10.16.16.0 0.0.0.255


crypto isakmp profile easyvpn-ike-profile-1
   match identity group remote-clients
   client authentication list vpn_xauth_1
   isakmp authorization list vpn_group_1
   client configuration address respond

crypto ipsec transform-set transform-1 esp-3des esp-sha-hmac
 mode transport


crypto dynamic-map DYNAMIC 10
 set transform-set transform-1
 set isakmp-profile easyvpn-ike-profile-1
 reverse-route

crypto map outside_map 65535 ipsec-isakmp dynamic DYNAMIC


interface FastEthernet0
...
 crypto map outside_map

!!!!
 


клиент получает адрес из диапазона 10.16.16.10 10.16.16.200

обращаю внимание на очень тонкий и важный момент:
acl 100 который мы прописали в crypto isakmp client он задает
к каким локальным сетям разрешен доступ от клиента в корпоративную
локалку. а точнее чтобы быть более точным (как я понимаю) этот acl 
задает ответный пакет от каких локальных сетей можно засовывать в 
крипто тоннель и посылть впн клиенту. потому что acl имеет очень непривы
чный вид. 

access-list 100 permit ip 192.168.9.0 0.0.0.255 10.16.16.0 0.0.0.255

как можно заметить src ip это локалка внутри офиса а dest ip это сеть
впн которую получит впн клиент. тоесть в acl указывается некуда нам 
можно стучать а кому оттуда нам можно отвечать! вот как хитро!
если перепутать местами то работать небудет система нипеталь.

но есть еще одна поразительная вещь. в конфиге присутствует опция reverse-route она дает то что на виндовсе (автоматом!!!) изи впн клиент
пропишет маршруты в таблице маршрутизации которые указаны в acl 100
и виндовс будет автоматом знать что в локальные корпоративные сети надо 
лезть через впн интерфейс.  тоесть это есть тот самый сплит-тунель 
через прописывание стат маршрутов на клиенте. таким образом на самом изи впн клиенте на виндовсе руками никакие маршруты в LAN офиса прописывать 
непридется. клиент автомтом засосет данные с циски и автомтом пропишет
во время подключения их  таблицу мрашрутизации виндовса. это очень круто!
единственно что еще раз хочу подчеркнуть эта офигенская штука сработает 
только если acl оформлен правильно. тоесть сети офиса в нем должны стоять 
на позиции src ip. самая частая ошибька которую я делаю это перепутыываю
местами src и dest сети в этом ip. потому что интуитивно хочется 
на первое место ставить сеть впн клиента а на dest сеть ставить сеть офиса. а для этого acl Это категорически неправильно. и в итоге впн клиент
небудет прописывать эти маршруты на компе винды.

на клиенте изи впн на примере shrew клиента чтобы эта шарманка работала
надо чтобы в policy стояла галочка " obtain topology automatically or tunnel all"


 очень важно помнить что в итоге крипто мап надо обязательно 
наложить на WAN интерфейс. незабыть. 
а то все запрограмируешь а применить криптомап к интерфейсу забудешь.


в конфиге это сделано:

!!!
interface FastEthernet0
...
 crypto map outside_map
!!!

по мне изивпн лучше настраивать через криптомапы метод потому что
если мы хотим на одной циске включить однровременно несклько видов 
vpn серверов то лучше всего они сосуществуют когда они все подключаться
через криптомапы. они тогда друг другу немешают.


всплыл правда один вопрос. а что если в офисе локалка имеет такую же 
сеть как локалка дома. то есть скжаем дома 192.168.1.0\24
 и в офисе. и надо с дома туда по впн попадать. надо об этом потом почитать.
 




теперь привожу уже свой рабочий конфиг на cisco 1811

aaa new-model

aaa authentication login vpn_xauth_1 local
aaa authorization network vpn_group_1 local

crypto isakmp policy 1
 encr 3des
 authentication pre-share
 group 2


crypto isakmp client configuration group remote-clients
 key megakey123
 pool POOL_1
 acl 100

ip local pool POOL_1 172.16.30.10 172.16.30.200
access-list 100 permit ip 172.16.30.0 0.0.0.255 192.168.0.0 0.0.255.255


crypto isakmp profile ike-profile-1
   match identity group remote-clients
   client authentication list vpn_xauth_1
   isakmp authorization list vpn_group_1
   client configuration address respond
   virtual-template 1


crypto ipsec transform-set transform-1 esp-3des esp-sha-hmac

crypto ipsec profile Cisco_Profile1
 set transform-set transform-1
 set isakmp-profile ike-profile-1


interface Virtual-Template1 type tunnel
 ip unnumbered FastEthernet0
 tunnel mode ipsec ipv4
 tunnel protection ipsec profile Cisco_Profile1

конфиг 100% рабочий проверенный.

сразу скажу что в easyvpn клиенте обязательно нужно указать 
так назвыаему группу. она задана в строке

	match identity group remote-clients
	
и равна remote-clients

(?????? здесь ссылка на shrew на aceqbaceq с картинками shrew, и easyvpn
клиента)

также надо сказать (повторить) что если на WAN интерфейсе применен какойто acceess list
то для того чтобы заработал ipsec vpn надо на этом access листе открыть

isakmp port = UDP 500
non500-isakmp port(NAT-T) = UDP 4500

еще пишут что якобы надо разрешить: 
 - esp

но пофакту мне непришлось его разрешать.
вот как выглядит мой аксеесс лист на WAN интерфейсе

interface FastEthernet0
 ip address xx.85.85.114 255.255.255.0
 ip access-group wan-in-acl-ver2 in
 ip nat outside
 ip virtual-reassembly in
 load-interval 30
 duplex auto
 speed auto
 
 Extended IP access list wan-in-acl-ver2
    50 permit udp any any eq isakmp (12 matches)
    60 permit udp any any eq non500-isakmp
    500 deny ip any any (356 matches)

как видно никаких esp у меня неразрешено.однако 
впн к впн успешно я подключаюсь.



если же на WAN интерфейсе нет никаких acl то и париться ненужно.


?????????? тут еще настройки shrew должны были быть картинки 

циско умеет работать только с диффи хельман 2 ( group 2) для ipsec\l2tp это его такой баг.

в shrew в строке  "key id string " надо указать то что прописано в 

crypto isakmp client configuration group remote-clients

то есть в данном случае

 "key id string " = remote-clients

без этого параметра шрью незаработает это просто невозможно.
это такой же неотебмлимый параметр как shared key.

Тажке есть еще один очень важный нюанс. Сопряжение NAT и vpn.
дело в том что если на циске есть нат и также мы настроили впн
то при подключении клиента сам клиент успешно подключится но пинговать
никакие сети в локалке за циско мы несможем. почему. потому что 
обратный трафик летящий от компа из локальной сети за циско будет 
попадать под NAT правило и у него насколько я помню будет заменяться 
src ip (на WAN IP) а далее пакет уже доходит до таблицы маршрутизации
и успешно улетает в интернет а не в впн интерфейс.
поэтому надо запретить натить трафик из локалки в впн сеть.
только для начала вспомним как нат задается на циско.
мы указываем какой интерфейс внешний и какой внутренний

interface FastEthernet0
...
 ip nat outside

interface FastEthernet1
...
 ip nat inside

теперт циско знает какой lan итерфейс а какой wan.
но этого мало. надо еще указать циске какой именно IP трафик
втекающий в LAN надо натить. 

ip nat inside source list nat interface FastEthernet0 overload

в ней указано что натить надо трафик который прописан в аксес листе 
с именем "nat" (имя могло быть любое другое)

скажем если мы разрешает любым LAN сетям быть натнутыми то аксес 
лист будет выглядеть так

ip access-list extended nat
 permit ip any any


возврашается к впн.
если 
  сеть локалки это 192.168.10\24 
  а впн сеть это 172.16.30.0.24
  
  то для нат правило надо поправить так
  
 ip access-list extended nat
 deny   ip 192.168.10.0 0.0.0.255 172.16.30.0 0.0.0.255
 permit ip any any
 
 
 еще раз про этот момент. что мы прописалив правиле.
 трафик идущий от впн клиента 172.16.30.0 0.0.0.255 он натиться небудет
 сам по себе. почему - потому что интерфейс через который втекает 
 впн трафик он необозначем как ip nat inside.
 значит трафик от впн клиента в LAN натом незатрагивается и он проходит в LAN. а вот обратный трафик от LAN копа к впн клиенту он уже по деолфту
втекает в интерфейс который обозначее как ip nat inside и циско смотрит 
что он совпадает с трафиком указанным в правиле nat. поэтому по дефолту
обратный трафик к впн клиенту будет натится. и это значит что впн клиент
ответ получать не будет. поэтму мы исключаем из ната обратный трафик
к впн клиенту. обратный тарфик выгдядит как
		src 192.168.10.0
		dest 172.16.30.0 
	вот мы его в access-list nat и добавляем  с припиской deny
	теперь обратный трафик от LAN  к впн клиенту хотя он и втекает 
	через FastEthernet1 который оброзначем как ip nat inside но приэтом 
	он отвергается аксесс-листом nat поэтому нат этот трафик нетрогает
	
	
 
 
 Также хочу разобрать еще один момент.
 
 из конфига выше видим
 
 aaa authentication login vpn_xauth_1 local
 
 что оно значит а еще точнее что в нем значит  vpn_xauth_1
 и какая разница если бы было написанро
 
 
 aaa authentication login vpn_xauth_1 local
 
 
 или даже в конфиге было бы прописано сразу две строчки 
 
 aaa authentication login default local
 aaa authentication login vpn_xauth_1 local

щас обьясню
	в целом 
		aaa authentication login 
	означает где циско когда на нее стучат (по консоли , по ssh, по впн)
	где она ищет логины пароли. а где она вцелом может их искать. 
	она их может искать в локальной базе тоесть юзеры которые прописаны 
	в самом конфиге циски, на радиус сервере, на tacacs сервере.
	
	далее после слова login циска ожидает увидеть название списка.
	это именно тупо название списка и больше ничего.
	пример
		aaa authentication login vasya ...
		aaa authentication login kuku ...
		
	vasya и kuku это название списка.
	есть название списка по умолчанию
	
		aaa authentication login default ...
	
	default это не метод входа а название списка.
	а гдеже циска хранит содержимое списка? а прям тутже. далее
	после названия списка через пробел идет содержимое списка.
	и в этом содержимом уже указываются места где надло искать логины
	пароли.
	места бывают:
		local - указывает что логин пароль искать в конфиге циски
		group - указывает что логин пароль искать на радиус сервере
		
	таким образом собираем всю шарманку вместе:
	
		aaa authentication login vpn_xauth_1 local
		
	vpn_xauth_1 local = список вместек с содержимым
	vpn_xauth_1 = название списка
	local = содержимое списка. конкретно означает ищи логины в конфиге
	
		aaa authentication login default local
	
	тоже самое что и предыдущее только название списка = default
	
		aaa authentication login default local
		aaa authentication login vpn_xauth_1 local
	
	а это тот случай когда на циске определено сразу два списка.
	а можно задать сто списков? можно хоть двести. 
	а зачем иметь на циско сто списков входа? а затем что 
	условно говоря можно тогда регулировать что например если заходищь
	через провод консольный или ssh то мол используй один список
	а если заходишт через vpn то используй другой список.
	
	например

		aaa authentication login default local
		aaa authentication login vpn_xauth_1 group R1 

	этот конфиг даст то что при заходе через провод консольный циска
	будет искать (использовать) логины из конфига. а если заходить через впн то будет искать логины на радиус сервере R1
	вот зачем можно иметь сто  списков на циске в конфиге.
	
	также. насколко я понял если мы собираемся описывать список default
	то его можно опускать в команде
	пример
	
		aaa authentication login local
		
	тоесть это одно и тоже с 
	
		aaa authentication login default local
		
	еще раз default это имя списка. а local это уже в каком месте искать
	логины пароли.
	
	такой тупизм потому что циско хранит содержимое списка в той же строке
	что и название списка.
	
	вопрос - а где прописано какой списко использовать когда мы входим по проводу а когда по впн. ответ: насколько я понял при входе по проводу используется всегда default список. а список который будет
	использоваться при входе по впн он указывается руками вот здесь
	
		crypto isakmp profile ike-profile-1
		match identity group remote-clients
		client authentication list vpn_xauth_1
		isakmp authorization list vpn_group_1
		client configuration address respond
		virtual-template 1
		radius
		
	таким макаром циска знает какой список ей использовать при входе по впн.


	мы поговорили про аутентифкацию. и мы сказали что 
	при входе через радиус на в строке authenticaion указать group имя_радиус группы
	
		aaa authentication login vpn_xauth_1 group R1 

	так вот для входу мало одной строки authentication у нас еще
	должна быть строка authorization ( аутентифкация говорит кто вошел, а авторизация говорит что ему можно делать )
	
	так вот для случая входа через радиус авторизация таого юзера обычно 
	идет не через радиус а локальная
	
		aaa authorization login vpn_xauth_1 local

	тоесть кто вошел циске подтверждает радиус сервер. а что ему делать
	циска решает локально сама. что интересно что при локальной авторизации и радиус аутентификации на самой циске в плане авторизации
	ничего прописывать ненадо. то есть мы с одной стороны сказале циске
	что вошедший пользователь облдаает правами которые ищи в локальной базе но в локальной базе ничего нет. однако вход все равно сработает.
	это прикол.
	в отличие от случая когда мы используем и локальную акутентификациб и локальнуюб авторизацию. тогда все понятно у нас в конфиге прописано
	
	username vasya privleige 15 0 пароль
	
	и для линии указано
	
	line vty 0 15
	authentication default
	authoriztion default
	
	чтото типа того. 
	
	и тут все понятно. юзер есть  ? есть. чтобы войти на линию 
	прописано что юзерам локальным можно входить. 
	уровенть привилегий в username относится уже к другому. вот ты вошел
	и как глубоко к командам имеешть доступ.
	
	
далее идут доп заметки про easyvpn.
значит оказалось что vpn это безумно сложная штука.
так что будут какието кусочки знания.



как я понимаю easyvpn онбазируется на ipsec,
какие там детали разницы непонятно,
позиционируется что easyvpn круче тем что на стороне клиента
надо делать меньше настроек чем в классическом ipsec(темныйлес),

IPSEC это толи целый стек протоколов. то ли это вообще концепция в целом
без конкретной реализации.

IKE(Internet Key Exchange) = ISAKMP + SKEME + OAKLEY

причем встретил в инете что цисковский IKE якобы состоит 
только из одного ISAKMP.

из того что прочитал на сайт ibm - когда ipsec пакет проходит nat
то с ним происходмт жопа так как nat подменяет src ip а внутри 
пакета ipsec шифрует все данные при отправлении пакета которые при 
получении можно проверить. и получается что как бутто пакет был злона
меренно изменен и приемник такой пакет отбрастывает. поэтому чтобы 
ipsec мог работать через NAT как я понял используют esp. 

????? здесь доложно быть какето описание ipsec воообще. как оно там работает.

IKE(Internet Key Exchange) якобы работает по порту UDP 500
AH неделает шифрования. но он удостоверяет достоверность пакета.
как я понял AH наверно упрощенно делает хэш из полного содержимого
ip пакета. поэтому никакая часть этого пакета неможет быть изменена.
иначе он уже недостоверный. поэтому AH неможет проходить через 
NAT.
ESP аналог AH.
как я понял AH неумеет шифровать. а умеет только удостоверять.
ESP умеет и шифровать и удостоверять пакет причем можно выбирать что 
будет включено то и другое или чтото одно.
возникет вопрос если esp умеет делать все что умеет AH нафиг нужен 
Ah. как я понял из инета если продавец железки хочет гарантировать 
что покупатель несможет шифровать а только удостоверять то 
он ему продаст реализацию на AH. типа относится к древним временам
и древним законам.
атак получается esp умеет делать все что умеет AH и даже больше.и все это можно выбирать и контролировать
как я понял AH добавляет типа хэша от содержимого пакета. а этот 
хэш зашифрован shared key. поэтому вторая сторона имеющая этот key дешифрует зашированный хэш и может сравнить подсунули ей оригинал
или подделку. злодей неможет подделать хэш потому что у него не шаред кей чтобы потом его зашифровать.
AH нам дает то что к нам прибывают достоверные данные но нет конфиденциальность. злодей неомжет подделать но может читать нашы данные.
как  я понял может одновременно применяться над пакетом и esp и ah.

прежде чем данные можно зашифровать и передать туда надо чтобы приемник
и передатчик имели друг о друге точную информацию : ключи которыми шифровать , адрес друг друга, метод шифрования. тоесть каждлый из сторон
должен иметь инфо о всех параметрах шифрованного сеанса связи.
это походуи и назвается у циско SA (security assosiations)

как я понял IKE хрень происхоодит в самом начале сеанса. 
и его задача безопасно и достоверно узнать обоим участникам обо всех 
параметрах сенаса связи который будет. передать друг другу SA.
типа это происходит через UDP 500.
как только мы обменялись SA мы можем начинать передавать шифрованный трафик друг другу.

в тунельном режиме ( есть два режима Ipsec тунельный и транспортный)
esp он берет весь ip пакет целиком и сверху на него наворачивает 
новый IP header (src_ip_new, dest_ip_new+ свое контрольное поле) а старый 
ip пакет полностью внутри вложен и зашифирован.
новый ip header имеет src_ip_new = ip нашего гейтвейя а des_ip_new= ip гейтвея
получателя

итак при esp в тунельном режиме будет  [старый ip пакет зашифрованный][esp header][src_ip_new,des_ip_new]

внутри пакета который зашифрован там обычно в качестве ip адресов
лежать ip адреса 19x.16x.*.* тоесть адреса интервала локальных сетей.
оно и логично потому что мы же через впн свядзываем две локалки
теперь становится понятна разница между ip внутри esp пакета и ip которые находятся в головном хидере.

AH в тунельном режиме делает с пакетом почти тоже самое.
он берет исходный ip пакет и сверху на него наворачтивает новый IP header
и свое Ah контрольное поле. чего он неделает это он нешифрует заинкапсилированный пакет. хотя и esp тоже этого может при желании неделать. итак вот как выглядит пакет после AH

[старый ip пакет НЕзашифрованный][ah header][src_ip_new,des_ip_new]


НО! что умеет делать AH чегонеумеет делать ESP. 
в контрольном поле [ah header] содержится инфо об головном IP хидере 
  [src_ip_new,des_ip_new]
 вот что умеет AH чего неумеет ESP.
 AH у нас умеет защищать в плане аутентичность нетолько исходный пакет
 но и новый головной хидер!
 
 получается что на самом деле вообще говоря ESP неумеет делать все 
 что умеет AH(как этообычно утверждается). ну и конечно AH не умеет делать все что умеет ESP.
 
 интересно а как тоода шифруется трафик если используется AH. кто это делает за него.
 
 что такое транспортный режим в отличие от туннельного наверно позже будет понятно. 
 
 также теперь понятно что в тунельном режиме может быть задейтстовван одновременно и ESP и AH протоколы. ESP шифрует и аутенфтифициурет 
 исхоный ip пакет из локалки. а AH к этому добавляет аутентифицирование
 головного хидера.
 
 что дает аутентифкация головного хидера. как я понимаю  злодей может слать
 мусор на наш гейтвей и это станет понятно только после того как мы расшифровали esp хэдер у пакета.
 а если используется AH то это становится понятно уже сразу при приеме 
 пакета. смотрим в головной AH хидер.расшифроваывем его. и понимаем коректный ли он. я так понимаю что злодей просто несможет сгенерировать 
 верный AH хэдер потому что унего нет шаред ключа. тоесть src ip и dest ip головного хэдера ему известны конечно. но AH хэдер он сгененироваь неможет. поэтому если мыполучаем пакет от злодея с ожидаемым src ip dest ip (гейт на той и нашей стороне) то у него небудет верного AH хэдера и мы сразу понимаем что этот пакет от злодея.
 тоесть какой внещний ip хидер ему посылать понятно . но как его "подписать" ему невозможно. потому мы понимаем что пакет прилетел 
 не от хорошего человека. сразу отсюда вылезает что esp можно использовать
 через NAT а AH нельзя. потому что как только AH пролетит через NAT нашего провайдера то у него сменится src_ip. и мы пуолчим несовпадение
 инфо о src_ip головного хидера с инфо о том же в AH хидере.
 и приемник сразу посчитает такой пакет подделанным.
 Тогда сразу стаовится неопнятнго а как же в реальных сетях интернета 
 можно использовать AH.
 видимо станет понятно дальше
 
 дальше важно понять что как я понял есть 
 isakmp SA
 а есть 
 IPSEC SA
 
щас мы разберем
при установке vpn 
 есть фаза 1. на ее стадии рутеры обмениваются isakmp SA.
 как я понял отсюда) (https://www.youtube.com/watch?v=rwu8__GG_rw&ab_channel=RyanLindfield
 
 isakmp sa - это параметры шифрованной связи для организации канала
 котоырй относится не к каналу шифрованной связи по которому пойдут 
 данные от клиента. это шифрованный канал связи для между самих рутеров
 по которрому они будут обмениваться данными друг с другом о состоянии 
 и здоровье шифрованного канала по которым уже гонятся данные клиента.
 
 тоесть как бы вначале организуется управляющий канал. а потом
 уже будет оргаизован уже следуюший канал по которму погонятся данные.
 а в управляющем канале рутеры друг другу сооббщают служебную 
 информацию о состоянии главного канала.
 
 тоест как бы организщуется два канала: mgmt, data.
 оба криптованные. но разного назначения. по дата каналу гонятся 
 данные пользователся. по mgmt каналу рутеры друг с другом
 обмениваются инфо о состоянии этого дата канала.
 и соотсвтевенно параметры шифрования - SA они разные у mgmt и data
 каналов.
 
 фаза1 - это обмен isakmp sa. который для mgmt канал организации предназначен. фаза 1 в циско обозначается как policy
 а фаза2 как transform-set или еще profile
 
 вобще все логично. на первой стаиии рутерам надо друг с другом
 наладить безопасный канал связи по которому уже после этого они могут 
 договориться и передать параметры ключи о том как же они будут шифровать
 пользовательские данные. поскольку на стадии фаза 1 очень важно чтобы
 злодей не смог ничего подменить и данных надо пеерредавать мало то как я понимаю фаза 1 идет через ассиметричное шифрование. оно сильное
 но хорошо подходит только для малых обьемов передаваемых данных.
 
 
видно что для easyvpn используется два порта 
500 UDP 
4500 UDP

далее в том видео говорятчто isakmp SA он один на оба конца соединения. а ipsec SA их два. isakmp sa действует в обе стороны
	а ipsec sa действует в одну сторону.
	
	что вдруг дальше важно понять. зашифраоныее дата пакеты летят в сеть 
	в виде [ip header][esp header][esp payaload]. это значит что никаких 
	udp\tcp в нем нет. опа!
	
	так вот если у нас на WAТ интерфейсе есть акссес-лист на входящий трафик то получается что надо разрешить прохождение ESP трафика.
	так вот странно что я его неразрешал а eazyvpn у меня по факту работает.
	
	вот WAN интерфейс 
	interface FastEthernet0
    ip access-group wan-in-acl-ver2 in

	и его аксеесс-лист
	
	Extended IP access list wan-in-acl-ver2
    permit udp any any eq isakmp (103 matches)
    permit udp any any eq non500-isakmp (2 matches)
    deny ip any any (3722 matches)

	как видно ESP недолжен быть пропущен входящий. однако работает. 
	????? пока непонятно.
	
	ясно другое. как я понял в esp там нет портов как в udp\tcp
	но там есть spi. как я понял для каждого соединения междуц сервер 
	клиент в esp записыватся видимо два spi. один идентифицирует 
	хост на нашей стороне а другойхост на той стороне. имеется ввиду
	гейтвеи.
	spi можно видеть в wireshark.
	как я понял циско смотрит в spi приходящего пакета и сразу понимает
	через какой набор правил его расшифровывать.
	
	получается чтобы vpn ipsec easyvpn заработаал надо чтобы вначале
	прошла 1 фаза  , потом 2 фаза.
	
	для того чтобы понять что 1 фаза прошла смотрим
	
	#sh crypto isakmp sa
		IPv4 Crypto ISAKMP SA
		dst             src             state          conn-id status
		85.85.85.114    85.85.85.113    QM_IDLE           2006 ACTIVE

	на второй фазе вот это должно быть в порядке:
	#sh crypto ipsec sa
	там целая портянка вылезает
	
	из того что япрочитал ранее следует что при отправке в интернет
	пакет выглядит как
	
	[исходный ip пакет зашифрован][esp header][новый ip header]
	
	причем esp header никак не описывает новый ip header.
	таким образом я невижу проблемы прохождение пакета через NAT.
	да NAT будет колбасить [новый ip header] и когда он прибует 
	на тот гейтвей то он будет другой. но esp header это никак не 
	описывает так что по мне все должно быть хорошо. 
	однако у циско я читаю что нет. мол это плохо. при исполтьзовании
	esp нельзя менять заголовок нового ip header. в чем проблема я не понял. это же не AH. который да в своем заголовке описывает параметры нового ip hader. ладно. так вот циско пишет что это нарешать. как они решают. как я понял то ли в esp то ли в внутри 
	там на стадии устанвления соденияенеия но циско шифрует 
	где то там в кишках пакета ip адрес отправителя и получается имеются ввтиду именно параметры  [новый ip header] - там где указаны адреса
	гейтвеев на той и другой сторне.  в общем передают на ту сторону. и там сверяют с тем что в итоге пришо. и таким макаром короче определяют есть ли между двумя гейтвейями NAT. передача происходит через udp порт 500. по какому протоколу пока незнаю.
	так вот. если нат есть то циска автоматом без всякой доп настройки со стороны пользователя активирует фичу под названием NAT-T (nat traversal). это значит то что после этого передача начинает идти 
	через порт 4500 по протоколу UDP.
	
	и как же выглядит пакет
	
	[исходный ip пакет зашифрован][esp header][новый ip header][UDP header][[superновый ip header]
	
	таким образом когда данный пакет летит по интернету и проходит через 
	nat то изменяется  у него только вот эта часть [UDP header][[superновый ip header]
	осталная же часть неменяется. поэтому на гейтвей принимающий в его кишки неизменной доходит вот эта часть 
	
	[исходный ip пакет зашифрован][esp header][новый ip header]
	
	чего собственно циско и хотела добиться.
	
	хотя по мне это надо делать только в случае Ah протокла.
	anyway. 
	
	зато стало известно что NAT-T конфигурировать никак ненадо. это авто
	функция. если между концами тонеля есть nat то нужно обязательно
	на цисках открывать и 500 UDP и 4500 UDP.
	таже сталопонятно почему ненужно на WAN интерфейсе 
	на его in acl разрешать ESP протокол. потому что никакой esp  в него влетать небдует. в него из за доп инкапсуляции esp в udp будет 
	влетаь иключательно UDP трафик.
	
	таким образром я постулирую что для easyvpn на фарйволле
	надо открывать порты и протоколы только:
	 - 500 UDP
	 - 4500 UDP
	 
	 никакие esp , ah на нем разрешать ненадо. абсолютно.
	 
	 остатется проясниить как же все таки фазы происходят и 
	 как это настройками настраивается.
	 


============
казус циско.
накатываение конфига.
облом.

была 1811 с ios 12 - сломалась.
купили такую же но с ios 15.
накатил на нее конфиг. а она почему то вобще непингует 
ни один свой ip.

пришлось руками перебивать конфиг строчка по строчке
через терминал.

тогда только все сработало. 
может без вот это хрени которая появилась на новой циско

license udi pid CISCO1811W-AG-A/K9 sn FTX0946Z06C 

циско и неработала.

еще после загрузки конфига на новую циско нужно перегенерировать
rsa ключи

# crypto key generate rsa

иначе ssh доступ небудет работать


полезная команда показывает способность шифровать железки

#sh crypto eli
Hardware Encryption : ACTIVE
 Number of hardware crypto engines = 1

 CryptoEngine Onboard VPN details: state = Active
 Capability    : IPPCP, DES, 3DES, AES, IPv6, GDOI, FAILCLOSE

 IPSec-Session :     2 active,   300 max, 0 failed

далее нашел у циско такое

Cisco no longer recommends using DES, 3DES, MD5 (including HMAC variant), and Diffie-Hellman (DH) groups 1, 2 and 5; instead, you should use AES, SHA and DH Groups 14 or higher. For more information about the latest Cisco cryptographic recommendations, see the Next Generation Encryption (NGE) white paper.

des, 3des - это симметричное шифрование
диффи-хельман - это несимметричное шифрование

в плане дифи-хельмана циско рекомендует у него юзать Cisco recommends using 2048-bit or larger DH key exchange, or ECDH key exchange.

( фаза 1 бывает main и aggressive поканепонятна разница)

по крайней мере теперь стало понятно что вот этти строчки


crypto isakmp policy 10
 encr aes
 authentication pre-share
 group 14

отвечают за параметры Phase 1.

когда я задал такие параметры в циско и подключился к впн,
то про фазу 1 можно посмотреть на циске вот что

#sh crypto isakmp sa detail

C-id  Local           Remote          I-VRF    Status Encr Hash Auth DH

2009  85.85.85.114    85.85.85.113             ACTIVE aes  sha        14


сотвесвтенно в статистике нациско видно что 
впн между двумя точками идет по aes + sha + DH 14 (дифи-хельман) 




ipsec может:
 - шифровать даныные
 - запрету их менять
 - подтвредить что они пришли именно от васи
 - запрет на повтор пакетов

дальше походу я нашел у циско как у нее работает ipsec
когда не случай клиент-циско а когда между двумя рутерами.
тоесть когда заранее известны IP обоих сторон.
 
 ipsec - устанаваливает тонель между двумя точками.
 

мы создаем аксес лист. в которо проставляем src ip dest ip 
и также можно ряд layer 4 опций. 

и накатыаваем это аксесс лист на WAN интерфейс через крипто-мап.

таким макаром когда идет пакет от 192.168.1.1 на 192.168.5.1 
и на основе таблица маршрутизации он летит на WAN интерфейс то 
попав в аксес лист криптомапа на интерфейсе циска понимает что 
данный пакет надо непросто там через NAT выполунуть в интернет 
а надо криптовать в туннель IPSEC

остановился на том что через криптом -мап можно между 
двумя рутерами поднять ipsec vpn. надо посавтьи gns3
и сделать. после этого надо в  офисе делать. в плане крипто-мап
применеия в случае некогда мы делаем рутер - ту рутер впн
а для полтьзователей например можно подсмотреть ниже 
в случае l2tp\ipsec








=============	
	
L2TP

одна из самых главных подстав этого впн в том что если сервер
стоит за NAT в локалке то вы получите огромные проблемы с тем что
клиенты будут иметь огромные проблемы подключиться к нему.
надо будет много всего руками допиливать. поэтому лучше 
сервер чтобы стоят напрямуб смотрел в интернет.


данный vpn имеет целую кучу подлянок и подьебок.


одна из: если поставить L2TP\IPSEC  в локалке
и через гейтвей пробросить наружу то виндовс клиент сука
он по дефолту неможет подключиться к такому впн.
чтобы виндовс клиент смог подключиться к таокму впн 
нужно на виндовсе в реестер внести ключ

HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\PolicyAgent
AssumeUDPEncapsulationContextOnSendRule = 2 (тип dword32)

нашел в этой ссылке - https://docs.microsoft.com/ru-ru/troubleshoot/windows-server/networking/configure-l2tp-ipsec-server-behind-nat-t-device

и перезагрузитьь виндовс.

поэтому лучше чтобы l2tp\ipsec сервер был выставлен непосредственн
в интернет напрямую чтобынепришлось мудить с настройками на клиентах.


терминология l2tp
LAC - это client
LNS - это server

еще подьебка:
окзаалось ! если мы в l2tp юзаем локальную базу логинов
паролей то пароль юзера нельзя чтобы содержал  символы !@#$...
при попытке залогтиниться под таким юзером виндовс будет писать что 
the remote connection was denied because the user name and 
password и дальге чтотио там про неверный логин и пароль или неверный протокол.

это решение нашел здесь - https://community.cisco.com/t5/small-business-routers/pptp-not-recognzing-accounts-in-local-database-rv340/td-p/3052636/page/2


кусок конфига отвечающий за l2tp\ipsec который 
реально работает.
аутентифкикация из локальной базы.
конфиг сделан через крипто-мап. это хорошо потому что с криптомаапами
можно на циско совмещать сразу несолько видов впн серверов.


!

aaa authentication ppp VPDN_AUTH local


vpdn enable

!

vpdn-group L2TP

! Default L2TP VPDN group

accept-dialin

protocol l2tp

virtual-template 1

no l2tp tunnel authentication

!

!

!

username cisco privilege 15 password 0 cisco

!

!

crypto isakmp policy 1

encr 3des

hash sha

authentication pre-share

group 2

lifetime 86400

!

!

crypto isakmp key cisco123 address 0.0.0.0 0.0.0.0

!

!

crypto ipsec transform-set L2TP-Set2 esp-3des esp-sha-hmac

mode transport

!

crypto dynamic-map dyn-map 10

set nat demux

set transform-set L2TP-Set2 L2TP-Set

!

!

crypto map outside_map 65535 ipsec-isakmp dynamic dyn-map

!

!

!

interface Loopback0

ip address 192.168.47.1 255.255.255.0

ip nat inside

ip virtual-reassembly

!

interface Loopback1

description loopback for IPsec-pool

ip address 1.1.1.11 255.255.255.255

!

interface FastEthernet0/0

ip address 47.47.47.2 255.255.255.0

ip nat outside

ip virtual-reassembly

duplex auto

speed auto

crypto map outside_map

!

!

interface Virtual-Template1

ip unnumbered Loopback1

peer default ip address pool l2tp-pool

ppp authentication ms-chap-v2 VPDN_AUTH

!

!

!

ip local pool l2tp-pool 1.1.1.1 1.1.1.10

ip route 0.0.0.0 0.0.0.0 47.47.47.1

!

ip nat inside source list NAT interface FastEthernet0/0 overload

!

ip access-list extended NAT

deny ip 192.168.47.0 0.0.0.255 1.1.1.0 0.0.0.255

permit ip 192.167.47.0 0.0.0.255 any

!

!

конфиг взят отсюда - https://khomenko.org/?p=468

как видно в конфиге укаазано два трансформ сета. хотя в конфиге 
только один 

crypto dynamic-map dyn-map 10
set nat demux
set transform-set L2TP-Set2 L2TP-Set

так что можно изменить на 
crypto dynamic-map dyn-map 10
set nat demux
set transform-set L2TP-Set2




далее я привожу дополнительно живой конфиг с рабочей системы.
кусок который отвечает за ipssec часть. как бы он повторяет то что
написано выше 

crypto isakmp policy 1
 encr 3des
 authentication pre-share
 group 2

crypto isakmp key КЛЮЧ address 0.0.0.0 0.0.0.0


crypto ipsec transform-set L2TP-Set2 esp-3des esp-sha-hmac
 mode transport


crypto dynamic-map dyn-map 10
 set nat demux
 set transform-set L2TP-Set2


crypto map outside_map 65535 ipsec-isakmp dynamic dyn-map

int fa0
 crypto map outside_map





еще подьебка:
оказалось что данный конфиг неполучится вбиить в
ios версии  12.4(24)T3 а а получится только в версии Version 15.1(2)T1

потому что в версии ios 12.4(24)T3 нет вот этих вот команд

peer default ip address pool l2tp-pool

ppp authentication ms-chap-v2 VPDN_AUTH

в режиме интерфейса interface Virtual-Template1

они там просто отсутствуют.

далее.
итак возможно два случая. l2tip\ipsec сервер сидит глядит напрямую 
в интернет или он установлен в локальной сети и выходит 
в интернет через nat. это две кардинально разные ситуации.


L2TP\IPSEC СМОТРИТТ НАПРЯМУЮ В ИНТЕРНЕТ.
какие же порты и протоколы нужно разрешить на WAN интерфейсе
если на него навешен acl in. в инете куча брехни на этот счет.
я проверил на практике достаточно открыть вот это

Extended IP access list wan-in-acl-ver2
    10 
    20 permit udp any host 5.16.1.110 eq isakmp
    30 permit udp any host 5.16.1.110 eq non500-isakmp
    40 deny ip any any

тоесть 

UDP 500
UDP 4500

все!
никаких ESP, Ah ненужно.
никакой 1701 UDP тоже ненужен !
это проверено неоднократно на практике. 
когда сервер стоит напрямую в инет то этого достаточно.
единственное что может быть еще понодобится добавить это 
вот такое правило

 permit udp any range 1 1023 any gt 1023


также! - когда l2tp\ipsec от циско смотрит прямо в интернет.
то на виндовсе (который клиент) никаких доп настроек в реестре с ключом  AssumeUDPEncapsulationContextOnSendRule делать ненужно!




L2TP\IPSEC СЕРВЕР СИДИТ В LAN И ВЫХОДИТ В ИНЕТ ЧЕРЕЗ NAT
тогда на гейтвее надо пробросить порты

500 UDP
4500 UDP
1701 UDP

я проверил они все реально нужны. так как где то писали что 1701 ненужен.
хуйня и брехня.

при таких проброшенных портах точно все работает я проверял.

единственное добавлю что случай когда l2tp\ipsec сидит в LAN  я тестировал
на примере когда vpn сервер сделан на ubuntu а не нациско.
может быть если бы l2tp\ipsec сервер был сделан на циско портов нужно
было бы меньше. незнаю

и самая главная жопа ( повторю ) что если впн сервер сидит в локалке
то клиент на виндлвсе по дефолту к такому сервер НЕ СМОЖЕТ подключиться.
нужно править реестр на клиенте.
надо в реесте вбивать

HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\PolicyAgent
AssumeUDPEncapsulationContextOnSendRule = 2 (тип dword32)

и перегружать виндовс.


все.
далее детали.

коода мы подкючлились. товот  как выглядят полезные строчки


#sh crypto isakmp sa detail

C-id  Local           Remote          I-VRF    Status Encr Hash Auth DH

2001  5.16.1.5  3.3.3.10                 ACTIVE 3des sha  psk  2  


это указвыает что фаза 1 прошла успешно.

как удалить фазу 1.

# clear crypto isakmp 2001

как увидеть детали фазы 2 успешной

#sh crypto ipsec sa

interface: FastEthernet0
    Crypto map tag: outside_map, local addr 5.16.1.15

   protected vrf: (none)
   local  ident (addr/mask/prot/port): (5.16.1.5/255.255.255.255/17/1701)
   remote ident (addr/mask/prot/port): (3.3.3.10/255.255.255.255/17/4500)
   current_peer 3.3.3.10 port 4500
     PERMIT, flags={}
    #pkts encaps: 571, #pkts encrypt: 571, #pkts digest: 571
    #pkts decaps: 820, #pkts decrypt: 820, #pkts verify: 820
    #pkts compressed: 0, #pkts decompressed: 0
    #pkts not compressed: 0, #pkts compr. failed: 0
    #pkts not decompressed: 0, #pkts decompress failed: 0
    #send errors 0, #recv errors 0
   Translating: Inside Remote Port 4500 Outside Remote Port 1701

     local crypto endpt.: 5.16.1.5, remote crypto endpt.: 3.3.3.10
     path mtu 1500, ip mtu 1500, ip mtu idb FastEthernet0
     current outbound spi: 0x72F16DEE(1928424942)
     PFS (Y/N): N, DH group: none

     inbound esp sas:
      spi: 0xD546D73C(3578189628)
        transform: esp-3des esp-sha-hmac ,
        in use settings ={Transport UDP-Encaps, }
        conn id: 1, flow_id: Onboard VPN:1, sibling_flags 80000006, crypto map: outside_map
        sa timing: remaining key lifetime (k/sec): (239644/3039)
        IV size: 8 bytes
        replay detection support: Y
        Status: ACTIVE

     inbound ah sas:

     inbound pcp sas:

     outbound esp sas:
      spi: 0x72F16DEE(1928424942)
        transform: esp-3des esp-sha-hmac ,
        in use settings ={Transport UDP-Encaps, }
        conn id: 2, flow_id: Onboard VPN:2, sibling_flags 80000006, crypto map: outside_map
        sa timing: remaining key lifetime (k/sec): (239682/3039)
        IV size: 8 bytes
        replay detection support: Y
        Status: ACTIVE

     outbound ah sas:

     outbound pcp sas:



итак самая важная фигня во всей это истории в том что в зависимости от того сервер сидит за натом
или напряую в интернет  то от этого зависит надо ли на клиенте виднвс
делать правки и какие порты\протоколы открывать на WAN интерфейсе  либо пробрасывать через NAT.






===
как на 1811 
протесировачть что аутентификация через радиус серер 
идет успешно.  в плане того что между циско и виндовс радиусом
на первый взгляд все настроено верно

#test aaa group radius server 172.16.101.2 auth-port 1812 acct-port 1813 test@mk.local 1qaz2wsx legacy
Attempting authentication test to server-group radius using radius
User was successfully authenticated.





=======
про память RAM 
в циско.


как я понял из экспериментов 
циско свич он может использовать столько памяти сколько у него
прописано в boostrap или ROMMON я точно непонимаю есть ли между
ними разница.

главная суть в том что если просто добавить оперативки в циско
то опять же как я понял он ее небудет всю использовать
а только тот обьем который у него прописан в ROMMON.

как я понял этот обьем захардкожен в каждой конретной версии ROMMON.
то есть руками его изменить нельзя. 
надо искать соотвествующую версию ROMMON.

также как я понял взавсимости сколько RAM прописано в ROMMON столько 
фич в IOS будет активировано.

скажем если RAM прописан как 128МБ то в виртуал темплейт там не будет 
опций peer, поэтому про l2tp\ipsec сервер можно забыть.

а вот когда 256 MB прописано в в ROMMON то уже оно появляется.
версия ios одна и таже.


вот пример 

на циско в ROMMON прописано 256МБ.

версия rommon такая = ROM: System Bootstrap, Version 12.3(8r)YH13, RELEASE SOFTWARE (fc1)

это всегда можно увидеть через 

# sh ver


Cisco 1811W (MPC8500) processor (revision 0x400) with 236544K/25600K bytes of memory.
Processor board ID FHK132471YR, with hardware revision 0000

ROM: System Bootstrap, Version 12.3(8r)YH13, RELEASE SOFTWARE (fc1)


но по факту внутри стоит планка на 128МБ.
соотвсвтенно еще раз становится понятно что sh ver непоказыает солько 
реально памяти стоит в циске. оно показывает сколтько памяти МАКСИМАЛЬНО
можно засунуть в нее.

а чтобы узнать сколько памяти реально стоит в циске надо смотреть в 
# sh memory

office-cisco1811-01# sh memory
                Head    Total(b)    
Processor   84099958   174483112    

отсюда и видно что в циске стоит планка 128МБ. я так понял что 64МБ 
это впаянная встроенаая в мат плату память.

так как реально вскрытие корпуска показыает что стоит планка 128МБ.


а вот еще пример друная циско.

в ней стоит другой роммон.
в нем прописано 512МБ.
и  в ней реально стоит планка 512МБ

cisco-msk-11b#sh ver
Cisco IOS Software, C181X Software (C181X-ADVENTERPRISEK9-M), Version 12.4(24)T3, RELEASE SOFTWARE (fc2)

Cisco 1811W (MPC8500) processor (revision 0x400) with 589824K/65536K bytes of memory.
Processor board ID FHK104410J2, with hardware revision 0000


#sh memory
                Head    Total(b)   
Processor   84099958   536241832 

итак важно понять то что не так то просто сходу понять скоьбко памяти стоит внутри железки.

также понимать что макс обьем который она может юзать зависит не от планки
а от версии ROMMON.

в зависимости от памяти циско активирует фичи IOS.


============
походу пьесы в терминах циско

compact flash карта которая у него проходит как flash:
она же в его терминах является NVRAM

compact flash = flash: = NVRAM

=====

походу конфиг из файла лучше ненакатывать в startrup-config
как то оно плохо срастаетеся.
лучше накатывать из файла вначале в running-conf
а уже после этого делать 

# wr

чтобы он стал startup-conf 

====

access list in для WAN интерфейса.

как он выглядит


interface FastEthernet0
 ip access-group wan-in-acl-ver2 in



потому что циско он автоматом обратные пакеты непускает.
поэтому чтото надо прописывать все равно на аксеесс листе.



# sh ip access-lists wan-in-acl-ver2
Extended IP access list wan-in-acl-ver2
    50 deny ip 127.0.0.0 0.255.255.255 any
    60 deny ip host 255.255.255.255 any
    70 deny ip host 0.0.0.0 any
    80 deny ip 10.0.0.0 0.255.255.255 any
    90 deny ip 172.16.0.0 0.15.255.255 any
    100 deny ip 192.168.0.0 0.0.255.255 any
    110 permit icmp any any echo (126 matches)
    120 permit icmp any any echo-reply
    130 permit icmp any any unreachable (19 matches)
    140 permit icmp any any time-exceeded
    150 deny icmp any any
    160 permit tcp any any established (5376 matches)
    170 permit udp any eq domain any gt 1023 (88 matches)
    180 permit udp any range 1 1023 any gt 1023 (1536 matches)
    190 deny udp any any eq domain
    200 deny tcp any any eq domain
    210 permit udp any any eq isakmp (2 matches)
    220 permit udp any any eq non500-isakmp (1710 matches)
    230 deny tcp any any eq 22 (2 matches)
    500 deny ip any any (253 matches)

===============
походу пьемы

l2tp\ipsec

вначлае устанавливектся ipsec канал
через preshared key + лгин пароль 

то что для установки ipsed канала нужен еще и логин проаль
говорит вот эжта строка

crypto isakmp key КЛЮЧ address 0.0.0.0 0.0.0.0

еслиы бы было достаочно нам толкь прешаред кей то на конце было бы
no-xauth

crypto isakmp key КЛЮЧ address 0.0.0.0 0.0.0.0 no-xauth

а так как этого нет тоо циске считает что еще должен быт бь
логин и парль.

xauth по пнятимциско это логин\пароль аутентификация.

когда ipsec канал устанолвен то поервхе него 
устанвлаиется l2ytp канадл уэже без всязки
 
 ==
 если в в циско для ipsec фаза 1 был примене профиль то 
 будлет это видно
 
 office-cisco1811-01# sh crypto isakmp sa
IPv4 Crypto ISAKMP SA
dst             src             state          conn-id status
5.16.1.4  178.176.77.58   MM_NO_STATE       2012 ACTIVE (deleted) ike-profile-1


если названия профиля невидно ike-profile-1 то значтит он не применятеся
на стадии фазы1 и значит идут какито дефолтовые астройки.!!!
===

можно иметь нЕСКОЛЬКО ключей.

оддин дефолтовый 

crypto isakmp key 123456! address 0.0.0.0 0.0.0.0

а второй указать в профиле

crypto isakmp client configuration group remote-clients
 key megakey123
 dns 172.17.101.2
 domain mk.local
 pool POOL_1
 acl izi2


и они она будут существоать однровременно.

первый скжаем для l2tp\psec сервера
а второй для изивпн сервера 

====
изивпн 
замечу что трансформ сет исопльзщуется в реэиме тунеля

crypto ipsec transform-set transform-1 esp-3des esp-sha-hmac

а вот l2tp\ipsec траснфор сеть исплтзуется вреэжиме трансопорта

crypto ipsec transform-set L2TP-Set2 esp-3des esp-sha-hmac
 mode transport
 
 хотя оба предназчанены для динамического vpn 
 когда незивестено адрес той стороны
 
 ====
 импеем l2tp\ipsec на роут мапе
 потом доавбиили eayvpn на virtual template.
 
 оно заработало да щее на своем собсвтвенном прешаред кей.
 
 потом была проблема что неблоы пинов в сети офиса.
 
 как решил - во певвырх надо пиговат настройчиво с ключм 
 ping -t 
 потому что пинги завоодятся не сраз унемгновенно.
 
 во вторых если в шрьюб добавил марршрут руками в лан сеть 
 то лучше полностью закоыть \открыть шрью и проверить что этот мрраршнут там ест.
 
 шрьб как я все таки понл ненадо запускать под правами админа 
 на компе . ему хватит и так прав добавить марщшрутт в таблицк
 маршрутиазациии.
 
 самая главня проблема режима изивпн через virtual templatre 
 это то что на клиенте надо на кажом руками вбивать лоальные сети офиса.
 автомтом он их не подсамсывать на клиент.
 
 для этого нужен reverse-roue который в динамик мап исопльзутеся!!

так что связка l2top\iupsec + easyvpn заработала. 
но малополщезна.
маршурты на клиетах руками писать это отсоой

 в общем после прорписывания маршрпутам на шрью надо закрыть отикрыть клиент.
 
 
 и потом еще пинги то выклюто вклю и оно еле еле вроде начинает наконец 
 пинговать. 
 
 
 
 ====
 одна из ваных вещей
 изивпн в ерэжиме VTI трансфорсм сет идет в ржеиме тунеля
 извпн в ерэжимер роут ман трансфор сет идет в реэжиме трнасопортата
 
 !!!
 
 
 ==
 
 izivpn 
 если юзааем reverse-route
 но марщшрут на клмпе юезра непоявлсят.
  
  значит 100% неавильно оформлен сам acl в нем ошибка.
  
  acl который пропсан вот тут
  
  crypto isakmp client configuration group remote-clients
 key megakey123
 dns 192.168.1.10
 domain domain.local
 split-dns domain.local
 pool POOL_1
 acl 100
 
 100000% что ошибк аименно в acl 100
 
 например неверно написене обраная маска
 
 office-cisco1811-01#sh ip access-lists izi2
Extended IP access list izi2
    20 permit ip 172.16.0.0 0.0.255.25 any
	
	на конце всесто 255 проставлено 25.
	
!!!!! очень важная тема

воможно изза этого в изи впн + vti мррущгур не подсавыаться
====
shrew 
клиент рабтает только через агресивный режим.
незнаю в чем прикол. но только так.
	
=====

кофигурация для 
site-to-site
тонеля между двумя рутерами у которых есть белый IP

crypto isakmp policy 1
 encr 3des
 authentication pre-share
 group 2

crypto isakmp key v123 address 1.177.1.2 no-xauth

crypto ipsec transform-set office-m9 esp-aes esp-md5-hmac
 mode transport

crypto ipsec profile m9
 set transform-set office-m9

interface Tunnel0
 ip address 10.2.2.1 255.255.255.0
 tunnel source 5.16.1.4
 tunnel destination 1.177.1.2
 tunnel mode ipsec ipv4
 tunnel protection ipsec profile m9
 
 
 ====
 
 оказлось что easyvpn невхлодид через радиус AD потому что
 либо на циске либо на радиуесе было сломан вход.
 
 оказалось что даже неработал входв в консолль циски через радиус
 (котоыйр был сделан ранее).
 
 поэтому как толоько непонятный усилиями я оратно починил вход 
 в консоь циски через радиуес. тот тут же заработал вход в изи впн
 через радиус!!!
 
 поэтому если нербтает вход в идзи впн через радиус то
 первым делао надо попробвать настроить или если уже ранее
 было настрено то проверить вход в консоль через радиус.
 
 скорей всего вход в косноь тоже небдуте работат. так что
 ндадо это чинить то гда и вход в изи впн заработате через радис3с
 
 ==============
 если перклюыиться с одного впн на другой
 то вход на только вхожденный компьюер рдп будет невозможнен.
 
 я так понимаю что это изаа mac адресов  на лклаьном компе.
 

 
  172.16.101.10         bb-bb-bb-bb-bb-00     dynamic
 172.16.101.20         bb-bb-bb-bb-bb-00     dynamic
 
 лчение
 
 > ipconfig /flushdns
 
 на локлаьном компе
 
 ===
 когда впн полюключил то
 надо пинги запускать сразу моного чрез ключ -t
 
 ping -t LAN_IP
 
 потому что впн между офисами по впн она просирвается несразу.
 вначале куча пингов никак неможет начаться.
 
 поэтому большая ошимбка запустить один пинг 
 он непройдет и думать что впн нерабоатет
 
 нет !!!! надо просто запусттиь 20 пингов. и только с 10 пинга впн канал
 просрется.
 
 я на этом реаллно  пострадал.
 
 
 ===
 поленые команды
 
 как вычелнить из всего конфига только то что к шифрованию относися
 
 cisco-msk-11b#sh run | sec crypto

===
gre tunnerk via ipsec поднялся
но пинги непроохродили
причина как я шас понимаю в том что 
на WAN интерефейсе на его acl нужно разрешать протокол GRE
а у меня он был запрещшен

 кстати я пока так и неопнял сколько раз покет проходит WAN acl
типа точно первый раз перед расшифровкой. и 
вроде на старых ios второй раз после расшировки. а щас мол только один 
раз. надо уточнять. насколкьо я понимаю щас из практики что на 12.4.24
один раз. пперед расшифровокой
 
==

ipsec tunnel
надо чтобы на обих концах были разные сети

offis-A

Lo1
10.17,17.1


offis-B
10.18.18.1

нельзя чтобы в одной сети силеи
потому что тогда покеты никак в WAN интерфейс непролетяи

====

писали что на страых ios для например gre+ipsec пакета
acl на wan интерфейсе пробегался два раза.
пперед расшифровкой и после.

в новых ios якобы только 1 раз.

====

acl для ip потока

esp на ACL WAN нужен!

анализ какой vpn какой режим транспорт\туннель юзает для трансформ-сет ?

==
ipsec main mode vs aggressive mode ?

===
 
 
 l2tp\ipsec + eazyvpn + static site-to-site
 
 office-cisco1811-01#sh run | sec crypto
crypto isakmp policy 1
 encr 3des
 authentication pre-share
 group 2
crypto isakmp key v123 address 1.177.1.2 no-xauth
crypto isakmp key Big123456! address 0.0.0.0 0.0.0.0
crypto isakmp keepalive 10 periodic
crypto isakmp client configuration group office-remote-users
 key 117
 dns 172.16.101.2 172.16.101.7
 domain mk.local
 pool POOL_1
 acl izi2
 split-dns mk.local
crypto isakmp profile ike-profile-1
   match identity group office-remote-users
   client authentication list easyvpn
   isakmp authorization list easyvpn
   client configuration address respond
crypto ipsec transform-set L2TP-Set2 esp-3des esp-sha-hmac
 mode transport
crypto ipsec transform-set transform-1 esp-3des esp-sha-hmac
 mode transport
crypto ipsec transform-set office-m9 esp-3des esp-md5-hmac
crypto ipsec profile Cisco_Profile1
 set transform-set transform-1
 set isakmp-profile ike-profile-1
crypto ipsec profile m9
 set transform-set office-m9
crypto dynamic-map dyn-map 10
 set nat demux
 set transform-set L2TP-Set2
crypto dynamic-map vasya 10
 set transform-set transform-1
 set isakmp-profile ike-profile-1
 reverse-route
crypto map outside_map 1000 ipsec-isakmp
 set peer 1.177.1.2
 set transform-set office-m9
 match address office-m9-acl
crypto map outside_map 10000 ipsec-isakmp dynamic vasya
crypto map outside_map 65535 ipsec-isakmp dynamic dyn-map
 crypto map outside_map
office-cisco1811-01#

====

ipsec site-to-site

какая выяснилась тонксоть.
во первых трансформ сет должен быть использован в режиме
тоннель а не транспорт !!

оказалось что если transform set использщуется в режиме
тоннель  то на WAN интерфейсе обязательно нужно разрешить
ESP протокол на вхождение !!!

(ну и AH если мы его используем что врятли)

ну и то что чтобы пакеты ходили в тонеле  надо чтобы на обоих сторонах
была разная сеть. 

тоесть на одном рутере

loopback 0
ip address 10.17.17.1

на втором рутере

loopback 0
ip address 10.18.18.1


и тогда когда мы с 10.17.17.1 будем пинговать 10.18.18.1
то пакет по деолфтному руту будет поппадать на WAN интерфейс рутера
и тогда его подхвается криптом мап и пихает в тонель

а я вначале пытался завести систему такую когда


 на одном рутере

loopback 0
ip address 10.17.17.1

на втором рутере

loopback 0
ip address 10.17.17.2


соотсвтенно когда мы нап перовм рутере будем с 10.17.17.1 пинговать 10.17.17.2

то ничего не вйдет .потому что со=гласно таблице маршрутиазации 
пакет никогда непопадет на WAN инетерфейс на котором криптом мап установлен. и ничего рабоатать небудет

!!!!


конфиг site-to-site ipsec 


crypto isakmp policy 1
 encr 3des
 authentication pre-share
 group 2
 
crypto isakmp key v123 address 23.23.23.23  no-xauth
crypto isakmp keepalive 10 periodic

\23.23.23.23 = wan ip рутера на той стороне\

crypto ipsec transform-set office-m9-transform-set esp-3des esp-md5-hmac

\трансформ сет устновлен в режим тоннель\

crypto map outside_map 1000 ipsec-isakmp
 set peer 23.23.23.23
 set transform-set office-m9-transform-set
 match address acl-ipsec-m9-to-office


Extended IP access list acl-ipsec-m9-to-office
    10 permit ip host 10.17.17.1 host 10.18.18.1 
	
\ 10.17.17.1 = это адрес локалки на нашей стороне\
\ 10.18.18.1 = это адрес локалки на той стоороне \
\ чем меньше номер у криптом мап тем он обрабатвыается циско первее \
\23.23.23.23 = wan ip рутера на той стороне\

Extended IP access list nat
    13 deny ip host 10.17.17.1 host 10.18.18.1 (365 matches)

\ это acl для ната. в которм мы исключаем трафик тонеля с нашей 
сороны туда из нат преообразвания. иначе трафик будет броаться не втонел
а тупо напровайдера \

crypto map outside_map 65535 ipsec-isakmp dynamic DYNAMIC

int Fa0
 acl WAN_acl_in  in
 crypto map outside_map


Extended IP access list WAN_acl_in
 permit esp any any 
 permit udp any any eq isakmp 
 permit udp any any eq non500-isakmp 
 
 
 видно что на wan интерфейсе применен acl и криптом мап
 на wan acl разерешен esp, udp 500, udp 4500
 
 супер важно что esp обяазетлтно нужен открывать 
 когда мы используем трансформ сет в режиму тоннель.
 
 есл мы посмротрим на трансоформ сет. то там ненаписано нинде
 что он рабоате в режиме тонеля. это питуочто что если в режиме 
 тонеля то это никак необозначается. а если бы он работал в режиме 
 транспорта то трансформ сет выгдяедел бы так (к примеру)
 
 crypto ipsec transform-set transform-1 esp-3des esp-sha-hmac
 mode transport

вот видно что указано mode transport. я считаю что это дебилизм что
циско неуказывает для туннеля режим mode tunnel. 
такой режиме у трнасформ сета по умолчанию.

флаг no-xauth означает что мы неиползуем логин парль для доп аутенти
фикации. только обходимся прешаред ключом

если тоннель поднялся то есть

sh crypto isakmp sa
sh crypto ipsec sa 

все показыает , но пинги неидует значит на WAN интерйейсей неразрешен 
esp протокол. (это была моя причина почему у меня нерабоали пинги
при поднятом тоннеле).

еще может бть прична пому пинги неидет. потмоу что надо 
исключить lan ip из nat acl

как удобно дебажить пинги тонеля. вот как - включить дебаг 
для isakmp для ipsec и создать acl который будет содрежтаь lan ip 
с двух сторон. и включит дебаг именно для этого acl
тогда рутер неляжет от дебага и все будет видно в логах.

пример

на рутере А 

lo 
ip = 10.17.17.1

на рутере B
lo
ip = 10.18.18.1

создаем acl

ip acc l extended 115
permit ip host 10.17.17.1 host 10.18.18.1
permit ip host 10.18.18.1 host 10.17.17.1

причем этот acl его ненужно чтобы он был вставлен в криптом.
нето. просто сам по себе больающийся в воздуже acl

после этог

# debug cr isakmp
# denbug cr ipsec
# denug ip packet 115 detail

и можно будет видеть в 

# sh  logg

о том что доходят недохдодят пинги через тонель..
очень очень очень удобно!

==
если тонель поднялся isakmp sa 
но пинги непрроходят то значит что на wan интерфейса не его acl 
запещешен какойто протокол анпример esp как быдло у меня
или acl самого тонеля некоретнный.

=======
pfsense

выяниснилось что если делать тонель между циско и пфсенс то

1) пфсенс раздел файрволл раздел ipsec там почемуто вобще правила неиграют никакой роли для уже установленных соединений.
а только для новых соединений.тоесть если в правилах нет запроетов
и мыможет пинговать от А до Б то введение правила ничего недает.
а вот для новых соединенйи дает.
как выглядит само правило. 
src IP = указываем источник локальную сеть на той стороне
dst IP= указвыаем приемник локальную сеть  на нашей стороне


2) на пфсенс можно делать сраз унеслоько сетей (называется фаза 2 на пфсенс) в рамках одного тонеля. но пчемуто циско такой фигни непонимает.
так что на пфсенс надо ограничитмс только одной сетьюб

====
циско вещь в себе
загрузился с другого роммона так у нее в sh ver исчез
криптом модуль который устанолвен там точно.

роммон игтает какую то огромную роль у циски. типа биоса.
захотел выключил фичи захотел вкюлчил

====

проблема с входом на циско
а аутентификацийи авторизацией.

делаб вторую циско. железка такая же. ios версия такая же.

по идее делаю конфиг на второй как на первой.
однако почемуто вход работает по другому.

на первой циско вход по локальному акаунту дает 
вход на уровне привилегий 1. и далее надо вводит

# en 15

и вводим secret пароль

на второй циске тоже самое приводит к тому что вход сразу проходит 
на уровне 15 и 

# en 15

вводить ненужно.

вход через радиус дает то что вводим логин , получаем права уровня 1
и вводим enable 15

на второй циско  после ввода en 15 пишет authenticatoin error.
непонятно причем здесь афентикейшн когда мы уже авторизейшн делаем.

в итоге пришлось на второй циско делат доп команды.

итак на первой циско конфиг такой

aaa authentication login default local group office-ad-servers
aaa authorization console
aaa authorization exec default local if-authenticated

enable secret ...


на второй циско чтобы enable 15 работал для радиус входа конфиг 
такой 

aaa authentication login default local group office-ad-servers
aaa authorization console
aaa authorization exec default local if-authenticated
aaa authentication enable default enable
!
=====

столкнулся с дебильнейшим ( как я понял циско сейчас вобще нето что
было рантше) багом в связке ipsec eazyvpn cisco + shrew client

условия получить проблему:
1) мы на циско в acl разрешенных к доступу через впн 
сетей пропишем хост с маской \32 
2) в профиле впн указваем split tonnel
3)  также укажем в свойствах впн чтобы циско пушила стат маршруты 
на клиента через reverse-route опцию 
4)  подключимся через клиент shrew 

то  у нас связи с разрешенным хостам небудет.

а в логах циско будет идти ошибка 

cisco IPSEC(epa_des_crypt): decrypted packet failed SA identity check

обьяснение нашел здесь - https://lists.shrew.net/pipermail/vpn-help/2011-July/013299.html

собственно оно и обьясняет что прикол происходит 
ровно при вышеописанных условиях



итак пример.

на циско поднимаем loopback

loopback 0
ip address 10.19.19.1 255.255.255.255

далее в isakmp группе прописываем acl

crypto isakmp client configuration group office-remote-users
 key 123
 pool POOL_1
 acl izi2
 split-dns mk.local

и в этом acl мы указываем хост с маской \32

20 permit ip 10.19.19.1 0.0.0.0 any

далее мы через шрью поключаемся к циске. 
клиент циски автоматом прописывает в виндовс маршрут.
все хорошо. но пинги непроходят

на циске в логах 
# debug cr isa
# debug cr ips

мы видим ошибку

cisco IPSEC(epa_des_crypt): decrypted packet failed SA identity check

и в свойствах тунеля мы видим

# sh cr ips sa peer 12.234.45.23
что у параметра  recv errors  большие значения.

Значит как это решить.
надо избавиться от маски 32 в маршруте разрещенном.


надо изменить ACL на вот такой например

Extended IP access list eazyvpn-admin-users-acl
    20 permit ip 10.19.19.0 0.0.0.3 any
	
тоесть взять маску 255.255.255.252

это просто ужас какое циско стало.
тоесть мы разрешаем доступ кнебольшой подсети.

==================
cisco

скорость впн 
у разных коробок

https://community.cisco.com/legacyfs/online/legacy/1/8/6/78681-white_paper_c11_595485.pdf

там еще надо учитывать (что в статье проглядывает) что если надо смотреть не скорость 
чистого впн а когда все сразу NAT+IPSEC и прочее.
так что условно говоря для того чтобы впн 100МБИТ он толкал надо брать коробку минимум 3925

==

nexus
если мы имеем провод cisco console - com - usb переходник

то win2012 не имеет дров для такого провода по дефолту
в диспетчере устройств будет устройство вида 

usb2.0-ser 

дрова для него качаем отсюда

устройство CH340G

https://www.arduined.eu/ch340g-converter-windows-7-driver-download/

============

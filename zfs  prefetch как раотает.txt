| zfs
| prefetch

очень хитря штука


echo 0 > /sys/module/zfs/parameters/zfs_prefetch_disable

если я даже в своставах датасета сделал что в арк можно харнить только 
метаданные. это незначит что префетч перестал раобоать.

помимо арка у зфс есть еще  АБС буферы.

вот моя прога начла качать иопсы. зфс создает поток в своем шедулурере.
и если он видит что запросы идут личнейно то он начинает на диск кидать нетолько наши запросы
но и еще свои. так вот. скжем мы счиатали 1 оффсет . а он еще считает 2или 3.
и эти данные он кладет в АБС буфер. он не в арке. он гдето отделно. 
и когда нашей прога запрос офсеты 2 и 3 то они уже есть. в этом АБС буфере. когда он нам 
их отдал то он буфер очищает. а если бы у нас было primarycache=all  то он бы тогда еще это скопиррвал в арк.
есть параметр сколько байтов зфс разерешено предвариеттлно накачивать изщ держать в АБС буфере для одного
потока в своем ио шедулере


# cat /sys/module/zfs/parameters/dmu_prefetch_max 
134217728


в даннмном случае 128 Мб типа того.


поэьом даже если для дктааттсета  указао что в арк харнить только мтеданные это никак не 
ломает префетч.


если он активрован 

линукс
  # cat  /sys/module/zfs/parameters/zfs_prefetch_disable
  0

freebsd
	#sysctl  vfs.zfs.prefetch.disable
	0

то он заранее читает блоки с дисков и сохранет их в АБС буферы 
и у нас в иотоге скорсть лин чтения вырастаает !


как это легко проверить.

меряем скрость лин чтения на датаесет где primarycache=metadata secondarycache=metadata
потмона лету октлоавчаем префтетс и еще раз меряем. и скрость сразу упадет и число запросв на диски тоже. 
приолно что в обоих случая число иопсмов и срупут будут совпдаать у фио и надисках. 
просто чать запосов фио к нему поаадетает уже не с дикаов а из памяти. тоесть будет рассинхро нно незметный для галаза





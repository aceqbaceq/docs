FC

как я понял ни ceph ни glusterfs неработает через fibre channel.


-------
согласно этому документу 

https://support.hpe.com/hpesc/public/docDisplay?docId=mmr_kc-0100588

HP StorageWorks 8/80 SAN Switch эквивалентен 	Brocade 5300

в этом документе
 https://h20195.www2.hpe.com/v2/getpdf.aspx/c04123373.pdf?ver=7

прописано какие трансиверы этот свич поддерживает:

нас интересует вот этот:
HP 8Gb Shortwave B-series Fibre Channel 1 Pack SFP+ Transceiver = AJ716B

далее я нашел в инете неодно упоминание 
(например вот здесь https://support.hpe.com/hpesc/public/docDisplay?docId=c01486152&docLocale=en_US)  о том что 
		AJ716A is End of Life (EOL), and is replaced by AJ716B because of RoHS compliance; however, the SKU is still orderable until supplies are diminished.


	тоесть то что AJ716A и AJ716B это типа одно и тоже. как японял B просто 
	более экологичный. дело в том что в магазинах сейчас B ненайти зато A попадается очень часто.
	
поэтому с трансиверами к этому свичу мы определились какие он официально
поддерживает.

итак свич есть, трансиверы есть
	
-------


согласно man isp из freebsd

(freebsd)# man isp

 
она поддерживает FC карточки от qlogic серии 

Qlogic 256x (aka 2532)
		   Optical 8Gb Fibre Channel PCIe cards.

 


-------
согласно этому документу 

https://driverdownloads.qlogic.com/QLogicDriverDownloads_UI/HP.aspx?companyid=4


вот эта карточка 

HP StorageWorks 82Q 8Gb Dual Port PCIe Fibre Channel Host Bus Adapter  [AJ764A, QLE2562-HP, 489191-001]

эквиватлента

qlogic QLE2562

поэтому типа она заработает на фрибсд
с другой стороны так как это HP то думаю что со свичом HP она тоже
совместима  поэтому типа эта сет карточка нам подходит

в доке от карточки 
		https://h20195.www2.hpe.com/v2/getdocument.aspx?docname=c04164502#
		написано что вообще то в комплекте с ней идут трансиверы 
		но неуказано какие по модели, но вот в этом документе 
			https://support.hpe.com/hpesc/public/docDisplay?docId=emr_na-c04183658
			который типа говорит о запчастях к этой карточке
			сказано что к этой карте как запасная часть подходит
			трансивер вот такой 468507-001
			я поискал по этому номеру и нашел что это AJ716A.
			тоесть он либо идет с этой картой в комплекте либо по крайней
			мере он с картой совместим.
	

таким образом трансиверы + карточка + свич совместимы друг с другом.
и карточка совместима с freebsd.

хотя вот тут
	https://community.hpe.com/t5/bladesystem-virtual-connect/are-aj716a-and-aj716b-sfp-b-series-compatable/td-p/6680294#.X6BVwNUzY2w
	
	чувак пишет что (как я понял) что у него система на AJ716B незаработала а заработала она только на AJ716A и что типа они несовместимы. этот аспект непонятен.
	

ссылки 
		сет карта
			https://www.westcomp.ru/catalog/fc_8_16gb_s/adapter_hp_storageworks_82q_8gb_dual_port_pcie_fibre_channel_host_bus_adapter_aj764a_489191_001/
		
		здесь пишут что AJ716A и AJ716B трансиверы совместимы
			https://community.hpe.com/t5/hpe-eva-storage/difference-of-part-numbers-of-transceivers/td-p/5842347#.X6BU2NUzbIU
		
			https://forum.ixbt.com/topic.cgi?id=66:10191
		
		кабель
		
			https://www.westcomp.ru/catalog/transivery_opticheskie_kabeli/hp_premier_flex_lc_lc_om4_2f_5m_multi_mode_optical_cable_qk734a_656429_001/
		
		pdf от свича
		
			https://h20195.www2.hpe.com/v2/GetPDF.aspx/c04123373.pdf
		
		pdf вообще по свичам
		
			https://www.intesiscon.com/ficheros/manuales-tecnicos/96-Switch-fibra-HP.pdf
		
		здесь 
			https://it-hp.ru/product/aj716a/
		пишут вот такое:
		
			Общие
			Номер производителя AJ716A
			Название продукта Трансивер HP 8 Гб Shortwave B-series Fibre Channel 1 Pack SFP+

			Основные характеристики
			Тип приемопередающий модуль для коммутатора
			Устройство ЛВС 1 порт (Fibre Channel)
			Пропускная способность 8 Гбит/сек.
			Поддерживаемые стандарты IEEE 802.8 (Fibre Channel)

			Дополнительные характеристики
			Совместимость для систем хранения HP StorageWorks 4400EVA и коммутаторов StorageWorks 4/8 SAN/ 4/32B SAN/ 8/40 SAN/ 8/8 SAN/ 8/80 SAN/ DC SAN Backbone Director
			Интерфейсы 1 x Fibre Channel • SFP
			Системные требования Mini-GBIC

			Доп. информация Трансивер HP AJ716A
			Назначение система хранения • HP StorageWorks 4400EVA
			коммутатор • HP StorageWorks 4/8 SAN
			коммутатор • HP StorageWorks 4/32B SAN
			коммутатор • HP StorageWorks 8/40 SAN
			коммутатор • HP StorageWorks 8/8 SAN
			коммутатор • HP StorageWorks 8/80 SAN
			коммутатор • HP StorageWorks DC SAN Backbone Director

			Родительские устройства
			SAN коммутатор HP StorageWorks 4/8 SAN Switch, монтируемый в шкаф-стойку корпус, 8 портов, Fibre Channel, 1U, ret
			Система хранения информации HP StorageWorks 4400 Enterprise Virtual Array, внешн., жесткие диски: 8 x 400 ГБ, общей ёмкостью до 12 ТБ, черного цвета

		pdf от карточки
		
			https://h20195.www2.hpe.com/v2/getdocument.aspx?docname=c04164502#
		
		здесь пишут какая модель qlogic карточки сидит внутри карточки hp
		
			https://driverdownloads.qlogic.com/QLogicDriverDownloads_UI/HP.aspx?companyid=4
		
		здесь пишут какие модели Brocade лежат внутри некоторых железок HP

			https://www8.hp.com/cn/zh/pdf/HP-RG-160-12_A4_SpreadsMar13_tcm_185_1431155.pdf
	
	
	

==============================


установка

качеаем http://ldriver.qlogic.com/firmware/ql2500_fw.bin
пересобираем initramfs 
 update-initramfs -u
 
 
 проверянм стату реэима раоты карты инициаотор или таргер
 cat /sys/module/qla2xxx/parameters/qlini_mode
 
 /sys/class/fc_host/host4/port_state = показывает вообще кабель то воткнуть есть ли сигнал на уровне L1
 
 =====
 fabric license и full fabric license это одно и тоже
 
 при наличии этой лицензии можно свичи друг с другом сединять
 но только по однрому порту.
 
 а если мы хотим друг сдргуом по несколким портам то нужна дополниельно
 ISL лицензия
 ==
 
 если стоит 
 full ports on demand license на 32 портов
 
 и стоит одновременно 
 second ports on demand license на 16 портов
 
 и еще может там какието он деманд лицензи
 так вот суммарное число активироавнных он деманд
 портов полюбому неможет превыщать число 32 которое указано
 в лицензии full ports on demand license
 =====
 если скорость портов указан через N
 например N8 
 то буква N ознавает что настройка порту = negotiate
 то есть она предлагает устройству конечному такую скорость.
 
 есть другой варианть настройки скорсти порта , когамы жестко
 задаем скажем 8ГБ.
 тогда буквы N не будет в статусе скрости поартов
 
 ====
 имеем esxi
 на нем FC карты qlogic
 они проброшены напрямую в VM
 
 сама карта FC воткнута в FC свич.
 
 пока VM выключена порт FC будет находится в состоянии выключено, в веб мордое свича это выглядит как буква U на порту.
 
 когда VM загрузилась то если все окей то буква в веб морде изменистя на F
 на самой виртуалке статус порта можно проверить командой
 
# more /sys/class/fc_host/host?/port_state
::::::::::::::
/sys/class/fc_host/host2/port_state
::::::::::::::
Online

тоесть он должен быть онлнайн.

на примерер убунту 16 и 20 = никаких паетов и настроек самому делать ненадо.
сразу с нуля если ВМ загрузиась то порт должен перейти в состояние онлайн.

единсвтенное что понятно что ВМ должна иметь дрова от FC карты.


вот как проверить что ВМ видит карту

/# lspci -nn | grep -i hba
0b:00.0 Fibre Channel [0c04]: QLogic Corp. ISP2532-based 8Gb Fibre Channel to PCI Express HBA [1077:2532] (rev 02)



 вот как проверить сколько в карте дырок
 
 /#  ls -l /sys/class/fc_host
total 0
lrwxrwxrwx 1 root root 0 May 15 10:52 host2 -> ../../devices/pci0000:00/0000:00:16.0/0000:0b:00.0/host2/fc_host/host2


здесь получается одна

вот как проверить какой WWN имеет порт на карте

/# more /sys/class/fc_host/host?/port_name
0x50014380186a0444


итак если это все видно значит без каких то настроек порт дожен быть в состоянии ONline.
если это нетак то проблема в самой VM.
типа надо попробовать другой голый дистрибутив.

ни на esxi ни на свиче. вобщем нигде ничего специально настривать ненужно.
если ВМ загрузислась то порт дрожен перейти в состояние онлайн.

если он непрешеол чтото нето с ВМ. я обычно пробуб новую голую ВМ другую.

==

 targetcli
 
 создание LUN на основе RAMDISK
 
 # targetcli
 >  cd backstores/
 
 > create name=rd_backend size=40GB
Generating a wwn serial.
Created rd_mcp ramdisk rd_backend with size 40GB.


> cd /qla2xxx/50:01:43:80:18:6a:02:e8/luns/

> create /backstores/rd_mcp/rd_backend
Selected LUN 1.
Successfully created LUN 1.
Created mapped LUN 1 in node ACL 50:01:43:80:18:6a:04:44

готово


на клиенте надо перезапустить скан лунов

клиент #  rescan-scsi-bus.sh
после fdisk сразу должен показать новый lun


 
 ===
 
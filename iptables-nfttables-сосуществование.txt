| iptables
| nftables
| conflict
| сосущестования


есть такой интеересный момент.
у нас раньше был иптбейлс. это как я думал
набор модулей ядра которые входят в поставку ядра
и это юзер спейс утилиты цель которых засунуть
правила в ядро. эти утиилиты входят в состав пакетов.

так вот на самом деле это не совсем так. иптеблейс
имеет еще один компонент. он вшит в само ядро
он не явлется частью какогото модуля. так вот
этот компонент это некая шина. некий трак. через 
который протаскивается пакет  внутри кода ядра.
прикол в том что эта шина она аболютно пустая.
но на ней есть реперные точки - хуки(название дебиль
ное). 
так вот схема в целом выглядит плюс минус так -
мы с помощью юзер утилиты загружаем правила в 
ядро кудато там в память.
далее на этой шине на хуке размещается GOTO который
ведет на такойто модуль. запускается его код конкретный
обработчик пакета в такой то ситуации. он ищет
в памяти правила, находит там тот кусок правила
за обработку которых отвеччает именно этот модуль.
и он их выполняет.

так вот с какогто момента придумали другие модули - nft
шина при этом осталась таже самая она никуда не
деласьь и не поменялась. а просто напросто на ней
в хуках помимо старых GOTO котоыре вели на старые
модули рядом появились в добавок новые GOTO которые
стали вести на новые модули.


таким образом получается можно в линуксе завести
в ядро правила для иптейлс. также можно в добавок
занести правила для nft. и при прохождении пакета
по ядру на каждом хуке вначале пакет будет 
обраатьывся старым модулем , если пакет недропается
а пропускается дальше то он потом обрабатыватеся
новым модулем. правда какой модуль обрабатывает
пакет первым хер знает. проверяеть не буду.

таким макаром обе эти системы могут одновременно
сущестовать и работать на одном компе.


есть еще один прикол.  я уже говорил про утилиты
которые позвояют заснуть правила в памть ядра.
так вот их не два класса как казалось бы - старая
утилитиа для иптбейлс , новая утиита для nft а
есть еще одна утилита которая позволяет скормить
ей правила для иптбелйс а она налету переделает
эти правила в правила nftables и засунуть их в nft

вот эти утилиты
 
 1. едят старые правила и суют их в иптбелс(старые) модули

 	# ls -1 /usr/sbin/iptables-legacy*
	/usr/sbin/iptables-legacy
	/usr/sbin/iptables-legacy-restore
	/usr/sbin/iptables-legacy-save


 2. едят старые правила и суют их в nft(новые) модули

	# ls -1 /usr/sbin/iptables-nft*
	/usr/sbin/iptables-nft
	/usr/sbin/iptables-nft-restore
	/usr/sbin/iptables-nft-save

 3. едят новые правила и суют их в nft(новые) модули
    
    /usr/sbin/nft



я провел эксперимент.
я засунул старые правила в старые iptables модули
в них я запретил tcp/22 порт

# /usr/sbin/iptables-legacy-save 

*filter
:INPUT ACCEPT [6401:428884]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [6400:428800]
-A INPUT -p tcp -m tcp --dport 22 -j DROP
COMMIT



также я засунул старые правила в nft(новые) подсистему.
в них я запретил icmp

# /usr/sbin/iptables-nft-save

*filter
:INPUT ACCEPT [6964:466524]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [6963:466524]
-A INPUT -p icmp -j DROP
COMMIT

так вот у меня на компе перестало раобтать 
оба потока. у меня пеерстал работать icmp
и перестал работать доступ по 22 порту.

тоесть обе системы модулей работают на компе
одновременно!

также можно проверить то что те правила которые
мы ввели в nft через iptables-nft они видны 
"родной" nft утилите.
вот сравним набор правил

# /usr/sbin/iptables-nft-save

*filter
:INPUT ACCEPT [6964:466524]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [6963:466524]
-A INPUT -p icmp -j DROP
COMMIT


и 

# nft list ruleset
table ip filter {
	chain INPUT {
     	type filter hook input priority filter; policy accept;
		meta l4proto icmp counter packets 3 bytes 252 drop
	}

	chain FORWARD {
		type filter hook forward priority filter; policy accept;
	}

	chain OUTPUT {
		type filter hook output priority filter; policy accept;
	}
}


собственно вот это правило

-A INPUT -p icmp -j DROP

и вот это правило 

 meta l4proto icmp counter packets 3 bytes 252 drop


это одно и тоже.

так что все совпадает


ксатии полезные маны
 

  # man iptables-legacy
  # man iptables-nft



так что на компе может две системы правил.
каждая относится к старой или новой подсистеме.
и обе систпмы правил уродливо но будут жить
и работать вместе



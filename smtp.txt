есть такая тема 
как отправка\прием почты

тема мудацкая. но будем разговаривать.


===
вначале быстрая вставка
говорим про SPF

какойто сервер принимает к себе письмо якобы с нашего домена kuku.ru
что он делает. он пытается проверить а действительно ли письмо было отослано с домена kuku.ru 
как он это делает

он делает DNS запрос тип TXT с именем kuku.ru

nslookup
set type=txt
kuku.ru

в ответ он получает все TXT записи с именем kuku.ru

одна из них имеет особый вид

v=spf1 бла бла бла

эта TXT запись считается SPF записью для домена kuku.ru  сточки зрения принимающего почтового сервера.

в ней прописано при каких условиях пришедшее письмо можно считат отправленным с домена kuku.ru


вот вид для примера записи SPF для домена kuku.ru


v=spf1 include:vasya.kuku.ru include:server.google.com -all

раньше на DNS серверах использовали тип записи SPF. то есть на самих DNS серверах был тип записи SPF. потом от него отказались и теперь используют тип TXT. просто эта TXT запись имеет особый вид тела. по которому почтовый сервер из всех TXT записей может распознать SPF , SPF с точки зрения именно почтового сервера. так как сточки зрения DNS сервере никаких больше SPF записей у него нет. только одни TXT

 
видим два include. если хотя бы одно include выполнено то в целом проверка считается выполненной. то есть include это как OR либо то либо то.

-all означает что если письмо непрошло проверку успешно то его почтовый принимающий сервер должен отфутболить. непринять. проверка spf происходит на стадии как я понял helo\ehlo поэтому как я понял тело письма принимается только после того как пройдена spf часть проверки.
-all предписывает принимающему почтовому серверу непринимать письмо категорически если spf провека непройдена. 
есть более мягкая настройка ~all она говорит что если spf проверка непройдена то письмо можно принять но его надо поместит в папку спам.

вернемся к include. 
ибо внутри него заключено конкретное условие которое
определяет письмо с домена kuku.ru или нет.
include говорит о том что надо пойти на другой домен считать spf запись того домена и если условие той spf выполнено то считать что и наша spf выполена


include:vasya.kuku.ru это условие говорит что надо считать еще один SPF с домена  vasya.kuku.ru

nslookup
set type=TXT
vasya.kuku.ru

привожу чему равен spf для vasya.kuku.ru

v=spf1 ip4:99.99.99.124/32

значит ip4 это еще одна опция проверки условия истинности.
и оно говорит что если отсылающий smtp серер имеет ip = 99.99.99.124/32
( а это видно на стадии приема письма) то считать условие выполенным.

можно указать несколько ip в строке и они будут работать как OR

v=spf1 ip4:99.99.99.124/32  ip4:8.8.8.0/24 ip4:3.3.0.0/16

если отправляющий smtp сервер имеет ip из любого ip4 блока то условие 
считвается выполненным

таким образом возващшаемся к нашему исходному письму.
если отправлящий smtp сервер имеет ip = 99.99.99.124 то include считается выполненным и письмо считается отправлено уполномоченным от kuku.ru сервером. 

если конкретно include:vasya.kuku.ru 
невыполнено то берется следующее условие include 
include:server.google.com
и проверяется может там будет совпадение.

таким образом несколько include это эквивалент OR.

если ни один include невыполнен то письмо счтается проверку не прошло.


из нашего конкретного примера видно что в конечном итоге отправляющий smtp сервер проверяется на основе ip адреса. и это отличная проверка потому что ip адрес это достверная информация. потому что ip адрес мы видим в ip пакетах от отправляющего smtp сервера. ее неподделать.


что будет если в spf запист указать ip4 и include вместе.
ответ будет жопа


v=spf1 ip4:4.4.4.4/32 include:vasya.kuku.ru  -all

как я понял неважно какое условие прописано в include по любому
от отправляющего сервера smtp требуется чтобы его ip был = ip4:4.4.4.4

почему это плохо. если мы отправляем почту с двух независимых серверов.
один сервер это наш родной smtp сервер который обслуживаем мы а другой
сервер с которого мы отправляем почту это скажем через веб морду gmail.com  тогда если в нашей записи если мы будем использовать опцию ip4 мы должны указать ip адреса отправляющих smtp серверов с площадки гугла а мы понятия не имеем какие они ,
поэтому если у нас есть несколько незавиисимых плошадрк серверов с которых
отправлябтся письма от имени нашего домена то в spf записи нет смысла нельзя использовать условие ip4  потому что надо указать тогда ip адреса 
всех серверов на всех площадках а мы их можем и незнать.


возвращаемся к исходной записи
kuku.ru TXT v=spf1 include:vasya.kuku.ru include:server.google.com -all


в этой записи сказано что наща spf запись считывается выполненной
если выполенна spf запись либо для vasya.kuku.ru домена
либо для server.google.com домена

таким образом если наша почта отсылается с гугловских серверов томы просто отправляем принимающий почтовый сервер к spf записи гугла server.google.com и это уже забота гугла как они там прописали какие их серверы являются валидными. все это не наша проблема.

а наш отправляющий сервер мы зашифровали через include:vasya.kuku.ru
подчекрну что vasya.kuku.ru это не DNS имя нашего непосредственного smtp отправляльщика. нет! ссылка идет непрямая а опосредованная.

мы говорим что чтобы spf запись для домена @kuku.ru считалась выполенной
надо прочитать spf запись ОТ ДРУГОГО ДОМЕНА @vasya.kuku.ru  и если она выполнена то и наша spf считается выполненной.

ну и получается уже втой spf записи указано конкретное условие признака 
валидного сервера

vasya.kuku.ru TXT v=spf1 ip4:99.99.99.124/32

вот таким макаром прописывают валидные ip адреса уполномоченных smtp серверов для домена.

уж совсем конкретно из жизни обычно делают так.

заводят две записи.

первая запись

kuku.ru TXT v=spf1 include:_spf.kuku.ru -all

и вторую запись

_spf.kuku.ru TXT v=spf1 ip4:99.99.99.124/32  ip4:8.8.8.0/24 ip4:3.3.0.0/16

замечу что это две spf записи НО!  формально для разных доменов.
с точки зрения kuku.ru у него одна spf запись ( и это правильно)
просто она ссылается на spf запись в другого домена.
домен должен иметь только одну spf запись.

и в итоге мы для нашего домена прописали опосредованно с каких IP могут 
посылать уполномоченные нами smtp сервера.

зачем такая двойная запись почему несделать сразу одну.
потому что это дает гибкость.

если у нас появляетс вторая площадка с которой мы будет остылать письма
и той площадкой мы незаведуем то мы в первую запись просто добавим +1 include

kuku.ru TXT v=spf1 include:_spf.kuku.ru  include:_spf.google.com
-all

таким образом появляется удобство гибкость при изменении структуры 
отправляющих серверов. если бы мы сразу пихали конечные ip адреса 
в нашу запись то нужно было бы тогда пихать и все гугловские ip адреса
а мы их просто и незнаем. а так это и ненаша забота.
удобно.

замечу что при такой схеме DNS имена отправляющих smtp серверв вообще никак здесь не участвуют их нет. мы их вообще неиспользуем.

в spf записи помимо опций  ip4, include есть и другие опции .
о них надо читать отдельно.

например есть опция mx.
она говорит что отправлящий сервер должен попадать в mx запись этого домена. по мне это ненужная опция. потому что mx сервера это сервера принимающе почту. а spf запись она касается серверов отправляющих почту.
и они необязаны быть связаны. принимать могут одни а отправлят могут
соврещенно другие. поэтому если конечно так случилось что у вас и принимающие и отправляющие одни и теже то можно в spf просто тогда указать опцию spf.

про другие опции spf читай отдельно. 


===

PTR

как выглядит

255.2.0.192.in-addr.arpa

как удобно проверять наличие PTR записей = через dig


$ dig -x IP

пример

$ dig mail.ru a
mail.ru.		12	IN	A	217.69.139.202
mail.ru.		12	IN	A	94.100.180.201
mail.ru.		12	IN	A	94.100.180.200
mail.ru.		12	IN	A	217.69.139.200


$ dig -x 217.69.139.202
202.139.69.217.in-addr.arpa. 379 IN	PTR	mail.ru.

$ dig -x 94.100.180.201
201.180.100.94.in-addr.arpa. 3576 IN	PTR	mail.ru.


====

про SPF. 
по факту с точки зрения DNS сервер это заппись типа TXT но с особым значением.

механизм проверки :
когда один почтовый сервер А связывается с другим почтовыс сервером Б по  SMTP то сервер Б видит его IP интернетовский.(от IP пакеты которые прилетают).
Таким образом сервер Б достоверно знает внешний IP сервера А. 
телнет сесия к примеру выглядит так:

$ telnet mx.yandex.ru 25
EHLO localhost
MAIL FROM:<petrov@glav-square.ru>
RCPT TO:<petrov@pepsi.ru>
DATA
From: Tek Bahadur Limbu <m@glavhome.ru>
To: someone else <m@example.com>
Subject: testing 21:18

Test test test
.


так вот здесь важно увидеть что обратный адрес появляется два раза. так вот по факту письмо будет отослано по тому
адресу который указан в MAIL FROM:<petrov@glav-square.ru>
все что указано до команы DATA это как конвертик на бумажном письме. поэтму именно поля 

MAIL FROM:
RCPT TO:

также как на бумажном коневерте указывабт от кого и куда идет письмо. именно эти поля оплределяют куда будет направлено письмо.

все что после комады DATA это уже листик с самим письмом. листик письма на процесс транапортиовки никак не влияет. его  упрошенно говоря 
почтовые серверы через которые идет пиьсмо читать не будут учитыать в процессе пеерерсылки. его будет читать уже человек которому это 
письмо прилетит уже на комп.
 
так вот вот это поле MAIL FROM: 
оно еще имеет клички другие имена, синонимы в литературе:
return-path  
SMTP MAIL FROM, 
Return-Path,
Bounce Address. 
reverse path, 
envelope sender, 
envelope from


если на почт клиенте нажать кнопу посмотреть исходное тело письмо там где будут притсовать пооля служебгные то там это поле имеет 
название return-path. 
показвыаю:


Received: from localhost (11-11-11-11.dell.com [11.11.11.11])
	...
	...
	...
Return-Path: petrov@glav-square.ru


таким образом в живом письме на компе  телнетовская хрень MAIL FROM: выглядит как Return-Path:

так вот к чему это все. к тому что  принимающий почтоыый сервер он проверяет SPF именно для домена который указан в
MAIL FROM: !!!! вот что важно. вот что надо понять.  а поле From: Tek Bahadur Limbu <m@glavhome.ru> указанные в теле письма уже 
абсолютно для SPF проверки насрать. вот что важно понять.

поэтому SPF проверка выглядит так:
мы звоним на яндекс и доходим до этой стадии
$ telnet mx.yandex.ru 25
EHLO localhost
MAIL FROM:<petrov@glav-square.ru>


тут же яндекс лезет в DNS и ищетя для домена glav-square.ru его SPF запись. и смотрит что там написано.
также яндекс имеет IP нашего сервера отправителя. если яндекс ненайдет наш IP в той SPF записи то он нас на данном шаге пошлет нахер.
вот это все важно понять. как работает SPF проверка. кто куда лазии и с чем сравнивает.!!






----
=============================
=============================
БОЛЬШАЯ ТЕМА SMTP - начало блока
=============================
=============================

SMTP


$ telnet mx.yandex.ru 25

EHLO localhost
MAIL FROM:<petrov@glav-square.ru>
RCPT TO:<petrov@pepsi.ru>
DATA
From: Tek Bahadur Limbu <m@glavhome.ru>
To: someone else <m@example.com>
Subject: testing 21:18

Test test test
.


в итоге на яднексе будет такое тело письма:

Received: from postback28b.mail.yandex.net (postback28b.mail.yandex.net [2a02:6b8:c02:900:1:45:d181:da28])
	by cqxive3eyocweozr.sas.yp-c.yandex.net with LMTP id ZHx2BdfZlD-0hyDZ2MS
	for <petrov@pepsi.ru>; Sun, 27 Nov 2022 18:20:07 +0300


Received: from myt6-dcd87beca1ab.qloud-c.yandex.net (myt6-dcd87beca1ab.qloud-c.yandex.net [IPv6:2a02:6b8:c12:2c9a:0:640:dcd8:7bec])
	by postback28b.mail.yandex.net (Yandex) with ESMTP id 0CA345E54A
	for <petrov@pepsi.ru>; Sun, 27 Nov 2022 18:20:07 +0300 (MSK)


Received: from localhost (11-11-11-11.dell.com [11.11.11.11])
	by myt6-dcd87beca1ab.qloud-c.yandex.net (mxfront/Yandex) with ESMTP id iIQQ4x9PHuQ1-S5YiWZv4;
	Sun, 27 Nov 2022 18:19:24 +0300
X-Yandex-Internal: 1
Message-Id: <20221127182006.S5YiWZv4@myt6-dcd87beca1ab.qloud-c.yandex.net>
Date: Sun, 27 Nov 2022 18:20:06 +0300
X-Yandex-Fwd: 1
X-Yandex-Spam: 4
X-Yandex-Uid-Status: 4 1130000062089509
From: Tek Bahadur Limbu <m@glavhome.ru>
To: someone else <m@example.com>
Subject: testing 21:18
Return-Path: petrov@glav-square.ru
X-Yandex-Forward: 7acf1669f283e398ceb854741db9c1eb

Test test test



каждый новый мейлер через котрого проходило письмо 
опредеяетяся по строке

Received:



далее. в письме все мусор ( можно можно наврать и это непроверятеся ) кроме вот этого куска:

```11-11-11-11.dell.com [11.11.11.11]````


IP адрес настощий 11.11.11.11. под ним увидел потовый сервер яндекса наше сервер

dns имя 11-11-11-11.dell.com тоже настоящее. яндекс его определяет через PTR запись для IP через запрос к DNS.



вот этот кусок тоже настоящий:
````Return-Path: petrov@glav-square.ru````

это в точности вот от сюда
MAIL FROM:<petrov@glav-square.ru>


тоест это в точности под каким ящиком представился сервер отправитель при общении с яндеком до команды DATA.
и это в точности именно то поле которое проверяет яндекс обращаясь к spf записи домена glav-square.ru
если там есть запись spf и наш отправщяющий сервер неимеет в ней своего IP 11.11.11.11 то яндкс пошлет наш сервер нахер при отправке.
поэтому это поле имеет такое значение. и оно настоящее в том плане что именно на этот ящик принимающий сервер и будет по факту слать 
письмо.

 в цедом остальные поля в письме это все может быть наебка которую отправляющий сервер сообщит приимающему.


====
SMTP
helo\ehlo  это не просто привестивя. это протоколы такие почтовые.
==
SMTP
вот эти поля

From: Tek Bahadur Limbu <m@glavhome.ru>
To: someone else <m@example.com>


если в них небудет имен помимо адресов почт то в почтовом клиенте 
в графе кто отослаk и тема письма будут тупорыле пропуски

===
SMTP

если в письме скжаем стоит несколько  рисивд полей.


Received: 
..


Received: 
..

Received: 
..

Received: 
..



то самыый первый мейлер на которое попало письмо это нижний. а самый посдений это верхний


=============================
=============================
БОЛЬШАЯ ТЕМА SMTP - конец блока
=============================
=============================

на счет spf.
какэ то раотает.

spf пропсиывает какие IP сервера могут отсылать письма  с адресами нашего домена в поле envelope-from (return-path).
далее. в чем прикол.

вот мы шлем наше письмо  с почтового клиента. 
почтоый клиент может пойти двумя путиями:
1. зарезолвить mx сервер доена назначения и конектится к нему. если мы шлем на yandex пиьсмо то конектится к mx.yandex.ru
2. а может конекттится не к mx серверру домена назначения а к промеужточному транзитному серверу (smart host). почему?
потому что например нашему компу запрещено по  25 порту вобще выходит в инет. значит нам нужен транзитный почтоый сервер.

теперь - сервер который принимает от нас пиьсмо он может использовать проверку spf а может и неисползовать. это его право.
если мы стучится сразу на конечный mx сервер то он проверяет IP нашего сервера с тем чтобы он входил в spf запись для нашего
домена отправителя . ( на основе поля envelop-rom в письме). нрпимер мы щлем от имени @kuku.ru значит принимающий сервер
будет лезит в днс kuku,ru искать там spf запись и проверять наш IP нашего сервере нахится ли в этой записи. можно ли нашему IP свререру
отправлять письмо от имени kuku.ru
таким образом когда нет транзитных серверов то spf запиь должна осдержатьь только IP адрес нашего сервера отправиетлеля.
вопрос а если мы сидим за NAT - какой IP дожен быть в SPF. ответ - тот IP под которым наш сервер виден в интернете.

поинтереснее ситуация когда наше письмо идет через тразитный почтоый сервер. например мы отправляем на gmail через почту яндекса.
хотя у нас домен не яндекс а vasya.ru .
сервер яндекса при приеме почты от нас  - он оприается только на логин\пароль для опредения что мы валидный отправтель.
далее яндекс пуляет письмо уже на gmail  и (самое интересное) gmail видит что некий яндекс сервер ему пытается впихнуть письмо 
от домена kuku.ru  и видит IP адрес сервера яндекса. и gmail лезет на kuku.ru SPF запись и проверяет а можно ли IP этого яндекс сервера
отправлят почту от имени нашего домена!!!! тоесть принимающая сторона уже ничего незнает о нашем сревер отправителе. о его IP итд.
принимающая сторона всегда работает именно с тем сервером  с тем IP который есть у сервера который непосредственно передает пистьмо. 
в нашем случае это янедкс сверер. и это озанчает что kuku.ru spf запись должна в себе содержать IP сервер янндекса. 
там еще чуть посложнее там кога яндекс всосал наше писмо то он внутри себя его шывыряет еще по несоклькиим(Видимо ментовским) транзтным почтовым
серверам но я считаю что они ничего непроверяют они просто перербатывают пистмо  на сосдение яндекс почтоые сверера.  и никакие spf они не проверя.тю
поэому наша SPF запиьс должна содержат только IP адреса тех серверов которые непосредвтенно уже контачат с конечными mx сверерами адресов назначения почты.



через картрнку покажу.


наш сервер А (ip A)  ---> отправил письмо на ----> янедекс сервер Б (ip Б) 
этот сервер нас проверяо толко по логину\паролю. никакие spf ему неважны. далее


янедекс сервер Б (ip Б) ---> швыреят наше пиьсом через кучу транзитных янедкс свреров ----- .. куча транзитных серверов которые ничего не проверяют
----> пограничный яндекс сервер (IP c)  наконец отправляет письмо уже на гугл прямиков ------> gmail север (ip D)


и этот gmgail сврер видит у себя IP c и проверяет этот IP c с kuku.ru spf записью.
при этом ему абсолтно плевать на IP A нашего исходного срервера.


а если бы цепочка была вот такой короткой:

наш сервер А (ip A)  ---> ------> gmail север (ip D)

то gmail свервр проверял бы в kuku.ru spf записи  наличие (ip A)


поэтому spf запись должна содержать все IP всех серверв почтовых которые непосрдественно доставляют на конченые почтовые хостинги 
наши письма.
--










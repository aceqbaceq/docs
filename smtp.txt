есть такая тема 
как отправка\прием почты

тема мудацкая. но будем разговаривать.


===
вначале быстрая вставка
говорим про SPF

какойто сервер принимает к себе письмо якобы с нашего домена kuku.ru
что он делает. он пытается проверить а действительно ли письмо было отослано с домена kuku.ru 
как он это делает

он делает DNS запрос тип TXT с именем kuku.ru

nslookup
set type=txt
kuku.ru

в ответ он получает все TXT записи с именем kuku.ru

одна из них имеет особый вид

v=spf1 бла бла бла

эта TXT запись считается SPF записью для домена kuku.ru  сточки зрения принимающего почтового сервера.

в ней прописано при каких условиях пришедшее письмо можно считат отправленным с домена kuku.ru


вот вид для примера записи SPF для домена kuku.ru


v=spf1 include:vasya.kuku.ru include:server.google.com -all

раньше на DNS серверах использовали тип записи SPF. то есть на самих DNS серверах был тип записи SPF. потом от него отказались и теперь используют тип TXT. просто эта TXT запись имеет особый вид тела. по которому почтовый сервер из всех TXT записей может распознать SPF , SPF с точки зрения именно почтового сервера. так как сточки зрения DNS сервере никаких больше SPF записей у него нет. только одни TXT

 
видим два include. если хотя бы одно include выполнено то в целом проверка считается выполненной. то есть include это как OR либо то либо то.

-all означает что если письмо непрошло проверку успешно то его почтовый принимающий сервер должен отфутболить. непринять. проверка spf происходит на стадии как я понял helo\ehlo поэтому как я понял тело письма принимается только после того как пройдена spf часть проверки.
-all предписывает принимающему почтовому серверу непринимать письмо категорически если spf провека непройдена. 
есть более мягкая настройка ~all она говорит что если spf проверка непройдена то письмо можно принять но его надо поместит в папку спам.

вернемся к include. 
ибо внутри него заключено конкретное условие которое
определяет письмо с домена kuku.ru или нет.
include говорит о том что надо пойти на другой домен считать spf запись того домена и если условие той spf выполнено то считать что и наша spf выполена


include:vasya.kuku.ru это условие говорит что надо считать еще один SPF с домена  vasya.kuku.ru

nslookup
set type=TXT
vasya.kuku.ru

привожу чему равен spf для vasya.kuku.ru

v=spf1 ip4:99.99.99.124/32

значит ip4 это еще одна опция проверки условия истинности.
и оно говорит что если отсылающий smtp серер имеет ip = 99.99.99.124/32
( а это видно на стадии приема письма) то считать условие выполенным.

можно указать несколько ip в строке и они будут работать как OR

v=spf1 ip4:99.99.99.124/32  ip4:8.8.8.0/24 ip4:3.3.0.0/16

если отправляющий smtp сервер имеет ip из любого ip4 блока то условие 
считвается выполненным

таким образом возващшаемся к нашему исходному письму.
если отправлящий smtp сервер имеет ip = 99.99.99.124 то include считается выполненным и письмо считается отправлено уполномоченным от kuku.ru сервером. 

если конкретно include:vasya.kuku.ru 
невыполнено то берется следующее условие include 
include:server.google.com
и проверяется может там будет совпадение.

таким образом несколько include это эквивалент OR.

если ни один include невыполнен то письмо счтается проверку не прошло.


из нашего конкретного примера видно что в конечном итоге отправляющий smtp сервер проверяется на основе ip адреса. и это отличная проверка потому что ip адрес это достверная информация. потому что ip адрес мы видим в ip пакетах от отправляющего smtp сервера. ее неподделать.


что будет если в spf запист указать ip4 и include вместе.
ответ будет жопа


v=spf1 ip4:4.4.4.4/32 include:vasya.kuku.ru  -all

как я понял неважно какое условие прописано в include по любому
от отправляющего сервера smtp требуется чтобы его ip был = ip4:4.4.4.4

почему это плохо. если мы отправляем почту с двух независимых серверов.
один сервер это наш родной smtp сервер который обслуживаем мы а другой
сервер с которого мы отправляем почту это скажем через веб морду gmail.com  тогда если в нашей записи если мы будем использовать опцию ip4 мы должны указать ip адреса отправляющих smtp серверов с площадки гугла а мы понятия не имеем какие они ,
поэтому если у нас есть несколько незавиисимых плошадрк серверов с которых
отправлябтся письма от имени нашего домена то в spf записи нет смысла нельзя использовать условие ip4  потому что надо указать тогда ip адреса 
всех серверов на всех площадках а мы их можем и незнать.


возвращаемся к исходной записи
kuku.ru TXT v=spf1 include:vasya.kuku.ru include:server.google.com -all


в этой записи сказано что наща spf запись считывается выполненной
если выполенна spf запись либо для vasya.kuku.ru домена
либо для server.google.com домена

таким образом если наша почта отсылается с гугловских серверов томы просто отправляем принимающий почтовый сервер к spf записи гугла server.google.com и это уже забота гугла как они там прописали какие их серверы являются валидными. все это не наша проблема.

а наш отправляющий сервер мы зашифровали через include:vasya.kuku.ru
подчекрну что vasya.kuku.ru это не DNS имя нашего непосредственного smtp отправляльщика. нет! ссылка идет непрямая а опосредованная.

мы говорим что чтобы spf запись для домена @kuku.ru считалась выполенной
надо прочитать spf запись ОТ ДРУГОГО ДОМЕНА @vasya.kuku.ru  и если она выполнена то и наша spf считается выполненной.

ну и получается уже втой spf записи указано конкретное условие признака 
валидного сервера

vasya.kuku.ru TXT v=spf1 ip4:99.99.99.124/32

вот таким макаром прописывают валидные ip адреса уполномоченных smtp серверов для домена.

уж совсем конкретно из жизни обычно делают так.

заводят две записи.

первая запись

kuku.ru TXT v=spf1 include:_spf.kuku.ru -all

и вторую запись

_spf.kuku.ru TXT v=spf1 ip4:99.99.99.124/32  ip4:8.8.8.0/24 ip4:3.3.0.0/16

замечу что это две spf записи НО!  формально для разных доменов.
с точки зрения kuku.ru у него одна spf запись ( и это правильно)
просто она ссылается на spf запись в другого домена.
домен должен иметь только одну spf запись.

и в итоге мы для нашего домена прописали опосредованно с каких IP могут 
посылать уполномоченные нами smtp сервера.

зачем такая двойная запись почему несделать сразу одну.
потому что это дает гибкость.

если у нас появляетс вторая площадка с которой мы будет остылать письма
и той площадкой мы незаведуем то мы в первую запись просто добавим +1 include

kuku.ru TXT v=spf1 include:_spf.kuku.ru  include:_spf.google.com
-all

таким образом появляется удобство гибкость при изменении структуры 
отправляющих серверов. если бы мы сразу пихали конечные ip адреса 
в нашу запись то нужно было бы тогда пихать и все гугловские ip адреса
а мы их просто и незнаем. а так это и ненаша забота.
удобно.

замечу что при такой схеме DNS имена отправляющих smtp серверв вообще никак здесь не участвуют их нет. мы их вообще неиспользуем.

в spf записи помимо опций  ip4, include есть и другие опции .
о них надо читать отдельно.

например есть опция mx.
она говорит что отправлящий сервер должен попадать в mx запись этого домена. по мне это ненужная опция. потому что mx сервера это сервера принимающе почту. а spf запись она касается серверов отправляющих почту.
и они необязаны быть связаны. принимать могут одни а отправлят могут
соврещенно другие. поэтому если конечно так случилось что у вас и принимающие и отправляющие одни и теже то можно в spf просто тогда указать опцию spf.

про другие опции spf читай отдельно. 


===


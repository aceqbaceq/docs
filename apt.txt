
apt




БОЛЬШОЕ ОСНОВАТЕЛЬНО описание про то как прописывать репозитории apt и что они значат.


придется разобраться с репозитриями ибо очень зае*ло тема мутная.


в папке /etc/apt/sources.list.d/ мы имеем  файл vasya.list
deb [arch=amd64]    http://ftp.ubuntu.com/ubuntu  bionic               main multiverse restricted universe


что значат эти загадочные параметры

deb = просто хрень
[arch=amd64] = значит что нас интеерсуют только пакеты с архитектутрой 64bit
http://ftp.ubuntu.com/ubuntu  bionic    main multiverse restricted universe = самое интересное





значит по адресу http://ftp.ubuntu.com/ubuntu
лежит вот такая структура папок


[DIR]	dists/	
[DIR]	indices/	
[файл] ls-lR.gz	
[DIR]	pool/	
[DIR]	project/	
[DIR]	ubuntu/


возникает вопрос какой URL надо вбивать в конфиге от чего оно зависит что ожидает увидеть apt
через этот URL. так вот я утверждаю что в конфиге нужно вводить такой урл чтобы и я вот тут  я щас обьясню.

возьмем вначале полную строку

http://ftp.ubuntu.com/ubuntu  bionic    main multiverse restricted universe = самое интересное

но рассмотрим толко ее часть.


http://ftp.ubuntu.com/ubuntu  bionic 

так вот эта часть строки должна быть ровно такая чтобы если ее возьмет apt то чтобы сущестовал файл
с путем

http://ftp.ubuntu.com/ubuntu/dists/bionic/InRealease


тоесть этот дебилоидный apt добавляет dists потом еще добавляет bionic и в этой папке ищет файл InRelease
вот какой смысл этой дебильной строки. это куски пути на сайте к файлу InRelease. какого хуя они явно 
неукзавыают папку dists непонятно.


итак еще раз если у нас в vasya.list есть строка:
deb [arch=amd64] https://repo.skype.com/deb stable main

то она в частности значит что apt будет искать файл InRelease в папке
https://repo.skype.com/deb/dists/stable/InRelease

тоесть если обозначить 
https://repo.skype.com/deb=A1   а stable=B1 
то путь к файлу InRelease в этом репозитории обязан быть

A1/dists/B1/InRelease

и действительно стрктуру папок если открыть https://repo.skype.com/deb/dists/stable/


[   ]	InRelease	2023-01-03 10:30	4.4K	 
[   ]	Release	2023-01-03 10:30	3.9K	 
[   ]	Release.gpg	2023-01-03 10:30	488	 
[DIR]	main/	2023-01-03 10:30	-	 



таким макаром если у нас есть в файле vasya.list строка
deb [arch=amd64]    http://ftp.ubuntu.com/ubuntu  bionic               main multiverse restricted universe

то большую часть ее смысла мы раскрыли. тоесть большая часть ее предназначена чтобы
найти и скачать файл InRelease. 

чтоже значит отставшая ся часть  main multiverse restricted universe

это так называемые компоненты. что дает указание компонента. оно дает то что до этого ммоента мы только 
скачали файл InRelease но этого мало. там нет всей инфо. пакеты в репозитории разбиты по группам.
эти группы называются компоненты. чтобы скачать хоть один пакет надо указать в какой группе мы будем
искать компоненты. так вот  main multiverse restricted universe это уже компоненты тоесть группы 
пакетов в репозитриии.

что по факту происходит с точки зрения apt когда мы указали имя компонента. дает то что он 
пытается скачать файлы 


http://ftp.ubuntu.com/ubuntu/dists/bionic/main/binary-amd64/Release
http://ftp.ubuntu.com/ubuntu/dists/bionic/main/binary-amd64/Packages.gz или Packages.xz

вот что для apt значит указание компонента.

тепрь мы полность расшифровали физ смысл строчки. как ее юзает apt что он делает с ней.


вот эти вот файлы InRelease, Release, Packages.xz это все толко списки пакетов украшенные PGP хэшами.
тоесть из этих хреней apt узнает про список файлов на том репозитории и где они там лежат.тоесьт это
некая индексная информация. 
вот что это по факту дает. сами пакеты сгруппирование по алфавиту лежат по факту в папке 

http://ftp.ubuntu.com/ubuntu/pool/

но это уже внутреняя кухная apt нам туда руками лазит ненадо. просто я хотел выразить то что в папках 
что мы рассмотрели выше там самих пакетов нет . там толко индексная ифнлморация.


также показывают как вглядит папка с компонентами main multiverse итд

путь = http://ftp.ubuntu.com/ubuntu/dists/bionic/
папка выгляидит как


[   ]	Contents-amd64.gz	2018-04-26 05:59	38M
[   ]	Contents-i386.gz	2018-04-26 07:25	37M
[   ]	InRelease	2018-04-26 23:38	236K
[   ]	Release	2018-04-26 23:38	236K
[   ]	Release.gpg	2018-04-26 23:38	819
[DIR]	by-hash/	2017-10-25 09:04	-
[DIR]	main/	2018-04-24 01:33	-
[DIR]	multiverse/	2017-10-25 13:33	-
[DIR]	restricted/	2017-10-24 22:44	-
[DIR]	universe/	2017-10-25 13:33	


я это к тому что если мы зашли в эту папку то визуально мы сразу можем определить названия компонентов
этого репозитория = main, multiverse, restricted, universe, by-hash


далее немножка как выглядит InRelease файл внутри что там в нем
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

Origin: Ubuntu
Label: Ubuntu
Suite: bionic
Version: 18.04
Codename: bionic
Date: Thu, 26 Apr 2018 23:37:48 UTC
Architectures: amd64 arm64 armhf i386 ppc64el s390x
Components: main restricted universe multiverse
Description: Ubuntu Bionic 18.04
MD5Sum:
 32a92a5c20f378d42dd2d2f4f28f6637        628836439 Contents-amd64
 53c6a594819b51a5755f88b45d1eff7f         37766986 Contents-arm64.gz
 cd7bf6d50403da4348ee48138eace986        585939706 Contents-ppc64el

если репонеимеет файла InRelease то apt пытается в той же папке найти файл Release 
который выглядит примерно также



далее. вверху мы рассаотрели файл vasya.list
deb [arch=amd64]    http://ftp.ubuntu.com/ubuntu  bionic               main multiverse restricted universe

но ест и другой формат записи пути к репозиторию.  первое важнео отличие имя файла должно заканчиваться
не на .list а на .sources !!!! ЕЩЕ РАЗ ЭТО ОЧЕНЬ ВАЖНО. файл с алтернативной формой пути записи 
к репозиторию долже заканчиваться не на .list а на .sources

/etc/apt/sources.list.d/vasya.sources
# cat vasya.sources 

Types: deb
URIs: http://ftp.ubuntu.com/ubuntu
Suites: bionic
Components: main multiverse restricted universe
Architectures: amd64


далье уже нам выбирать какая форма записи пути к репозитори нам больше нравтся.

в заключении хочу сказать что man sources.list можно читать это не совсем сборище мусора как обычно.

также вот эта страница тоже раскрыла глаза = https://wiki.debian.org/DebianRepository/Format

из нее видно то же самое что я только что описал а именно
что строка в .list файле имеет вид:


deb uri distribution [component1] [component2] [...]


они дают пример

deb https://deb.debian.org/debian stable main contrib non-free


при этом 

https://deb.debian.org/debian  = называется uri
stable = называется distribution
main = называется компонент1


они говрят что 

Here deb specifies that this is source for binary packages, deb-src is for source packages.
The uri, in this case https://deb.debian.org/debian specifies the root of the archive. далее они называют его как  $ARCHIVE_ROOT

далее они гвоорят что distribution в нашем случае это stable описывает вот такую подпапку 
$ARCHIVE_ROOT/dists/$DISTRIBUTION которая должна существовать в которой apt ищет файл InRelease 
а если его там нет то он тамже ищет файл Release

длаее они переходят к компонентам и говорят что 
To download the index of the main component, apt would scan the Release file for hashes of files in the main directory. eg. https://deb.debian.org/debian/dists/testing/main/binary-i386/Packages.gz which would be listed in https://deb.debian.org/debian/dists/testing/Release as main/binary-i386/Packages.gz

вэтом примере они рассмотрели поиск пакетов для i386 архитерутуры. если же мы  вставили в нащу строчку
вот такую хрень [arch=amd64] то тоода поиск будет идти пактов 64битной архитекуры уже в другой папке

https://deb.debian.org/debian/dists/testing/Release as main/binary-amd64/Packages.gz


вот и все с этим ебучим apt-ом


получается каждая строчка вида 

deb https://deb.debian.org/debian stable main contrib non-free

это отдльный репозиторий. в этом репозитории пакеты разделены на группы чем больше
мы справа добавляем тем больше мы групп пакетов включаем. имена групп можно узнать если 
зайти в по урл в папку https://deb.debian.org/debian/dists/stable 
и посмотреть названия папок в этой папке


еще пример файла .sources у котрого использован новый формат описания репозитория

# cat /etc/apt/sources.list.d/ubuntu-de.sources 

Types: deb
URIs: http://mirror.ip-projects.de/ubuntu
Suites: bionic
Components: main multiverse restricted universe
Architectures: amd64



=====
apt-file

если нужно найти пакет который содержит какойто файл по имени то юзаем apt-file.

фишка в том что мы ищем имя нетого пакета который уже установлен а имя пакета который
еще неустанвлен который бы содержал некоторый файл. 

-----

apt 
gpg



apt испольщзует такую фичу как gpg

gpg это как у ssh это несимметричное шифрование. 
в apt исоплзуется фича называемая цифровая подпись.

идея такая: есть приватный ключ и есть публинчный ключ. мы берем сообщение\дату\текст и вычисляем
от него хэш MD5. далее мы используя приватный ключ шифруем этот хэш - это называется цфировая подпись.
далее мы берем исходный текст и приклаываем к нему цифровую подпись . 
 клиент получает сообщение и цифровую подпись. клиет вычисляет самостоятельно хэш MD5 от текста. 
далее  клиент берет свой публичный ключ и используя его дешифрует
 цифроую подпись и получает хэш MD5. и сравниваем полученный нами самтсоятельно MD5 пуетем вычисления его 
 от текста и сранививаем с MD5 который мы получили дешифруя цифровую подпись. если  текст был изменен 
 либо цифровая подпись фальшика то наши MD5 несовпадут.

 в случае apt его репозитоиии используют цфировые подписи gpg.

 как щас выяснмм.

 пока что известно вот что для кажого пакета на хосте хранится md5 хэш. а точне даже получается для каждог
 файла из пакета хоанится его md5 хэш

вот например для файлов из пакета bash

$ cat /var/lib/dpkg/info/bash.md5sums 
557c0271e30cf474e0f46f93721fd1ba  bin/bash
b7a48bd96ff18a87f86613fa05675877  usr/bin/bashbug
0cc02aca10031ffe9875e6420d06ad55  usr/bin/clear_console
3f54cfae6ffbd0a555b0a5c86b02276d  usr/share/doc/bash/COMPAT.gz
ab78b78be766692463cb112b88d5a74f  usr/share/doc/bash/INTRO.gz
df07599f46e06a04d214eeb258b0b039  usr/share/doc/bash/NEWS.gz
f28edb636ee9c337aaa0bc144a700c4c  usr/share/doc/bash/POSIX.gz
172188e3a6fc5409d4f113485cc6d79f  usr/share/doc/bash/RBASH
8fde8d2d8baffee3ed5849e7c4b1bda9  usr/share/doc/bash/README
6bd7de8b98911613a536e83867e9b490  usr/share/doc/bash/README.Debian.gz
5dac7b9b6332d9845e315cf8fd50ea89  usr/share/doc/bash/README.abs-guide
007dea9b8141f038c602b23f78509e34  usr/share/doc/bash/README.commands.gz
a23c21b8dfa4d8c539512919f6da5185  usr/share/doc/bash/changelog.Debian.gz
9632d707e9eca8b3ba2b1a98c1c3fdce  usr/share/doc/bash/copyright
244319c9dd88c980910aacd76477b8d9  usr/share/doc/bash/inputrc.arrows
4574de6676d74019761f409168aa8e01  usr/share/lintian/overrides/bash
47f78a9a3e209eab17ac68993a0b02a8  usr/share/man/man1/bash.1.gz
ab8320c478c9d17caaa4d86e113cf0a2  usr/share/man/man1/bashbug.1.gz
0c912132bdbce02861669392deb3f84c  usr/share/man/man1/clear_console.1.gz
6ad61b838c1370d3bed5d4410644f34a  usr/share/man/man1/rbash.1.gz
b2fb88f251700c29d638d9202e89a693  usr/share/man/man7/bash-builtins.7.gz
0c05a14279f95fdb4618a4ccaa469681  usr/share/menu/bash



а вот как проверить что файлы после установки остались неимзенными

$ debsums bash
/bin/bash                                                                     OK
/usr/bin/bashbug                                                              OK
/usr/bin/clear_console                                                        OK
/usr/share/doc/bash/COMPAT.gz                                                 OK
/usr/share/doc/bash/INTRO.gz                                                  OK
/usr/share/doc/bash/NEWS.gz                                                   OK
/usr/share/doc/bash/POSIX.gz                                                  OK
/usr/share/doc/bash/RBASH                                                     OK
/usr/share/doc/bash/README                                                    OK
/usr/share/doc/bash/README.Debian.gz                                          OK
/usr/share/doc/bash/README.abs-guide                                          OK
/usr/share/doc/bash/README.commands.gz                                        OK
/usr/share/doc/bash/changelog.Debian.gz                                       OK
/usr/share/doc/bash/copyright                                                 OK
/usr/share/doc/bash/inputrc.arrows                                            OK
/usr/share/lintian/overrides/bash                                             OK
/usr/share/man/man1/bash.1.gz                                                 OK
/usr/share/man/man1/bashbug.1.gz                                              OK
/usr/share/man/man1/clear_console.1.gz                                        OK
/usr/share/man/man1/rbash.1.gz                                                OK
/usr/share/man/man7/bash-builtins.7.gz                                        OK
/usr/share/menu/bash                                                          OK



 


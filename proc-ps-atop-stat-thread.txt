| atop
| ps
| proc
| cpu
| thread


мне пришел очень приклольрный вопрос
положим у нас есть процесс у которого несколько тредов

как организована статистика в /proc про такой процесс.
у нас про каждый тред процесса его индивиуальные файлы статистики
лежат в 
	/proc/pid/tasks/tid1/...
    /proc/pid/tasks/tid2/...
	/proc/pid/tasks/tid3/...
	/proc/pid/tasks/tid4/...
	/proc/pid/tasks/tid5/...

а в папке
	/proc/pid/...
лежат файлы просто напросто от главного треда тоесть
	/proc/pid/... =    /proc/pid/tasks/tid1/...

и тогда мы вспоминаем про ps и atop
они могут показывать статистику загрузки по цпу в режиме 
тредов и в режиме процессов. и возникает ВОПРОС -  а когда они 
показывают статистику в режиме "статистка по процессам"
они показвыают статистику из папки 
	/proc/pid/...
а более точно из файла
	/proc/pid/stat
тоесть это СТАТИКАТИКА всего навсего по главному треду!
но это же нестатистика по сумме всех тредов процесса!
или же ps и atop они смотрят статистику по всем тредам процесса. 
СУММИРУЮТ ЕЕ! и потом на экране показывают сумму.
ТАК Я РАЗОБРАЛСЯ! действииельно эти утилиты они суммируют статистику
по всем тредам процесса тоесть они посещают все папки 
	/proc/pid/tasks/tid1/...
    /proc/pid/tasks/tid2/...
	/proc/pid/tasks/tid3/...
	/proc/pid/tasks/tid4/...
	/proc/pid/tasks/tid5/...
собирают там статсистику
суммируют ее. 
и уже ЕЕ показывают на экране как результат сколько % cpu
сожрал этот процессс! тоесть ps и atop в режиме "статистики процесса"
работают как положено умно. потому что действительно да - процесс
это ГРУППА ТРЕДОВ. и если мы хотим получить статистику по процессу
то это ровно значит что нужна статистика по группе тредов! суммарная
статискактиа по группе тредов! это и есть статисктика по процессу!

яя просто привые что вбивалсь в голву все эти годы что процесс 
это то что суется на цпу в шедулере. а это полная хуйня. процесс
это ГРУППА! а группу на цпу никто несует! на цпу суются треды.
просто треды обьединены в группы! а нам очень долго вбивади в голову
что якобы процесс это и есть тред. а полная хуйня. просто если 
проесс состоитиз одного треда то "как бы" получается что процесс
суется на цпу. но это очень плохая аналогия. 

поэтому ps и atop в режиме "статика по процессам"  они обходят все 
треды процесса. суммируют нагрузку и на экране показывают уже сумму.

а врежиме "статистика по тредам" они уже показывают саттитистику
по треду. просто напросто ее беря из файла /proc/pid/task/tid/stat

ещераз скажу в режиме "статика по процессу" эти утилиты они 
не берут статистик из файла /proc/pid/stat это была бы полная хуйня.
я вообще не понимаю зачем проц в эту папку кладет файл stat.
да в режиме когда у нас в процессе один тред то этот файл
показывает сатститику по всему процессу. но! в режиме когад у нас 
процесс имеет неоклько тредов этот файл только сука вносит
полную неразбериху и сумятицу! он всего нвсего покаызвает статистику
по головному треду! а нахуй она мне нужна! 

посмортреть в ps статистику в режиме тредов можно через 
кнопку Shift+H

в atop стастика в режиме тредов смотрится по кнопке "y"

делаем так. запускаем на компе многотредовй процесс. наример 
это скжем qemu-system-x86_64 или хром. они явно многотредовые.
причем у них треды загружены совешрешенно по разному.

далее в одном окне открывает 
	$ top -d 5
во втором 
	$ top -d5
во втором окне тыкаем Shift+H
а потом сранвиаем то что показано влевом окне для процесса PID
с тем что для тредов этого процеса показанов правом окне.
и все станет видно как я сказал!

для atop все попроще. отарвыает atop. и тыкаем туда обратно кнопку
"y" и можно тоже увидеть то очем я описал выше.

итак показываю как это выглядит у atop
вот что пкзывае atop для процесса в режиме "статикика процессов"
 PID              CPU%   CMD
 3496             44%    qemu-system-x8


а вот что он показывает для того же самого сэмпла и того
же самого процесса но в режиме "статикика для тредов" 
 PID      TID     CPU%   CMD
 3496        -    44%     qemu-system-x8    *****
 3496     3496     2%     qemu-system-x8
 3496     3502     0%     qemu-system-x8
 3496     3503    21%     qemu-system-x8
 3496     3507     0%     SPICE Worker
 3496     3508    21%     qemu-system-x8

так вот соверщенно ясно видно что статисика "для процесса"
это сумма статистик по всем тредам этого процесса!
единсвтенное что atop в режиме "статисткии для тредов"
он все таки покзывает нетолко треды но и процесс ну тоесть
тепрь мы понимаем что нет такой единицы в плане шедуоера как 
процесс. нет такого ентити. поэтому под процесом мы понимаем
"суммарна статика по тредам". поэтму режиме статистики 
по тредам atop показывает смешанную статитику по тредам
и в тоже время и суммарную статику по процессу!
поэтому треды дают 2% , 21% , 21% 
а процесс получается имеет 44%
которое в точности соотвсвутаует сумме
	44% =  2%+21%+21%


тоже самое про ps
вот для одного и того же семпла времени 
мы имеем. 
статика в "режиме процссов"

 PID    CPU%    CMD
 3496   43,7    qemu-system-x86                                                                           


статтистика в "режиме тредов""
 TID    CPU%    CMD
 3503   21,0    qemu-system-x86                                                                            
 3508   22,7    qemu-system-x86  

и тоже четко видно то что ps в "режиме  процессов"
покзывает именно суммарную статистику по всем тредам 
процесса а не статистику по главному тредоу процесса из 
файла /proc/pid/stat!

КРУТО!!! мне это было изначально неочевидно!!!!!
утилиты молодцы!!!


еще вопрос приходит вот у нас ps \ atop в режиме 
"статистики  по процессам". и ему нужно чтото рисовать в 
графе STATE там где R\S\D итп.
но стейт он же относится только к тредам! потому что только треды
суются шедулером на цпу! поэтому понятие STATE для процесса (группы
тредов) не имеет никакого смысла! однако как видно в atop\ps
они там в режим "статика по процессам" однако всегда рисуют 
некий стейт. например S. откуда они его берут что за бред?!
я считаю что они делают бред. но они делают вот что - они в этом 
столбике рисует состояние МАСТЕР ТРЕДА для этого процесса!
вот что они показывают!

поэтому вопрос в каком щас стейте находится процесс? 
типа человек хочет понять щас процесс нахрлится на цпу или нет.
так вот если процесс много
тредовый то этот вопрос неимеет нкакого смысла! 
потому что чтобы на него ответить нужно тогда сообщить в ответ 
человеку все стейты от всех тредов! и тогда скажем получится
что три треда имеют S а два имеют R
но тогда вопрос этот процесс он щас на цпу или нет?
как это трансилирвать. ну часть процесса нахоистя на цпу а часть нет.
а так чтобы сказать процесс унас в состоянии S - это полная хуйня. 
для этого надо чтобы все треды были S. вобщем! - ps и atop
они незаморвачиваются. они в случае многотредового прцоесса
и в режиме "статиска по процссам" всего навсего прикалываются
и покаызывают в графе STATE состояние мастер треда этого процесса!
по мне это пиздец и офигенно засирает мозг!!!
 
и еще раз хочу подчеркнуть момент что во всех файлах папки
	/proc/pid/
показаны файлы из папки
	/proc/pid/task/главный_тред/
это важно четко понимать!
важно понимать что в /proc/pid в случае многтедового процесса
нихрена не показана "суммарная статистика процесса" НИХРЕНА!
там показан статистка всего нвсего про сраный мастер тред!
по мне это пиздец как мислидинг!!!!!!

узнать какие версии elasticsearch доступны


# apt-cache madison elasticsearch


установить версию определенную пакета

# apt-get install elasticsearch=5.6.3

cтавим elasticsearch

# apt-get install elasticsearch=5.6.3

ставим x-pack на elasticsearch
сразу важно обьяснить что же эта за хрень x-pack

это плагин.

он добавляет некий функционал.

этот плагин ставится на кучу программ.
он ставится на эластиксерч, на кибану, на логстэш и еще на всяко разно.
причем в кажду программу его нужно ставить ОТДЕЛЬНО.
отдельно накатывать на эластиксерч, отдельно накатывать на кибану итд.

захуя он нужен. 
если мы ставим его на эластиксерч то он навскидку создает спец индексы в эластике и начинает туда лить специнформацию. 
например  он начинаем собирать и лить информацию по статистике работы кластера. это впервую очередь и есть ради чего я его ставлю. 
чтоб снимать статистику по перфомансу кластера. 
также он добавляет в эластик возможность работать с юзерами ролями итп. но этот функционал платный. если у нас лицензия бейсик
то в ней эта фича недоступна. какие еще есть фичи в x-pack буду освещать походу их использования.

причем чтобы восолтзоваться записанной x-pack статистикой работы кластера мало только поставить x-pack на эластик.
также надо поставить кибану да еще и накатить x-pack на кибану. потом увязать кибану и эластик. и только тогда мы 
сможем вкусить саттистику работы эластика в кибане. но все по порядку.

ставим x-pack на эластика. ( еще раз скажу что дока у эластик гавно.. пока я это все понял..... эх.. )

плагины  в эластике ставятся через спец утилиту эластика

# /usr/share/elasticsearch/bin/elasticsearch-plugin install x-pac


при этом получим ошибку

[=================================================] 100%  
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@     WARNING: plugin requires additional permissions     @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
* java.io.FilePermission \\.\pipe\* read,write
* java.lang.RuntimePermission accessClassInPackage.com.sun.activation.registries
* java.lang.RuntimePermission getClassLoader
* java.lang.RuntimePermission setContextClassLoader
* java.lang.RuntimePermission setFactory
* java.security.SecurityPermission createPolicy.JavaPolicy
* java.security.SecurityPermission getPolicy
* java.security.SecurityPermission putProviderProperty.BC
* java.security.SecurityPermission setPolicy
* java.util.PropertyPermission * read,write
* java.util.PropertyPermission sun.nio.ch.bugLevel write
* javax.net.ssl.SSLPermission setHostnameVerifier
See http://docs.oracle.com/javase/8/docs/technotes/guides/security/permissions.html
for descriptions of what these permissions allow and the associated risks.


я просмотрел кучу доков. и все кладут болт на эти настройки.
итак просто игнорим.

перезапускаем эластик

# # service elasticsearch restart

проверяем что x-pack установлен на хосте

# /usr/share/elasticsearch/bin/elasticsearch-plugin list
x-pack

x-pack он платный. они дают 30 дней на зценить.
потом у него часть функционала отваливается.

остаестся только 
мониторинг
search profiler
debugger

якобы вот эти джаава пермишнс нужна для двух вещей. для алертинга по почте и чегото там про машинлернинг.


после того как мы установили x-pack нам его даже ненужно активировать в конфиге эластике.
плагин уже работатает.

и как первое следствие теперь просто так доступ к кластеру неработает. спрашивает логин и пароль.
поэтому отключаем аутентификацию при доступе к кластеру.

# cat elasticsearch.yml
...
xpack.security.enabled: false


перезапускаем эластик.  готово.

далее.
по умолчанию у нас 30 дневная триальная лицензия на эластик. проверяем статус лицензии

~# curl http://test-es3:9200/_license/
{
  "license" : {
    "status" : "active",
    "uid" : "73473f97-9efe-489b-9ad0-71b77b09c1df",
    "type" : "trial",
    "issue_date" : "2019-10-04T21:02:27.361Z",
    "issue_date_in_millis" : 1570222947361,
    "expiry_date" : "2019-11-03T21:02:27.361Z",
    "expiry_date_in_millis" : 1572814947361,
    "max_nodes" : 1000,
    "issued_to" : "elasticsearch",
    "issuer" : "elasticsearch",
    "start_date_in_millis" : -1
  }
}


видно что лицензия триальная.

заходим на сайт эластика регаемся и заказыаем basic беплатную лицензию. и на почту приходит ссылка на файл с лицензией.
ее нужно впихнуть в эластик.

через запрос

POST /_license
{
  "licenses": [
    {
      "uid":"893361dc-9749-4997-93cb-802e3d7fa4xx",
      "type":"basic",
      "issue_date_in_millis":1411948800000,
      "expiry_date_in_millis":1914278399999,
      "max_nodes":1,
      "issued_to":"issuedTo",
      "issuer":"issuer",
      "signature":"xx"
    }
    ]
}


при попытке впихнуть базовую лицензию в эластик он пишет


{
"acknowledged": false,
"license_status": "valid",
"acknowledge": {
"message": "This license update requires acknowledgement. To acknowledge the license, please read the following messages and update the license again, this time with the "acknowledge=true" parameter:",
"watcher": [
"Watcher will be disabled"
],
"security": [
"The following X-Pack security functionality will be disabled: authentication, authorization, ip filtering, and auditing. Please restart your node after applying the license."
,
"Field and document level access control will be disabled."
,
"Custom realms will be ignored."
],
"monitoring": [
"Multi-cluster support is disabled for clusters with [BASIC] license. If you are running multiple clusters, users won't be able to access the clusters with [BASIC] licenses from within a single X-Pack Kibana instance. You will have to deploy a separate and dedicated X-pack Kibana instance for each [BASIC] cluster you wish to monitor."
,
"Automatic index cleanup is locked to 7 days for clusters with [BASIC] license."
],
"graph": [
"Graph will be disabled"
],
"ml": [
"Machine learning will be disabled"
]
}
}


то есть часть функционгала будет вырублена нахер. так происходит когда мы впихиываем лицензию которая более урезающая чем была. 
у нас была полная но на 30 дней а мы пихаем базовую.

чтобы впихнуть базовую надо  добавить параметр acknowlege=true

POST /_license?acknowledge=true
{
  "licenses": [
    {
      "uid":"893361dc-9749-4997-93cb-802e3d7fa4xx",
      "type":"basic",
      "issue_date_in_millis":1411948800000,
      "expiry_date_in_millis":1914278399999,
      "max_nodes":1,
      "issued_to":"issuedTo",
      "issuer":"issuer",
      "signature":"xx"
    }
    ]
}


успех. проверяем текущую лицензию

# curl http://test-es3:9200/_license
{
  "license" : {
    "status" : "active",
    "uid" : "210f3f42-52e4-4edb-9429-f6758fb47061",
    "type" : "basic",
    "issue_date" : "2019-09-05T00:00:00.000Z",
    "issue_date_in_millis" : 1567641600000,
    "expiry_date" : "2020-09-05T23:59:59.999Z",
    "expiry_date_in_millis" : 1599350399999,
    "max_nodes" : 100,
    "issued_to" : "Al",
    "issuer" : "Web Form",
    "start_date_in_millis" : 1567641600000
  }
}

видно что лицкнзия активно неистекла и что она бейсик

как видно из того что выше при бейсик лицензии security отключается. нет аутентификации нет юзеров итп.

закончили мы на rbac активации при бейсик лицензии.

как я понял из дурацких перекрестноссылочной говно доки от эластик -  авторизацию аутентификацию 
обеспечивает именно плагин x-pack соотвесвтенно если в его бесплатной версии этот функционал отключен.
значит либо плати либо иди нахуй.

когда мы поставили x-pack то в нем уже есть несолько предустановленных юзеров.

эти юзеры принадлежат к ролям ( аналог групп в виндовсе). таковые юзеры

elastic принадлежит роли superuser другими словами полный доступ ко всему и вся

kibana этот юзер используется кибаной для того чтобы под этим юзером иметь доступ к эластику.

logstash_system бла бла.


что я понял - если у нас лицензия непозволяет работать с какойто фичей эластика например у нас базовая лицензия 
которая непозволяет работать с фичей security от плагина x-pack то : буквально почти никакие команды от данной фичи работать не
будут . например посмотреть список пользователей будет посмотреть нельзя. список ролей посмотреть будет нельзя . 
и тому подобное. от фичи security будет работать некий убогий супер минимум.да. в этом тоже прикол. 
фича по лицензии недоступна ( тут тоже полная хуйня  и неразбериха. у них на сайте сказано что лицензия бейсик она
дает овзможность работаь с роолями и юзерами. а при установке лицензии x-pack сразу говорит что security фича не будет работать).
тем не менее после установки x-pack и перезапуска эластика при попытке обраться к эластику по 9200 выплывет окно которое спросит
логин и пароль. типа чего блядь?  фича же неработает .однако как показала практика всеже убого эта фича работает
на том уровне что можно залогинться на кластер под акаунтом уже встроенным при установке x-pack

l:elastic
p:elastic

это креды типа суперюзера в эластике.

итак. чтобы нееобаться с этой фичей и юзерами - идем в конфиг и этот функционал нахуй дизейблим.


# cat elasticsearch.yml
...
xpack.security.enabled: false

как тока мы это сделали. то доступ ко всем ресурами эластика без всяких ограничений.
без всякий аутентификаций и юзеров.

далее вся тема о юзерах ролях итп это все сразу уже просто недоступно отваливается и об этом
можно забыть в эластике

индексы вида 

.watcher*
.monitoring*

это индексы которые автоматом заводит x-pack


итак эластик поставили.
бейсик лицензию вбили
на эластик x-pack накатили.
функционал security нахер выключили.

ставим кибану.

как я понял. с бейсик лицензией для каждого кластера эластик надо ставить свою кибану. 
то есть кибана несможет обслужвать несколько эластиков. это недаст лицензия.


еще сразу замечу что щас четко девеплоеры сказали что все версии должны одинаковы у компоненетов - у кибаны эластика логстэша и прочих.
у всех должна быть едтиная версия.

выясняем установленную версию эластика к которому мы будем привязывать кибану

# dpkg -l | grep elas
ii  elasticsearch                      5.6.3

смотрим доступна ли эта же версия кибаны

~# apt-cache madison kibana

ставим версию 5.6.3

~# apt-get install kibana=5.6.3

ставим x-pack на кибану

# /usr/share/kibana/bin/kibana-plugin install x-pack


насоклько я понял в кибану лицензии вбивать никакие ненужно

# systemctl enable kibana
# systemctl start kibana

доступ к кибане по порту :5601


замечу по конфигу кибаны

# cat /etc/kibana/kibana.yml | grep -v '#'

server.host: "test-es3"


зачем эта опция нужна.

по дефолту кибана открывает сокет на 127.0.0.1:5601

поэтому чтобы зайти на кибану надо ей настрить чтобы она открыла сокет для внешних соединений на некий IP.

так вот можно там  прописать напрямую IP хоста. но! если потом мы его поменяе то придется еще раз менять в конфиге кибаны.
так вот более круто добавить hostname вместо IP . тогда поменяв ip на хосте впоследствии никак не сломает кибану.


далее. поставил я все это. пытаюсь зайти на кибану через браузер

host:5601

а оно мне выводит окно для логина и пароля. и пишет что мол есть проблема с лицензией на эластике поэтому проверяйте на эластике.

так нупонятно что раз на эластике мы отключили seciruty то есть юзеров то на кибане тоже нужно отключить.

итак заносим в конфиг эластика фичу


# cat /etc/kibana/kibana.yml  | grep -v '#'

server.host: "test-es3"

xpack.security.enabled: false

перезапускаем кибану.

и тут мы видим что она никак нехочет вставать.

порт 5601 неначинает слушаться.

лезем в  syslog и видим


 Started Kibana.
Oct  6 22:57:39 test-es3 kibana[9218]: {"type":"log","@timestamp":"2019-10-06T19:57:39Z","tags":["fatal"],"pid":9218,"level":"fatal","message":"EACCES: permission denied, open '/usr/share/kibana/optimize/bundles/graph.entry.js'","error":{"message":"EACCES: permission denied, open '/usr/share/kibana/optimize/bundles/graph.entry.js'","name":"Error","stack":"Error: EACCES: permission denied, open '/usr/share/kibana/optimize/bundles/graph.entry.js'\n    at Error (native)","code":"EACCES"}}
Oct  6 22:57:39 test-es3 kibana[9218]: FATAL { Error: EACCES: permission denied, open '/usr/share/kibana/optimize/bundles/graph.entry.js'
Oct  6 22:57:39 test-es3 kibana[9218]:     at Error (native)
Oct  6 22:57:39 test-es3 kibana[9218]:   cause:
Oct  6 22:57:39 test-es3 kibana[9218]:    { Error: EACCES: permission denied, open '/usr/share/kibana/optimize/bundles/graph.entry.js'
Oct  6 22:57:39 test-es3 kibana[9218]:        at Error (native)
Oct  6 22:57:39 test-es3 kibana[9218]:      errno: -13,
Oct  6 22:57:39 test-es3 kibana[9218]:      code: 'EACCES',
Oct  6 22:57:39 test-es3 kibana[9218]:      syscall: 'open',
Oct  6 22:57:39 test-es3 kibana[9218]:      path: '/usr/share/kibana/optimize/bundles/graph.entry.js' },
Oct  6 22:57:39 test-es3 kibana[9218]:   isOperational: true,
Oct  6 22:57:39 test-es3 kibana[9218]:   errno: -13,
Oct  6 22:57:39 test-es3 kibana[9218]:   code: 'EACCES',
Oct  6 22:57:39 test-es3 kibana[9218]:   syscall: 'open',
Oct  6 22:57:39 test-es3 kibana[9218]:   path: '/usr/share/kibana/optimize/bundles/graph.entry.js' }


я залез в гугл и в форуме эластика я нашел что это типа известный баг. и есть воркэранд.

# chown -R kibana.kibana /usr/share/kibana/

после этого еще раз перезапускаем кибану

и видим в логах инфо

 Started Kibana.
Oct  6 23:00:06 test-es3 kibana[9642]: {"type":"log","@timestamp":"2019-10-06T20:00:06Z","tags":["info","optimize"],"pid":9642,"message":"Optimizing and caching bundles for graph, monitoring, ml, kibana, stateSessionStorageRedirect, timelion and status_page. This may take a few minutes"}


итак ждем несколько минут и кибана встает. и мы успешно в  нее входим.  
при этом видно в перфоманс мониторе что кибана она непралалелится. она однопроцессорная.


итак вошли в кибану


тут я наткнулся еще на один момент. кибана написала что неможет подключииться к http://localhost:9200

ну это ясно. так как в эластике в конфиге стояло чтобы он слушал входящие на IP:9200
заменил на  0.0.0.0:9200

перезашел в кибану. все окей.


ура.



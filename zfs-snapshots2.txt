| zfs 
| snapshot
| snapshots
| снепшот


по поводу терминнолгии снэпштототов


вот у меня есть датасеты

backup-02 # zfs list -r rpool
NAME               USED  AVAIL  REFER  MOUNTPOINT
rpool             1.25G  61.2G   104K  /rpool
rpool/ROOT        1.25G  61.2G    96K  /rpool/ROOT
rpool/ROOT/pve-1  1.25G  61.2G  1.25G  /
rpool/data          96K  61.2G    96K  /rpool/data
rpool/var-lib-vz   104K  61.2G   104K  /var/lib/vz


я делаю снэпшот датасета

backup-02 # zfs snapshot rpool/ROOT/pve-1@2026_01_07



щас я обьясню что технически происходит при изготовлении снэпшота.
значит зфс держит на диске таблицу метдананных которые указывают какие блоки щас 
заняты на пуле. когда я делаю снэпшот то зфс делает копию этой таблицы метаданных на момент 
снэпшота. и далее на пуле сидит две таблицы метаданных. одна показывает текщуеее состояние занятых блоков
текущей фс. а вторая копия покзывает какие блоки были занты на момент снятие снэпшота.
если я в текущей фс удаляю файл то зфс в текущей таблице метаданных освобждает соотвтвстующие дата блоки. 
но не совсем. при этом зфс смотрит на какие из датаблоков этого файла указают метаданные снэпшота. и 
в итоге зфс вовзращает в пул совободных блоков тольо те которых нет в текущих метаднных и в метданных снэпшоота.
поэтому если я удаляю файл который есть и в снпоте то на самом деле его датаблокт продолжают лежат на пуле
и отжирать место. поэтмоу если я удадю все все файлы с датасета которые есть в снпэпшоте то на пуле места нихерна 
не освобдодится.  толкььо если я сощдам какйто нвоый файл а потом его удалю вот тогда блоки вначалазе займутся а потом
освобадятся. 
тперь по поводу деиилдьной терминлогии
вот я смотрб список снепштотов



backup-02 # zfs list -t snapshot
NAME                          USED  AVAIL  REFER  MOUNTPOINT
rpool/ROOT/pve-1@2026_01_07   600K      -  1.25G  -


что значит USED это соверенно идиотсвоккое слово. на саоммом деле тут должностоять слово UNIQUE BLOCKS
тоесть оно покаызает сколкьо освбодится место на пуле если я удалю снэпшот. тоесть если я удалю эту таблицу метаданных.
и тогда на пуле освободится всего 600К данных. что это значит факчтиески как это поучилось.
я снял снэпшот. а потом на основной живой фс удалил часть файлов.  но так как эти файлы жили на момент снятия снэпшота
а точнее их блоки тогда были заняты то зфс неможет эти блоки щас освободить. в тещкйщей таблице метаданных они как бы
свободны а в таблице метаданых снхпшота они заняты. поэтому чем больше я буду удалять файлов с живой фс тем больше 
будет расти это число в статистике снэпшота. и даже нето что удалять. чем больше я буду изменять контент файлов на живой 
фс даже файлы не удаляя. тем больше на снэпшоте будет расти колонка USED. так как перезапись контента файла у нас всегда
COW то есть на живой фс зфс постоянно одни дата блоки освобждает на  диске  а другие занимает. а снэпшот заморозил
конкретные датаблоки. поэтму если я  перепшишу коненьт файла то сам файл перееддеет на диске в другое место занимая столкьо же 
места но его старе датаблоки завизированы в снэпшоте поэтому ониникуда неденкутся и USED подрастет. 
я бы так сказал 
    колонка REFER показыает на какой суммарный обьем дата блоков указает метаданные этого снэпшота
                  она покзывает суммарный обьем файлов . тоесть если мы будем копировать файлы из этого
                  снэпшота на другую фс то нам нужно будет вот столько места.
    колонка USED указывает на то число датаблоков на которые ни текущая живая фс ни другие снэпшоты не ссылаются.
                 это укникаьные датаблоки присущие именно только этой таблице метаданных. тоесть в этих датабллоках
                 лежат тела файлов на какойто старый конкнтеный момент времени. и раз они лежат в этом снеэпшоте 
                 и болше нинде значит в каких то файлах эти блоки когда уже были имзеннены. либо файл удалили 
                 либо его в этом месте переписали а снэпшот заоморзил завфикировал эти офсеты файлов в во времени. 

пракический смысла колонки USED в том что она покзывает сколкьо места на пуле унас прибавиится или осовобдится если мы
удалим эту таблцицу метаданных этот снэпшот. 



теперь по попводу статикии датасетов



# zfs list 
NAME                            USED  AVAIL  REFER  MOUNTPOINT
POOL-02                        14.5G  12.5T    96K  /POOL-02
POOL-02/proxmox_backup_server    96K  12.5T    96K  /POOL-02/proxmox_backup_server
POOL-02/test-ds-128K           5.78G  12.5T  5.78G  /POOL-02/test-ds-128K
POOL-02/test-ds-1M             8.72G  12.5T  8.72G  /POOL-02/test-ds-1M



колонка USED покзывает какой обьем зманиает этот датасет на пуле + его снэпшоты + его дочерний датасеты + их снэпшоты.
тоесть если удалить этот датасет и его детей и все их снэпшоты то вот столько места освободится на пуле.

клонка REFER покзывает сколько байтов занимает конкнтено этот датасет щас. по простецки можно сказать что это склоько покажет
команда du если зайти в папку этого датасета. НО! обязательно нужно команде du указать (незнаю умеет ли она) чтоненужно
считать обьем дочерних датасетов (тоесть обьем некоторых подпапок). также ественно колнка REFER ничего незнает о снэпшотах



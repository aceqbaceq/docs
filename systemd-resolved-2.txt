| dns
| nss
| systemd-resolved
| nsswitch.conf


вот скажем на компе стоит systemd-resolved
как днс резолвер.

ты типа его остановил и удмаешь ну все
заеись - у меня доступ к днс запросам на компе
отключен.

а нихуя.


во первых прога может делать 
резолв текста в ип двумя путями.

первый путь она использует NSS
тоода смотрим вот сюда


# cat /etc/nsswitch.conf | grep hosts
hosts: resolve files myhostname dns


resolv это плагин SD
и он шлет запрос на него.
если SD выключен то запроса не будет.

files это шарится в хостс файле

myhostname это плагин SD и он работает так 
что если в запросе текст равен хостнейм тот
который из файла /etc/hostname то  вответ
присылает локальный ип одной из сетевых карт.
читай man nss-myhostname
если SD остановен то веренет нихуя

а вот на конце строки стоит dns 
это встроенный DNS киент от глибц
поэтому похуй что SD остановлен 
у нас в итоге будет запущен встроеный днс
клиент который ползет в инет с днс запросом
без проблем. а адрес сервера он возьмет
из resolv.conf
но главное то что SD у нас выыклчен а запрсы днс
в сеть все равно летят. нет никакого блока потому
что на конце тыыцшесрюсщта стоит плагин dns
вот акой пиздец.

поэтому если хочешь выключить днс зарпросы ихсходящие
с компа то только iptables !!!!


кстати  про /etc/resolv.conf
он может быть ссылкой на два разных 
файла 


/run/systemd/resolve/resolv.conf
/run/systemd/resolve/stub-resolv.conf

один из них скажем вот такой

nameserver 1.1.1.1
nameserver 8.8.8.8
nameserver 8.8.4.4


а второй вот такой
nameserver 127.0.0.53
options edns0 trust-ad
search .

я считаю что нужно делать симлинк конечно на второй
хотя вот тоже вопрос куда 
лучше
дело в том что проги могут динамичеаки 
менять настрйоки на SD и в итоге наши запросы
могут лететь черх хуй поми какие днс
срверы. 
я вот незнаю влияет ли димнаичское имзенения
настроек в SD на вот эти файлы

/run/systemd/resolve/resolv.conf
/run/systemd/resolve/stub-resolv.conf


если да то на оба или на один?

я вот уже не помню. а то можно попасть в просак.


так вот а если прога не юзает NSS то она л
как праилло лезет
в resolv.conf
и идет на днс который там указан.




вообщем такая ебала поэому
если хочегт взять под контрль днс реквстеы
с компа
то 


поэтому если хочешь выключить днс зарпросы ихсходящие
с компа то только iptables !!!!




вообще про то как ратают  эти файлы

/run/systemd/resolve/resolv.conf
/run/systemd/resolve/stub-resolv.conf

есть еще и третий файл из этой серии
/usr/lib/systemd/resolv.conf




смешная ситация
ты такой смотршь вот сюда

# pwd
/etc/systemd/resolved.conf.d
[lenovo resolved.conf.d]# cat global.conf 

[Resolve]
DNS=1.1.1.1
#DNS=8.8.8.8
FallbackDNS=8.8.8.8

Domains=.


DNSSEC=no
DNSOverTLS=yes


MulticastDNS=no
LLMNR=no


DNSStubListenerExtra=172.16.10.1
DNSStubListenerExtra=172.16.80.1




думаешь о! у SD днсы нормальные 1.1.1.1 и 8.8.8.8
нет стремных
но при этом забываешь о том что всякие убеданские
программы могут своих днс написах уже
на райтнайеме

в итоге  в
вот здесь вот


/var/run/systemd/resolve
# cat resolv.conf 

nameserver 1.1.1.1
nameserver 8.8.8.8
nameserver 8.8.4.4

nameserver 192.168.235.69
search .


какая сука втавила никому ненужный стремный днс
192.168.235.69
нахуй тут сдался.

ПОЭТОМУ НУЖНО ТОЛЬО ЧЕРЕЗ IPTBALES контрлировать
те днс серваера на которые компу можно ходить!
через конфиги SD это дело ненадежное контролирвать!
ВОТ ГЛАВНАЯ МЫСЛЬ СЕЙ СТАТЬИ СУКА!
иначе можно ходи на стремные днс и об этом счастиливо
нихуя не знать.!


так что про них читай пордробно в  dns-tls.txt !!!
тут так - корткий хуевый обзор!


опять же вот такая мысль.
если мы остановили SD
и убрали file из nsswirtch.conf
но у нас в resolv.conf стоит не вот так


я много разираю в dns-tls.txt  !!!

nameserver 127.0.0.53


а вот так 

nameserver 1.1.1.1

то прорамма которая не юзает NSS
она тупо сама подйет в инет делать днс
рексвест на 1.1.1.1

потому только иптейблс!!! для полного контроля!


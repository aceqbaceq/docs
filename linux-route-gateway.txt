| linux 
| gateway
| ip route
| onlink

на соебесе у меня родился вопрос 


маршрут без гетвея возоможен в линуксе?


вот как выглядит обычный маршрут


172.16.10.0/24 dev enp0s3 src 172.16.10.11


он чем он гвоорит. если приожение просит послать
ип пакет до 172.16.10.100  то ядру нужно знать 
несклько вещей. 
   - в какой физ порт выплюнуть пакет.
   - как заполнить ип пакет изнутри. 
         нужен срс ип
         и дест ип. 


из этих вопросов ядро сразу знает только чему равен
дест ип = 172.16.10.100

далее
ядро лещет в таблицу маршуртов 
и узнает из строки


172.16.10.0/24 dev enp0s3 src 172.16.10.11

что срс ип = 172.16.10.11
и что этот ип пакет нужно выплюнуть из  порта enp0s3

далее начианется мудеж. драйвер физ порта регистри
рует его в ядре так что он говоит это порт эзернет
это знаачит что из него можно плвать наружу только
эхернет фреймы но никак не ип пакеты!
в ядре записано что надо послать арп запрос из карты
в который записать дес ип.
и тогда тот мак арес который пролтетит в ответ
его и нужно юзать как дест мак.
таким макамро наш ип пакет снаружи оборавичвается в
эзернет фрейм.

а если у меня вот такой маршурут

4.4.4.0/24 via 172.16.10.1 dev enp0s3

значит если я хочу отпрваит ип пакет до дест 
ип  4.4.4.10
так дест ип знаем. леезем в таблицу маршуртов
получаем что порт это enp0s3 но вопрос какой
срс ип использовать.  у нас не написано. зато
есть загадочна фраза 

   via 172.16.10.1

даоее ядро ищет в таблоице марушурут до этог хоста
находит

172.16.10.0/24 dev enp0s3 src 172.16.10.11

из него она берет что срс ип = 172.16.10.11

итау у нас готов ип пакет

срс = 172.16.10.11 дест = 4.4.4.10 
порт  = enp0s3

но еще по прежнму остается вот эта хуйня

  via 172.16.10.1

она говорит ядру о том что когда мы будем искать
дест мак адрес для эзренет фрейма то ненужно
слать в сеть арп запрос с ип = 4.4.4.10
вместо ттго надо слать в сеть арп запрос с
ип = 172.16.10.1

таким образом полуается некаая чушь  -  у нас 
запись в таблице маршрутиацзии которая должна 
по идее оторажать инфо только про л3 уровень
сети еще в себе сдержит и инфо об л2 части сети!!!!!
это пиздец!!!

ксати я даю овтет на мой вопрос - а может ли 
запист в табице маршрутиацзии быть без гейтвея?
ответ -ДА!
вот пример

172.16.10.0/24 dev enp0s3 src 172.16.10.11

никак проблем что у нас нет гейтвея тут. а 
маршрут есть!


теперь еще момент. положим что мой комп
и другой комп в сети сидят на одном свиче. 
моя  карта имеет ип 172.16.10.11
и у меня ест марщуррут 

172.16.10.0/24 dev enp0s3 src 172.16.10.11


а друной комп имеет ип 192.168.10.11
и маршрут в своей таблице

192.168.10.0/24 dev em1 src 192.168.10.11

тоест унас в одной л2 сегмента две ип сети.

если я попробу вот такой маршрут добавить


4.4.4.0/24 via 192.168.10.11 dev enp0s3

то линукс пошлет нахер. потому что в таблице
маошутаицзии у нас нет маршрута до хоста 192.168.10.11
но если мы пошлем арп запрос до него то мы получим
ответ! потому что на уровне л2 моя карта и та
карта видят друг друга. 
тогда можно линукс заставить не проверяеть есть
ли маршрут до 192.168.10.11 вот так


4.4.4.0/24 via 192.168.10.11 dev enp0s3 onlink

тогда он пошлет арп с ип=192.168.10.11
получит ответ . и подсавит его в дест мак
тоест эзренет оболочку он составит. 
что касается ип пакета

    дест 4.4.4.10


проблемка будет ему какой срс ип вставлять в
ип пакет. ну щас ну будут задуваться в худшем
случае он подсваить срс ип = 0.0.0.0

если в мрашрутет вставить scope global

4.4.4.0/24 via 192.168.10.11 dev enp0s3 onlink scope global

и если у нас на порту есть ip с флагом global
то он подавит этот глобал ип в срс ип.


в общем мудеж.


в целом вопрос - можно ли добавить маршрут
у кртоторго нет гейтвей - ответ да. 

также у нас есть L3 порты  типа точка точка 
л3 тунели. и еси за ними есть сети то в них 
можно попасть типа вот так

default via 172.16.102.1 dev ens160 onlink

где 172.16.102.1 ип толи порта на нашей стороне
толи на той стороне. хер знает. уже не помню.


вобщем пздц


вобщем злесь я прояснмл смысл via       и 
onlink 
я еще к тому вернусь когда будут 
к8 смотреть его фланнель сеть 
которая добавяет вот такие дебильные 
записи

10.254.3.0/24 via 10.254.3.0 dev flannel.1 onlink


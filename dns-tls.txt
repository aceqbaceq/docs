| DNS
| dig
| TLS
| HTTPS


значит когда то был простой лоховской DNS через порт 53 UDP\TCP
он не имел никакой защиты

после додумали DNSSEC  он работает через тот же 53 TCP\UDP 
он вот что делает - он коненту который в наш комп прилетает прилепляет цифровую подпись.
поэтому обеспечивается достоверность данных и целостность данных. но не конфиденциальности.
тоесть щифрования. если мы гоорим про цифрую подпись то значит на нашем компе должен оказаться
публичный ключ dns серверера. причем он должен быть достоверным. как и откуда он берется
на нашем компе непонятно. 

следущий шаг это DNS over TLS. это уже получается днс с использованием шифрования. 
работает через 853/TCP

еще есть DHS over HTTPS (сокращенно DOH) тоесть снаружи у нас TLS а внутри HTTP . работает через 443/TCP
соотвественнно этот способ тоже обеспечивает шифрование.

спрашивается зачем городили эти две системы. ведь они обе шифруют. а ответ такой что 
одну сситему делали одни а вторую другие. вот и все. 

DOH имеет тот плюс что провайдеры могут нахер все закрыть. а HTTPS останется. и через него
можно получать достоверный DNS

самые известные пулбличные DNS сервера это гугловские 8.8.8.8
и cloudflare 1.1.1.1

клаудфдеер трясет себя пяткой в грудь что у них быстрее они откликаются. 


теперь как это все на практике.

во первых где в линуксе настраивется  адрес dns сервера к которому обращается так называемый
dns клиент или резолвер. обычно щас резоллвером в линуксе явялется 

	systemd-resolved

и его конфиг лежит в 

	/etc/systemd/resolved.conf


и там вот такие строки

DNS=1.1.1.1
DNSSEC=on
DNSOverTLS=yes

чтобы натройки вступлив в силу

	# systemctl restart systemd-resolved
 
как можно проверить текущий статус
какой там адрес dns сервера щас установлен в системе

	$ resolvectl
Global
           Protocols: -LLMNR -mDNS +DNSOverTLS DNSSEC=yes/supported
    resolv.conf mode: foreign
  Current DNS Server: 1.1.1.1
         DNS Servers: 1.1.1.1




далее в манжаро ставим dig вот так

	# pacman -Sy bind



далее через dig можно потестировать запросы через TLS, или через DOH


значит гугловский 8.8.8.8 поддерживает ответы через TLS.
тестируем это 

$ dig  @8.8.8.8    +tls   mail.ru

;; ANSWER SECTION:
mail.ru.		10	IN	A	217.69.139.200

;; Query time: 286 msec
;; SERVER: 8.8.8.8#853(8.8.8.8) (TLS)

мы видим что запрос идет к 8.8.8.8 и порт 853
также видно что запрос выполнен за 286 msec


клаудфлееровский 1.1.1.1 тоже поддеживает ответы через TLS

$ dig  @1.1.1.1    +tls  mail.ru


;; ANSWER SECTION:
mail.ru.		30	IN	A	217.69.139.200

;; Query time: 226 msec
;; SERVER: 1.1.1.1#853(1.1.1.1) (TLS)

мы видим что запрос идет через 1.1.1.1 и порт 853 
и что ответ за 226 msec

эти же серверра поддерживают ответ через HTTPS

 $ dig  @8.8.8.8   +https   mail.ru
;; ANSWER SECTION:
mail.ru.		20	IN	A	94.100.180.200

;; Query time: 233 msec
;; SERVER: 8.8.8.8#443(8.8.8.8) (HTTPS)



  $ dig  @1.1.1.1    +https   mail.ru
;; ANSWER SECTION:
mail.ru.		32	IN	A	217.69.139.202

;; Query time: 223 msec
;; SERVER: 1.1.1.1#443(1.1.1.1) (HTTPS)


в обоих случая что 853\TCP TLS что 443\TCP HTTPS по факту исопльзуется TLS 
просто в одном случае за ним стоит HTTP а во втором случае не стоит. так вот вот
TLS он использует сертификаты. в сертиифкате есть строка "Subject" в которой указан CN
также в сертификате есть строка "Alternative Name" где тоже указан CN 
так вот TLS он проверяет чтобы IP\DNS в запросе и CN в сертификате от сервера совпадали


если мы вводим вот так

  $ dig  @1.1.1.1    +tls   mail.ru
или вот так
  $ dig  @1.1.1.1    +https   mail.ru


то наш диг он проверяет есть ли в сертификате CN=1.1.1.1 
можно задать руками какой CN будет искать в сертификате диг

	$ dig  @1.1.1.1  +tls    +tls-host=1.1.1.1             mail.ru

тоесть мы попросили выполнить dns over tls через 853 порт и IP=1.1.1.1 и  при получении сертиифкта
проверить что в нем CN=1.1.1.1


    $ dig  @1.1.1.1  +https  +tls-host=cloudflare-dns.com  mail.ru

здесь мы попросили выполнить dns over HTTPS что по факту DNS over TLS over HTTP  через 443 порт и при получении сертиифкта проверить что в нем CN=cloudflare-dns.com


а вот щас запросим чтобы CN был такой котрого нет в сертификате
	$ dig  @1.1.1.1  +https +tls-host=vasya.com  mail.ru
	;; TLS peer certificate verification for 1.1.1.1#443 failed: hostname mismatch

если мы ключ +tls-host=cloudflare-dns.com   неуказаываем то диг ищет CN равный тому
что мы указали в @1.1.1.1


кстати systemd-resolved  не поддерживает DNS over HTTPS (DoH) а только как я уже
сказал подерживает DNS over TLS (DoT) вот ссылка
	https://askubuntu.com/questions/1506255/systemd-resolved-dns-over-https-doh-with-custom-port-and-domain

зато dnsmasq поддерживает DoH

еще раз приведу конфиг как задать в systemd-resolved адреса dns серверов и как
активировать DoT

 # cat /etc/systemd/resolved.conf
[Resolve]
DNS=1.1.1.1
FallbackDNS=8.8.4.4

DNSSEC=on
DNSOverTLS=yes

насколько я понимаю DNSSEC это "расширение" к обычному DNS запросу через 53-ий порт.
и оно я думаю ненужно если мы юзаем DoT но все равно пусть будет.

вопрос а как посмотреть какой сертификат показывает удаленный dns сервер когдмы
мы на него идем по TLS\HTTPS

вот так можно приконектиться

	$ openssl s_client -connect 8.8.8.8:853

Connecting to 8.8.8.8
CONNECTED(00000003)
Can't use SSL_get_servername
depth=2 C=US, O=Google Trust Services LLC, CN=GTS Root R1
verify return:1
depth=1 C=US, O=Google Trust Services, CN=WR2
verify return:1
depth=0 CN=dns.google
verify return:1
---
Certificate chain
 0 s:CN=dns.google
   i:C=US, O=Google Trust Services, CN=WR2
   a:PKEY: rsaEncryption, 2048 (bit); sigalg: RSA-SHA256
   v:NotBefore: Aug  5 07:20:11 2024 GMT; NotAfter: Oct 28 07:20:10 2024 GMT
 1 s:C=US, O=Google Trust Services, CN=WR2
   i:C=US, O=Google Trust Services LLC, CN=GTS Root R1
   a:PKEY: rsaEncryption, 2048 (bit); sigalg: RSA-SHA256
   v:NotBefore: Dec 13 09:00:00 2023 GMT; NotAfter: Feb 20 14:00:00 2029 GMT
 2 s:C=US, O=Google Trust Services LLC, CN=GTS Root R1
   i:C=BE, O=GlobalSign nv-sa, OU=Root CA, CN=GlobalSign Root CA
   a:PKEY: rsaEncryption, 4096 (bit); sigalg: RSA-SHA256
   v:NotBefore: Jun 19 00:00:42 2020 GMT; NotAfter: Jan 28 00:00:42 2028 GMT
---
Server certificate
-----BEGIN CERTIFICATE-----
MIIFsjCCBJqgAwIBAgIQTH4h1szUaTQJK6eEMZyoVjANBgkqhkiG9w0BAQsFADA7
MQswCQYDVQQGEwJVUzEeMBwGA1UEChMVR29vZ2xlIFRydXN0IFNlcnZpY2VzMQww
CgYDVQQDEwNXUjIwHhcNMjQwODA1MDcyMDExWhcNMjQxMDI4MDcyMDEwWjAVMRMw
EQYDVQQDEwpkbnMuZ29vZ2xlMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKC
AQEArWIzO6kEW2guWJZ/c81G+a4mLFxkZDyOx3sxt5GoIqnzW3fFoWcMgmzPbocE
t6Os3zPAj44kVo/g7EWLPtgrodjsX5aKe0+lEzhqYe1yCNdbjzW6suJiU3dWStJc
WX7GmVgy8hhYX69uMdyFlvm7iFyiJ+X56TSh7lodS5JqY7D/6BaoZrPQ0QWc4P/u
y/eMcVLLn33r2NUJ2OzRZQ1QKdN+Ow2vSQSm63LVEWEpWtPtT0qIrIlalZAsqaBR
YLutjUqfjjAnpd5k9D4elnvHonWYGC5YC26Sv1Cw8ulbEvs3blMEDp/8SAw445nU
NxR9zpJoY+IlJoz3js4VcIQn6wIDAQABo4IC1jCCAtIwDgYDVR0PAQH/BAQDAgWg
MBMGA1UdJQQMMAoGCCsGAQUFBwMBMAwGA1UdEwEB/wQCMAAwHQYDVR0OBBYEFDkm
9Wmetpahz62CCrXYDbP/UnzlMB8GA1UdIwQYMBaAFN4bHu15FdQ+NyTDIbvsNDlt
QrIwMFgGCCsGAQUFBwEBBEwwSjAhBggrBgEFBQcwAYYVaHR0cDovL28ucGtpLmdv
b2cvd3IyMCUGCCsGAQUFBzAChhlodHRwOi8vaS5wa2kuZ29vZy93cjIuY3J0MIGs
BgNVHREEgaQwgaGCCmRucy5nb29nbGWCDmRucy5nb29nbGUuY29tghAqLmRucy5n
b29nbGUuY29tggs4ODg4Lmdvb2dsZYIQZG5zNjQuZG5zLmdvb2dsZYcECAgICIcE
CAgEBIcQIAFIYEhgAAAAAAAAAACIiIcQIAFIYEhgAAAAAAAAAACIRIcQIAFIYEhg
AAAAAAAAAABkZIcQIAFIYEhgAAAAAAAAAAAAZDATBgNVHSAEDDAKMAgGBmeBDAEC
ATA2BgNVHR8ELzAtMCugKaAnhiVodHRwOi8vYy5wa2kuZ29vZy93cjIvOVVWYk4w
dzVFNlkuY3JsMIIBBQYKKwYBBAHWeQIEAgSB9gSB8wDxAHcA7s3QZNXbGs7FXLed
tM0TojKHRny87N7DUUhZRnEftZsAAAGRIZ/pBwAABAMASDBGAiEA9MEVJnQZVuiS
jXcAAKphsDNPwfHPjbmrEpds2SeOlrQCIQDGlzRZ4JwoWFz6/NngjoyKwE3n2Ick
ANRnJqCoXTK4ZwB2AD8XS0/XIkdYlB1lHIS+DRLtkDd/H4Vq68G/KIXs+GRuAAAB
kSGf6SEAAAQDAEcwRQIhANp4abXSPu0P1CXYUkTDma8jMfm87UDIo872JLa1pU8D
AiBcs6Lp0pLoCxcE1dodB4dMfokzGULzQTluEC1ZaSm0BTANBgkqhkiG9w0BAQsF
AAOCAQEAHhGtSpdL5cggiAJhb4CrXB54QR9Q7KAdbpWJcWjegb7rBkkBEEr2JORJ
lO+RkZg2cE7eB1IwfgHhWj8XyFzueCvIRghET6cdNyI7Nc/U0UNzmPy0e0bI5XIf
lXok85hsAimPRMkCfkdrdO+B6Xt/I2JVaRPPcbe9Q87X9/JVWuQbH+LrmaOokNyb
CPyujl9eSWuIVzpJHm5z2m1aQXZb+X1yivQwn6Ik2Wct7poz3Ueb3VwjiTJxm4IY
5gxA092LYw5rvPfjZRBrs4r3OILuefqurN+2StNIhiGz/7ldrPA3+JNQWpLZYyGU
GNScfKLl2B7kJUx2KyWJwgCQLNNkMA==
-----END CERTIFICATE-----
subject=CN=dns.google
issuer=C=US, O=Google Trust Services, CN=WR2


копируем сертификат в тектовый файл. и его 
содержимое можно вот так посмотреть

$ openssl x509 -noout -text -in cert2.pem  | grep Subject
        Subject: CN=dns.google

$ openssl x509 -noout -text -in cert2.pem  | grep "Alternative Name" -A1
            X509v3 Subject Alternative Name: 
                DNS:dns.google, DNS:dns.google.com, DNS:*.dns.google.com, DNS:8888.google, DNS:dns64.dns.google, IP Address:8.8.8.8, IP Address:8.8.4.4, IP Address:2001:4860:4860:0:0:0:0:8888, IP Address:2001:4860:4860:0:0:0:0:8844, IP Address:2001:4860:4860:0:0:0:0:6464, IP Address:2001:4860:4860:0:0:0:0:64


таким образом в сертификате есть CN=8.8.8.8 и CN=dns.google  

а вот что в сертификате с 1.1.1.1

$ openssl x509 -noout -text -in cert.pem  | grep Subject
CN=cloudflare-dns.com

$ openssl x509 -noout -text -in cert.pem  | grep "Alternative Name" -A1
            X509v3 Subject Alternative Name: 
                DNS:cloudflare-dns.com, DNS:*.cloudflare-dns.com, DNS:one.one.one.one, IP Address:1.0.0.1, IP Address:1.1.1.1, IP Address:162.159.36.1, IP Address:162.159.46.1, IP Address:2606:4700:4700:0:0:0:0:1001, IP Address:2606:4700:4700:0:0:0:0:1111, IP Address:2606:4700:4700:0:0:0:0:64, IP Address:2606:4700:4700:0:0:0:0:6400


тоесть в нем есть CN=1.1.1.1 и CN=one.one.one.one и CN=cloudflare-dns.com

поэтому скажем к 1.1.1.1 можно обращаться вот такими любыми способами

  dig  -4 @one.one.one.one  +tls   mail.ru
  dig  -4 @1.1.1.1  +tls   mail.ru

а вот такое почемуто несрабатывает

$ dig  -4 @cloudflare-dns.com  +tls   mail.ru
;; Connection to 104.16.249.249#853(104.16.249.249) for mail.ru failed: timed out.
;; no servers could be reached


вобщем получается в DNS можно ходить как лох через 53\UDP\TCP
можно ходить чуть лучше через DNSSEC
и можно ходить козырно через TLS или через HTTPS
systemd-resolved поддержтвает все кроме HTTPS но его поддеожвает dnsmasq

насчет клайдфлееровский DNS сервреров они написали вот тут
	https://developers.cloudflare.com/1.1.1.1/encryption/dns-over-tls/

насчет гугловский dNS серверов они напиали вот тут
	https://en.wikipedia.org/wiki/Google_Public_DNS


есть вопрос а что быстрее отвевет DoT или DoH и еще вопрос что быстрее 1.1.1.1 или 8.8.8.8
у меня работает все через впн поэтому что так что так по 200-250 msec
но если зайти на сервер где нет впн и сразу в интерне он смотрит то DoH работает в 
миллион раз быстрее. щас покажу


$ dig -4 @8.8.8.8        +tls  ya.ru  | grep msec
;; Query time: 8 msec


$ dig -4 @1.1.1.1        +tls  ya.ru  | grep msec
;; Query time: 44 msec




$ dig -4 @8.8.8.8        +https  ya.ru  | grep msec
;; Query time: 4 msec


$ dig -4 @1.1.1.1        +https  ya.ru  | grep msec
;; Query time: 4 msec


видно что через tls выигрывает гугл. на https одинаково.
и видно что https работает существенно быстрее через tls
дело не втом что tls плохой и меленный. в htts там же тоже tls есть просто 
в "tls методе" там же за ним стоит какйото протокол по которому днс клиент и сервер
разговаривают (tls то это просто шифрвание) и видимо он медленный. а в https методе
там вместо медленного протокола исползуется http который видимо более быстрый
мненанотубке переодить с DoT на DoH нет смысла потому что все равно все запросы идут
через впн и в итоге выходит по 200-250мс. во вторых systemd-resolved не поддерживает DoH
а пееренастраиваться на dnsmasq я нехочу.

чтоб на компе гарантировать что мы раобоем по DoT надо подстрахоываться через iptables.
чтобы там все было запорещено кроме того что разрешено. и там у меня 
вот такое стоит для DNS

:INPUT DROP [39:4773]
:FORWARD DROP [0:0]
:OUTPUT DROP [2603:186514]

-A OUTPUT  -p tcp -m tcp --dport 853 -o tun+  -j ACCEPT

==

| DNSSEC

скажу сразу это тема это очередной ПИЗДЕЦ. и как обычно потому что описано
это все МЕГА ПЛОХО.

через какой порт и протокол оно работает. оно не имеет спец порта оно работает 
через тот порт через котороый работает текущий dns клиент. щас оьбясню.

обычно по деолфту днс клиент ломиться на днс сервер через 53/TCP UDP
если мы юзаем dns over tls то клиент ломиться на сервер через 853/TCP
если мы юзаем dns over https то клиент ломиться на сервер через 443/TCP

так вот если при этом любом режим актииован DNSSEC то он ломиться ровно также по тем
же портам. тоесть DNSSEC он не относится  к тому что мы как то по другому вплане 
порта  ломимся на днс сервер. dnssec относится к тому что мы ПОСЛЕ этого начинаем 
говрить с днс сервером несколько по другому. тоесть dnssec это изменение то как 
мы гооворим с днс серервром уже после того ккак мы с ним наладили конект. поэтому у dnssec
нету "особого" порта. 
далее прикол состоит в том что даже от того что мы актививаролвали режим 
запросов к внешним dns серверам чере dnssec на
нашем ноутбуке это не значит что мы получим ответ реально через dnssec. 

далее начинается зона сплошных непонятных моментов. во первых днс клиент может работать
в двух режимах - в одном режиме он делает запрос к днс-А серверу и тот обычно пишет
что он нихуя не знает и шлет нас на другой днс-Б сервер. тогда мы делаем запрос к днс-Б
серверу тот тоже ничего незнает и шлет нас на днс-Ц сервер. тогда мы делаем запрос 
на днс-Ц сервер. и так несколько раз. этот режим называется итеративный. тоест 
нам например нужно найти host3.vasya.com мы обращаемся на корневой днс сервер и 
говорим а где сидит днс сервер который .com зону обслуживает. он нам шлет.
мы идем туда и спрашиваем а где сидит днс который обслжуивает зону vasya.com
он нас шлет на следущий днс сервер который обслуживает зону vasya.com мы у него спрашиваем
а кто обслуживает host03.vasya.com и наконец блядь мы попали на сервер который обслуживает
зону host03.vasya.com 
естть другой режим - мы шлем запрос на ближайший днс сервер. он делаею всю грузню 
работу а нам возвращает ответ. это рекурсивный режим работы нашего днс клиента.
если я ничего не путаю.  насколько я понимаю 100% всех днс клиентов на домащних компах
и обычных серврерах работают в рекурсивном режиме. 

так я вовзвраащаюсь к днссек. как эта хуета  в целом работает. на днс сервере который
отвечает за зону размещается несколько записей. ктото должен эти записи скачать. 
и проанализировать. а после этого еще скачать записи и головных доменов вплоть до корневого
сервера. и проанализировава куче записей придти к выводу достоверные записи нам предоставил
самый первый сервер или нет. так вот что я не понимаю - все это анализирует наш днс клиент
на ноубтуке или за это все отвечает днс серевер на который мы обращаемся а нам уже только
выдается конечный ответ ? непонятно. 

значит как плюс минус работает dnnsec:
 пусть  у нас есть зона. и мы в ней хозяева. пусть это зона cloudflare.com
 в этой зоне есть записи которые имеют один и тот же вид , например 

 $ dig -4 A  cloudflare.com   +multi
;; ANSWER SECTION:
cloudflare.com.		70 IN A	104.16.132.229
cloudflare.com.		70 IN A	104.16.133.229


значит в данном случае в зоне есть домен cloudflare.com который имеет две записи.
говря другими словами в зоне есть несколько записей у которых один и тот же домен.
так вот такие записи называются RRset. c этого начинается днссек. мы берем группу 
таких записей ( ксатти запись в днс называется RR - resource record) и для этой кучи
записей создаем цифровую подпись. и эту цифровую подпись записываем в эту же зону
в запись типа  RRSIG (RR Signature - Resource Record set Signature)
еще раз эта цифровая подпись создается не для отдельного RR а сразу для кучи RR.
где куча состоит из записей в которых одного называние домена. в вданном случае это  
RRset состоит из
	cloudflare.com.		70 IN A	104.16.132.229
	cloudflare.com.		70 IN A	104.16.133.229

спрашивается как посмотреть цифровую подпись RRSIG для этого RRset ?
ответ - надо запросить RRset указав что мы хоотим использовать при запросе dnssec
и днс сервер нам выдаст и RRset и его RRSIG

$ dig -4 @8.8.8.8  A  cloudflare.com   +multi +dnssec

;; ANSWER SECTION:
cloudflare.com.		274 IN A 104.16.133.229
cloudflare.com.		274 IN A 104.16.132.229
cloudflare.com.		274 IN RRSIG A 13 2 300 (
				20240902224340 20240831204340 34505 cloudflare.com.
				Iv0mqaRfjHvCN0aWkpePZeWEbPqrnVJcSS3NqIpx+Hgi
				8kREH7LZVZYCtkV6KjOBsXWndBBt/h2KNhwG7n9tUA== )


значит я через dig запросил у 8.8.8.8  запись тип A с именем cloudflare.com чеерез dnnsec
а оно в ответ смотрит есть для эттих записей RRSIG запись

ключ +multi говорит для диг  чтобы длинные записи он не обрезал типа того.

соотвесвтенно если мы просим у диг отдать нам днс имя через dnssec и он не показывает
при этом RRSIG то 100% что мы получили домен и ip не через dnssec. почему . по разным
причинам. например у этой зоны не установлен днссек. кстати чтобы получить запись 
cloudflare.com через dnssec то нужно либо обратиться к днс серверу который отвечает 
за эту зону либо к серверу который за нас проделает грязную работу - узнает какой днс
сервер отвечает за зону cloudflare.com сделает к нему запрос через днссек и вернет нам
ответ. значит как узнать какой сервер отвечает за зону clooudflare.com 

$ dig   +trace cloudflare.com

значит как работает этот запрос. без ключа +trace диг делает запрос к тому
днс серерву который прописан в /etc/resolv.conf и ждет от него конечного ответа. 
а если мы юзаем ключ +trace то диг делает запрос к днс прописанному в /etc/resolv.conf
об том какой адрес у корневых днс серверов. получает ответ. потом диг делает запрс
к одному из корневых серверов и спрашивает какие днс отвечает за зону .com
получает ответ. потом он у одного из них спршаивыает какой север отвечает за зону
cloudflare.сom получает ответ. и у одного из них спрашивывает какой ip имеет домен 
cloudflare. com вот как выглядит листинг

вначале список крневых сервров 
и кто дал о них ответ
.			218	IN	NS	m.root-servers.net.
.			218	IN	NS	l.root-servers.net.
            ...
            ...
;; Received 239 bytes from 127.0.0.53#53(127.0.0.53) in 4 ms



потом сервера которые держат зону .com
и кто дал про них ответ
com.			172800	IN	NS	e.gtld-servers.net.
com.			172800	IN	NS	b.gtld-servers.net.
                                ...
com.			86400	IN	DS	19718 13 2 ;; Received 1174 bytes from 2001:500:2f::f#53(f.root-servers.net) in 4 ms



потом кто держит зону cloudflare.com
 и кто дал про них ответ
cloudflare.com.		172800	IN	NS	ns6.cloudflare.com.
                                    ...
;; Received 720 bytes from 192.41.162.30#53(l.gtld-servers.net) in 20 ms



потом инфо о доменах cloudflare.com
и кто дал про них ответ
cloudflare.com.		300	IN	A	104.16.132.229
cloudflare.com.		300	IN	A	104.16.133.229
;; Received 185 bytes from 2400:cb00:2049:1::a29f:121#53(ns4.cloudflare.com) in 0 ms


так вот получается что в предполследеней секции мы узнаем днс сервреа
которые держат зонву cloudflare.com это ns6.cloudflare.com
теперь мы знаем к кому обращаться чтобы получить инфо о домене cloudflare.com 
через dnssec

$ dig    cloudflare.com   @ns6.cloudflare.com +dnssec  +multi

;; ANSWER SECTION:
cloudflare.com.		300 IN A 104.16.132.229
cloudflare.com.		300 IN A 104.16.133.229
cloudflare.com.		300 IN RRSIG A 13 2 300 (
				20240902230553 20240831210553 34505 cloudflare.com.
				6np86HGZsSLSypsWIEpRsphdjJWJsuJDx+0IMtQ/HIzD
				CbPf510eRW/79z7tvNa3WDtpDTCg0w/3z47UNH8/SA== )


итак я обратился к днс серверу ns6.cloudflare.com и попрасил у него выдать инфо 
о домене cloudflare.com (или о записи RR) через dnssec и он выдал именно через дннсек
почему. потому что он нам помимо RR тип A еще выдал тип RRSIG

вот делаю тот же самый запрос без дннсек

$ dig    cloudflare.com   @ns6.cloudflare.com  +multi

;; ANSWER SECTION:
cloudflare.com.		300 IN A 104.16.133.229
cloudflare.com.		300 IN A 104.16.132.229

никакого RRSIG не выдает. 

а вот еще 

$ dig cloudflare.com @ns6.cloudflare.com

;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 58231
;; flags: qr aa rd; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1
;; WARNING: recursion requested but not available


;; ANSWER SECTION:
cloudflare.com.		300	IN	A	104.16.133.229
cloudflare.com.		300	IN	A	104.16.132.229

смотрим вот эту строку
;; flags: qr aa rd; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1

в ней флаг "aa" он типа значит что ответ наш есть  Authoritative Answer
тоесть его раельно дал сервер отвчающий за этот домен

кстати вот еще строка
;; WARNING: recursion requested but not available

это типа о том что мы его попросили сделать за нас всю граузую работу а он 
отказывается? типа того что если мы его просим нам найти запись о каком то левом
домене то он нас нахер пошле?

$ dig -4 google.com @ns6.cloudflare.com

; <<>> DiG 9.18.12-0ubuntu0.22.04.3-Ubuntu <<>> -4 google .com @ns6.cloudflare.com
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: SERVFAIL, id: 19959
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 65494
;; QUESTION SECTION:
;google.com				IN	A


вроде как да. потому что 
			status: SERVFAIL
типа диг по дефолту делает рекурсивный запрос а этот днс сервер наш шлет нахер.
а если к нему с итеративным подвалить?

$ dig -4 google.com @ns6.cloudflare.com +trace

; <<>> DiG 9.18.12-0ubuntu0.22.04.3-Ubuntu <<>> -4 google .com @ns6.cloudflare.com +trace
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: SERVFAIL, id: 40309

тоже самое status: SERVFAIL,

единсвтенное чего он может обслужить это доменые за которые он сам отвечает

итеративный запрос выдаст пустоту даже для cloudflare.com 
почему. потому что итераитинвый значит то что к тому сервреу первому что мы обращаемся
мы спросим адреса корневых сервеов. а этот сервер нам их не отдаст.

$ dig -4 cloudflare.com @ns6.cloudflare.com  +trace

; <<>> DiG 9.18.12-0ubuntu0.22.04.3-Ubuntu <<>> -4 cloudflare.com @ns6.cloudflare.com +trace
;; global options: +cmd
;; Received 34 bytes from 162.159.3.11#53(ns6.cloudflare.com) in 0 ms


тоесть этот днс облсужываеи только рекурсивный запрос и только по доменам которые он
обслужиывает. и все

так есть команда delv в чем ее прикол. если диг нужно спец ключом +dnnsec просить чтбы
он запрос сделал через днссек то delv делает тлооько днссек запросы и никакие другие. 
его ненужно уговаривать. и  delv в отличеи от диг более явно нам напишет получилось ли
получить данные через днссек или нет. в диг это более расплывачато

кстати более короткий способ узнаьт какой днс  сервер хостит зону

~$ dig -4 cloudflare.com    NS

;; ANSWER SECTION:
cloudflare.com.		5698	IN	NS	ns6.cloudflare.com.
...
...

так вот ксатти ключ +dnssec в диг он сука совсем не про то чтобы диг получил данные
о домене через днссек. НИХУЯ. оно всего лишь про то чтобы он вместе с доменом
запросил RRSIG запись и все. нахуй сука. как я понял диг неумеет работать с днссек. 
он тлько лишь эту маленькую писюлечку может делать - запрашивать RRSIG запись и все.
получается тлоько delv может делать запросы по дннсек. 
так как же работает дннсек. 
рабтает он вот как. у нас в зоне есть однтипные записи. например у нас несколько 
записей cloudlfare.com для них создается запись RRSIG которая много чего внутри себя
включает но главное она включает цифровую подпись сделанную на основе приватного ключа 
ассиметричного шифрвания. публичный ключ запиывается в этой же зоне в запись типа DNSKEY
далее положим что все запросы делает наш днс клиент на компе сам. значит наш днс клиент запрашиывает запись cloudflare.com ему вывалиывается две записи и RRSIG. он запрашиывает
с этого же днс сервера DNSKEY запись. получается мы имеем исходные две записи. имеем
составленное для них цифроую подпись. имеем публичный ключ. значит можем проверить что
контент исходных записей

cloudflare.com.		300	IN	A	104.16.133.229
cloudflare.com.		300	IN	A	104.16.132.229

не был изменен злодеем. (насколько  я понимаю цифровая подпись кода сосавляется то 
она составляется нетолько на основе имени домена cloudflare.com но в нее также входят еще
и IP адреса. пролема в том что естесвтенно ненашел а основе каких полей составляется
цфрроывая подпись)
однако проблема в том что мы незнаем к нам на комп приетлетел настощий публиный ключ 
или всю информацию заменил злодей. в обычной жизни мы бы получили публиный ключ из серти
фиката который бы был бы заверен центром сертификации. а у тут у нас нет сертификата. 
но есть вот что - в родительском  домене лежит запись типа DS она в себе содержит 
хэш от публичного этого ключа. но не просто хеш а хеш зашифрован приватным ключом родительс
кой зоны. и там же в родительской зоне в DNSKEY лежит публичный ключ. значит мы скаыием
с родительской зоны DNSKEY , скачиываем оттуда же DS, расшиывароываем этот DS 
через DNSKEY и получаем хеш нашего публичного ключа. смотрим какой публичный ключ мы 
скачали вычисляем хеш сравниывм. если совпадает то это незлодейтский пуб ключ. но что 
мешает злодею заменить и ту пару DNSKEY , DS . значит надо идти в более родитльскрй
домен и оттуда качать DNSKEY , DS и так до самого корня. на корневом серерве будет DS
но не будет DNSKEY. он уже должен быть на нашем компе как говорится встроен. где 
он хранится в линусе не знаю. в delv он встроен внури программы. тогда провреяем всю 
цепочку. если вся цепь совпала значит все данные достоврыеные. щас покажу 
на примрее.

запраиываем A cloudflare.com +RRSIG_cloudflare.com на серверер ns6.cloudflare.com 
который отвечает за зону cloudflare.com

$ dig -4 cloudflare.com @ns6.cloudflare.com  +dnssec

;; ANSWER SECTION:
cloudflare.com.		300	IN	A	104.16.132.229
cloudflare.com.		300	IN	A	104.16.133.229
cloudflare.com.		300	IN	RRSIG	A 13 2 300 20240903000405 20240831220405 34505 cloudflare.com. wedW9sAEow+A/IIUcQdfxC7Lqml/+PP9Xd1zm2Kuf7XT1dWhVm1XM1Ha yVoNfSWSpKEN7oIetiYH8Hz/Sl8J1A==

далее с этго же серврера запраиываем DNSKEY

$ dig -4 DNSKEY cloudflare.com @ns6.cloudflare.com  


;; ANSWER SECTION:
cloudflare.com.		3600	IN	DNSKEY	257 3 13 mdsswUyr3DPW132mOi8V9xESWE8jTo0dxCjjnopKl+GqJxpVXckHAeF+ KkxLbxILfDLUT0rAK9iUzy1L53eKGQ==
cloudflare.com.		3600	IN	DNSKEY	256 3 13 oJMRESz5E4gYzS/q6XDrvU1qMPYIjCWzJaOau8XNEZeqCYKD5ar0IRd8 KqXXFJkqmVfRvMGPmM1x8fGAa2XhSA==

эта не два клюач. это один разбит на два куска.

узнаем сервре который отвечает за родительску зону .com

$ dig -4 NS com. 

;; ANSWER SECTION:
com.			72983	IN	NS	d.gtld-servers.net.
com.			72983	IN	NS	e.gtld-servers.net.


теперь с него запрашиываем DS для домена cloudflare.com

$ dig -4 DS cloudflare.com.  @d.gtld-servers.net

;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 20641

;; ANSWER SECTION:
cloudflare.com.		86400	IN	DS	2371 13 2 32996839A6D808AFE3EB4A795A0E6A7A39A76FC52FF228B22B76F6D6 3826F2B9

очень важно постяно смотреть чтобы в шапке ответа было NOERROR тоесть значит реквест
прошел без ошибок

итак этот DS это DS_от_cloudflare.com   в нем  в виде хэша записан публичный ключ DNSKEY
который мы получили с сервера ns6.cloudflare.com  правда он зашифрован приватным ключом
сервера d.gtld-servers.net, значит надо с этого сервера считать публичный ключ DNSKEY
для этого в запросе нужно указать нетлько сервер но и домен родителтский

~$ dig -4 DNSKEY com.   @d.gtld-servers.net

;; ANSWER SECTION:
com.			86400	IN	DNSKEY	257 3 13 tx8EZRAd2+K/DJRV0S+hbBzaRPS/G6JVNBitHzqpsGlz8huE61Ms9ANe 6NSDLKJtiTBqfTJWDAywEp1FCsEINQ==
com.			86400	IN	DNSKEY	256 3 13 Nps5nxuQHRbY3e9hcbH36kxiELJH5wil+6dC4K1keQI9ci1nqyCP4k1X oXBBn2aeSK4KxwPEs0Opqc0dicuujg==

итак мы имеем DNSKEY_com може расшфировать DS_от_cloudflare.com и получить оттуда 
хэш от DNSKEY_cloudflare.com и сравнить его с DNSKEY_cloudflare.com кторый мы считали
с ns6.cloudflare.com и если они совпадат то с помощью него расшифровать RRSIG_cloudflare.com
а точнее имея оригинальный текст

cloudflare.com.		300	IN	A	104.16.133.229
cloudflare.com.		300	IN	A	104.16.132.229

имея подветженный настоящий DNSKEY_cloudflare.com и имея цифроую подпись RRSIG_cloudflare.com
можно со всем этим поколдовать и сделать вывод совпдаает ли оригинальный текст с цировой
подписью или нет. 
в этом раскаде только одна проблема мы незаем DNSKEY_com настойщий или поддеьный.
для этого идем на сервер отвчающий за родит домен "."  и там ищем DS от ".com"

$ dig -4 DS .   

;; ANSWER SECTION:
.			0	IN	DS	20326 8 2 E06D44B80B8F1D39A95C0B0D7C65D08458E880409BBC683457104237 C7F8EC8D


провяерм достверномть этого DS через DNSKEY от "." 



$ dig . DNSKEY @8.8.8.8


;; ANSWER SECTION:
.			15568	IN	DNSKEY	256 3 8 AwEAAdSiy6sslYrcZSGcuMEK4DtE8DZZY1A08kAsviAD49tocYO5m37A vIOyzeiKBWuPuJ4m9u5HonCM/ntxklZKYFyMftv8XoRwbiXdpSjfdpNH iMYTTV2oDUNMjdLFnF6HYSY48xrPbevQOYbAFGHpxqcXAQT0+BaBiAx3 Ls6lXBQ3/hSVOprvDWJCQiI2OT+9+saKLddSIX6DwTVy0S5T4YY4EGg5 R3c/eKUb2/8XgKWUzlOIZsVAZZUSTKW0tX54ccAALO7Grvsx/NW62jc1 xv6wWAXocOEVgB7+4Lzb7q9p5o30+sYoGpOsKgFvMSy4oCZTQMQx2Sjd /NG2bMMw6nM=
.			15568	IN	DNSKEY	257 3 8 AwEAAaz/tAm8yTn4Mfeh5eyI96WSVexTBAvkMgJzkKTOiW1vkIbzxeF3 +/4RgWOq7HrxRixHlFlExOLAJr5emLvN7SWXgnLh4+B5xQlNVz8Og8kv ArMtNROxVQuCaSnIDdD5LKyWbRd2n9WGe2R8PzgCmr3EgVLrjyBxWezF 0jLHwVN8efS3rCj/EWgvIWgb9tarpVUDK/b58Da+sqqls3eNbuv7pr+e oZG+SrDK6nWeL3c6H5Apxz7LjVc1uTIdsIXxuOLYA4/ilBmSVIzuDWfd RUfhHdY6+cn8HFRm+2hM8AnXGXws9555KrUB5qihylGa8subX2Nn6UwN R1AkUTV74bU=


а вот так типа можно надежно его скачать 
~$ curl -s https://www.internic.net/domain/root.zone | grep "^\.\s\+[0-9]\+\s\+IN\s\+DNSKEY"


имея DNSKEY_. можно расшифрвать DS_. сравнит его с DNSKEY_. 
если совпадает то с его помощью расшфировать DS_cloudflare.com сравниь с DNSKEY_cloudfalre.com
если совпдаает то проверить цифроую подпись RRSIG_cloudfalre.com с текстом

cloudflare.com.		300	IN	A	104.16.133.229
cloudflare.com.		300	IN	A	104.16.132.229

если совпадает то значит эти две строчки настоящие.
ебала та еще.

то что это все неьльзя подделать упирвается в то что у нас есть заранее достоверный 
DNSKEY_. на нем все держится что достаточно дебильно

далее вот что обнаружил. что для нашего днс клиента systemd-resolved вроде как
ненужно в комп закачивать DS запись от "." домена. так называемый dns root anchor
ибо они пишут в докумнетации что он "встроен". однако 
я все же сделал это рукками.
так вот я взял сделал вот такой запрос

 z 撋  $ dig  .  DS  +multi

			0 IN DS	20326 8 2 (
				E06D44B80B8F1D39A95C0B0D7C65D08458E880409BBC
				683457104237C7F8EC8D )

далее надо 0 убрать и скобки убрать и вот так оставить

. IN	DS	20326 8 2 E06D44B80B8F1D39A95C0B0D7C65D08458E880409BBC683457104237C7F8EC8D


длаее нужно проверить что цифры ровно такие же как в https://data.iana.org/root-anchors/root-anchors.xml
далее нужно создвать вот такой файл


/etc/dnssec-trust-anchors.d/root.positive
. IN DS 20326 8 2 E06D44B80B8F1D39A95C0B0D7C65D08458E880409BBC683457104237C7F8EC8D



далее надо перезапустить 

	# systemct restart systemd-resolved

в логах должно появится

сен 02 03:12:37 lenovo systemd-resolved[157427]: Positive Trust Anchors:
сен 02 03:12:37 lenovo systemd-resolved[157427]: . IN DS 20326 8 2 e06d44b80b8f1d39a95c0b0d7c65d08458e880409bbc683457104237c7f8ec8d

далее типа как проверить что работает dnssec через systemd-resolved


$ systemd-resolve cloudflare.com
cloudflare.com: 2606:4700::6810:84e5           -- link: tun0
                104.16.132.229                 -- link: tun0

-- Information acquired via protocol DNS in 565.6ms.
-- Data is authenticated: yes; Data was acquired via local or encrypted transport: yes
-- Data from: network

нам важна запись 
	Data is authenticated: yes

также проверим 

 $ cat /etc/resolv.conf   | grep -v '#'

nameserver 127.0.0.53
options edns0 trust-ad
search .

значит если мы будем делать запрос через delv то в итоге он пойдет через systemd-resolved
окей. тогда

 $ delv  cloudflare.com +rtrace
;; fetch: cloudflare.com/A
;; fetch: cloudflare.com/DNSKEY
;; fetch: cloudflare.com/DS
;; fetch: com/DNSKEY
;; fetch: com/DS
;; fetch: ./DNSKEY
; fully validated
cloudflare.com.		193	IN	A	104.16.133.229
cloudflare.com.		193	IN	A	104.16.132.229
cloudflare.com.		193	IN	RRSIG	A 13 2 300 20240903015602 20240831235602 34505 cloudflare.com. XcVELgaBlYFzejr1xEL7KwLgcsePWfdXLcb9HGtkpGSUnTZiM4plkUyb 1NX0Me4Vj3lOJYoVWN9xdXFDrhUlig==


получается что чтобы dnssec обеспечить в качестве клиента надо всего навсего 
чобы клиент на компе сделал ряд обычных днс запросов. скачал нужные RR. и сделал 
над ними мамематику. вот и все. никакого чуда.

если пригрлялдетьсся то у нас в описании процесса неуказана а где мы скачивали RRSIG
на самом деле мы его скачиваем на этом этапе

;; fetch: cloudflare.com/A


проделаем туже операцию с большей степнью деталиацзиации


 $ delv cloudflare.com +mtrace

вначале скачиваем 
	A cloudflare.com 
и
	RSIG cloudflare.com

;; fetch: cloudflare.com/A
;; ANSWER SECTION:
;cloudflare.com.		182	IN	A	104.16.133.229
;cloudflare.com.		182	IN	A	104.16.132.229
;cloudflare.com.		182	IN	RRSIG	A 13 2 300 (
;						20240903074442 20240901054442 34505 cloudflare.com.
;						P4VGFsyOkIdD6I21/xAnrwweZKVw
;						sVv+Xy445tpGT+vUMyhugcMsNDo5
;						28sjev/WVIYychybAbUYlzRcXQYU
;						mA== )



потом скачиваем с DNSKEY_cloudflare.com
здесь можно заметить что скачивается ДВА DNSKEY.  один dnskey как и положено содержит публичный ключ которым можно расшифровать RRSIG
а второй как я прочитал на сайте "как доп степень зашиты" содержит копию DS которая хранится
в родительской зоне. это просто треш. очередные накрутки сложности. как видно он нам 
скачал еще и RSIG от DNSKEY. зачем этот ключ нужен хрен знает.


;; fetch: cloudflare.com/DNSKEY
;; ANSWER SECTION:

;cloudflare.com.		604	IN	DNSKEY	257 3 13 (
;						mdsswUyr3DPW132mOi8V9xESWE8j
;						To0dxCjjnopKl+GqJxpVXckHAeF+
;						KkxLbxILfDLUT0rAK9iUzy1L53eK
;						GQ==
;						) ; KSK; alg = ECDSAP256SHA256 ; key id = 2371


;cloudflare.com.		604	IN	DNSKEY	256 3 13 (
;						oJMRESz5E4gYzS/q6XDrvU1qMPYI
;						jCWzJaOau8XNEZeqCYKD5ar0IRd8
;						KqXXFJkqmVfRvMGPmM1x8fGAa2Xh
;						SA==
;						) ; ZSK; alg = ECDSAP256SHA256 ; key id = 34505

;cloudflare.com.		604	IN	RRSIG	DNSKEY 13 2 3600 (
;						20241012045415 20240812045415 2371 cloudflare.com.
;						EGAV8jdo2rRj9Tl5hTM7c4FVKQX2
;						Llep3yQ61cPKqyLSBFpnkJQA2Twh
;						Acng2FfrWMKQ1SzXnppJni6X8W91
;						pg== )




итак на данном этапе у нас есть 
	A_cloudflare.com
	RSIG_cloudflare.com
	DNSKEY__cloudflare.com



на следущем этапе мы скачиваем DS_cloudflare с родиитесосткой зоны
и нам выдают нетолько DS но и цифровую подпись от DS
согласно rfc4304 - DS содержит в себе хеш от DNSKEY. этот хеш никак не зашифрован 
итп. и как я понимаю аутентичность DS проверяется через цифровую подпись через запись RRSIG DS cloudflare.com которая хранится в зоне .com .  непутаем ее с RRSIG A cloudflare.com 
которая хранится в зоне cloudflare.com которая являетяс цифровой подписью записи A_cloudflare.com



;; fetch: cloudflare.com/DS
;cloudflare.com.			IN	DS

;cloudflare.com.		2053	IN	DS	2371 13 2 (
;						32996839A6D808AFE3EB4A795A0E
;						6A7A39A76FC52FF228B22B76F6D6
;						3826F2B9 )
;cloudflare.com.		2053	IN	RRSIG	DS 13 2 86400 (
;						20240908011735 20240901000735 59354 com.
;						Hb4Zkf8qiklvQzEEp6RmjSzJMa9M
;						H8VQdEmerL+G6IIUJ6tZPkJtgNbc
;						YFRu5QYnJ+x0PgEdKaPqAkTaspJK
;						VA== )



итак на данном этапе у нас есть 
	(скачано из зоны cloudflare.com) A_cloudflare.com  +	RSIG_cloudflare.com
	(скачано из зоны .com) DNSKEY__cloudflare.com + DS__cloudflare.com

RSIG_cloudflare.com

теперь скачиваем DNSKEY_.com
он нам позволит 

;; fetch: com/DNSKEY
;com.				IN	DNSKEY

;com.			2228	IN	DNSKEY	256 3 13 (
;						Nps5nxuQHRbY3e9hcbH36kxiELJH
;						5wil+6dC4K1keQI9ci1nqyCP4k1X
;						oXBBn2aeSK4KxwPEs0Opqc0dicuu
;						jg==
;						) ; ZSK; alg = ECDSAP256SHA256 ; key id = 59354
;com.			2228	IN	DNSKEY	257 3 13 (
;						tx8EZRAd2+K/DJRV0S+hbBzaRPS/
;						G6JVNBitHzqpsGlz8huE61Ms9ANe
;						6NSDLKJtiTBqfTJWDAywEp1FCsEI
;						NQ==
;						) ; KSK; alg = ECDSAP256SHA256 ; key id = 19718
;com.			2228	IN	RRSIG	DNSKEY 13 1 86400 (
;						20240909140235 20240825135735 19718 com.
;						8dBNzd4TFQj35TTQr1/6MM+BG2mm
;						mgGZfgn231XORw7M2r67xSzo0D5o
;						jdvl5ufLm8guJmKQKG20mbSSTnpu
;						Tw== )


ксатти нихрена не понимаю разницу между зоной и доменом. зато я думаю я понял что 
значит NS серервер. у нас есть записи RR. в каждой записи идет название домена и 
его IP. так вот такие записи они в конечном итоге должны гдето храниться так вот NS
сервер для домена abc.xyz означает что на этом NS сервере физически хранится запись

	abc.xyz  192.168.11.11

есть еще SOA запись. с ней разбиратся не будут. 
поэтмоу когда я ищу NS сервер от cloudflare.com то это значит что мы ищем сервер внутри
которго физически хранятся записи вида

    cloudflare.com   11.12.13.14

в dig можно проставлять флаги в запрос например +aaonly но по факту они нихуя часто
неработают. зато эти флаги очень полезны в статусе при просмотре ответа. нарпример 
флаг aa в ответе означает что ответ нам вернул авторитейтив сервер тоесть именно сервер
на котором физически хранятся запроешенны нами RR записи. вообще смысла дига такой -
мы ему говорим пойди на такой то сервер и принеси нам записи RR с таким то именем
и таким то типом. например выясним чему равны записи с именем google.com и типом NS
будем спрашивать у серврера 8.8.8.8

$ dig @8.8.8.8   NS google.com

;; flags: qr rd ra; QUERY: 1, ANSWER: 4, AUTHORITY: 0, ADDITIONAL: 1

google.com.		21600	IN	NS	ns3.google.com.
google.com.		21600	IN	NS	ns4.google.com.
google.com.		21600	IN	NS	ns1.google.com.
google.com.		21600	IN	NS	ns2.google.com.


в вернутых флагах аа нет. это значит что серврер 8.8.8.8 нехранит внутри себя 
записи NS google.com они хранятся где то в другом месте. когда мы узнали серера указанные
в NS записи то мы узнали сервера внутри которых по идее хранятся все записи относящие
ся к домену google.com  
так вот все да не все. записи типа NS о домене google.com хранятся совсем не на
серверах

	ns3.google.com.
	ns4.google.com.
	ns1.google.com.
	ns2.google.com.

записи NS  google.com хранятся на серверах которые отвечают за родительский домен. 
тоесть серверы которые отвечают за .com (зону или домен хуй знает как это сказать)
именно на них хранятся записи

google.com.		21600	IN	NS	ns3.google.com.
google.com.		21600	IN	NS	ns4.google.com.
google.com.		21600	IN	NS	ns1.google.com.
google.com.		21600	IN	NS	ns2.google.com.

что логично . и получается схема такая. 
мы лазем на 1.2.3.4 который явялется корневым днс сервером. внутри него харнятся
NS записи вида

   NS a.com    server1.a.com
   NS a.com    server2.a.com
   
   NS b.com    server1.b.com
   NS b.com    server2.b.com

   NS yandex.com    server1.yandex.com
   NS yandex.com    server2.yandex.com

   NS vasya.com    server1.vasya.com
   NS vasya.com    server2.vasya.com

замечу что запись типа NS она не содержит IP. она резволвит один домен в другой. 
физ смысл такой что она указывает на сервер который хранит внутри себя записи 
про домен

я так думаю что адреса корневых днс сервром где то вщиты внутри кишок линукса

еще раз подчеркиваю что NS это тип записи в днс файле. физ смысл этой записи 
такой что   у нас берется домен google.com и для него указывается имя сервера ns1.google.com который
содержит почти что все записи для дормена google.com 
все да не все. потому что запись NS google.com хостится не на ns1.google.com а 
на сервере который хостит родительский домен .com

еще раз. 
есть корневйо "." днс сервер 1.2.3.4
внутри него хранятся записи NS с именами  .*

		NS  .*       ...
		NS  .*       ...
		NS  .*       ...

	com.			NS	i.gtld-servers.net.
	com.			NS	c.gtld-servers.net.
	com.			NS	g.gtld-servers.net.

тоесть тип записи NS имя записи "com." и значение i.gtld-servers.net.
эти записи хранятся на корневом сервере c.root-servers.net


$ dig  @c.root-servers.net  com. 

;com.				IN	A

;; AUTHORITY SECTION:
com.			172800	IN	NS	i.gtld-servers.net.
com.			172800	IN	NS	c.gtld-servers.net.
com.			172800	IN	NS	g.gtld-servers.net.


внутри сервером отвечающих за зону\домен com лежат NS записи вида  *.com
в частности yahoo.com

$ dig @c.gtld-servers.net NS  yahoo.com

;; AUTHORITY SECTION:
yahoo.com.		172800	IN	NS	ns1.yahoo.com.
yahoo.com.		172800	IN	NS	ns5.yahoo.com.
yahoo.com.		172800	IN	NS	ns2.yahoo.com.
yahoo.com.		172800	IN	NS	ns3.yahoo.com.
yahoo.com.		172800	IN	NS	ns4.yahoo.com.

внутри сервера ns1.yahoo.com который отвечает за домен yahoo.com лежат 
записи NS   вида *.yahoo.com 

кстати прикол еще в том что всякий домен на конце заканчивается точкой которую 
почемуто принято опускать. скажем mail.ru на самом деле это mail.ru.
это пиздец. это как воздух вроде он есть а вроде его нет. 

так вот еще пример
выясняем какие серера отвечают за домен\зону uk.

смотрим на коренвом сервере
	$ dig  @c.root-servers.net  NS uk. 

;uk.				IN	NS

uk.			172800	IN	NS	nsa.nic.uk.
uk.			172800	IN	NS	dns4.nic.uk.
uk.			172800	IN	NS	dns3.nic.uk.

по мне уебищно что NS запись резолвит не на IP а на доменное имя. что за фигня ?
идем на этот сервер и смотрим на нем записи NS с именем co.uk.

	$ dig  @nsa.nic.uk  NS  co.uk.

;co.uk.				IN	NS

;; ANSWER SECTION:
co.uk.			172800	IN	NS	dns4.nic.uk.

идем на этот сервер и смотрим записи вида NS bbc.co.uk

	$ dig  @dns4.nic.uk  NS  bbc.co.uk.
;; flags: qr rd; QUERY: 1, ANSWER: 0, AUTHORITY: 8, ADDITIONAL: 9
;bbc.co.uk.			IN	NS

;; AUTHORITY SECTION:
bbc.co.uk.		172800	IN	NS	dns0.bbc.co.uk.
bbc.co.uk.		172800	IN	NS	dns0.bbc.com.

видим что это неще на aa ответ.

идем на одни из серверов и опять же ищем NS записи с именем bbc.co.uk.

$ dig  @dns0.bbc.com  NS  bbc.co.uk.

;; flags: qr aa rd; QUERY: 1, ANSWER: 8, AUTHORITY: 0, ADDITIONAL: 1

;bbc.co.uk.			IN	NS

;; ANSWER SECTION:
bbc.co.uk.		900	IN	NS	dns0.bbc.co.uk.
bbc.co.uk.		900	IN	NS	dns0.bbc.com.
bbc.co.uk.		900	IN	NS	dns1.bbc.co.uk.
bbc.co.uk.		900	IN	NS	dns1.bbc.com.

видим что это уже "аа" ответ. 


а вот для www.bbc.co.uk

	$ dig  @dns4.nic.uk  NS  www.bbc.co.uk.

;; flags: qr rd; QUERY: 1, ANSWER: 0, AUTHORITY: 8, ADDITIONAL: 9
;www.bbc.co.uk.			IN	NS

;; AUTHORITY SECTION:
bbc.co.uk.		172800	IN	NS	dns0.bbc.co.uk.
bbc.co.uk.		172800	IN	NS	dns0.bbc.com.

малек я запутался. видно что это "аа" овтет. также видно что сервер хостящий запсии для
домена может принадлежать другому домену. без проблем.


получается если есть сервер который  на каком то другом сервере обозначен в NS записи

  super.com  NS   server1.blabla.com

то это значит на данном сервере хранятся всеовзомжные типы записей (для простоты пусть
все они типа А) и с именем вида


  *.super.com  A   IP_N

и если у данного домена super.com есть подзона  ABC.super.com в которой есть записи 
вида
   
   *.ABC.super.com    A   IP_M

то на этом сервере server1.blabla.com будет NS запись вида


	ABC.super.com   NS   super.server2.com


только мы узнать об этой NS записи можем только если мы знаем имя этой записи

   ABC.super.com  NS

 а если мы незнаем ее имя. то обращаясь к server1.blabla.com мы не можем есго спросить
 мол покажи мне какие NS записи ты имеешь

щас приведу пример


вот у нас есть yandex.ru
щас мы узнаем какой сервер хранит записи вида  


   *.yandex.ru     A    ....


для начала узнаем какой сервер хранит NS записи вида

	   *.ru    NS ...
  yandex.ru    NS ...


	$ dig  @c.root-servers.net  NS ru. 

;ru.				IN	NS

;; AUTHORITY SECTION:
ru.			172800	IN	NS	b.dns.ripn.net.


теперь на этом сервере нужно узнать чему равна запись


  yandex.ru    NS ...


$ dig  @b.dns.ripn.net.  NS yandex.ru. 

;yandex.ru.			IN	NS

YANDEX.RU.		345600	IN	NS	ns2.yandex.RU.
YANDEX.RU.		345600	IN	NS	ns1.yandex.RU.


значит именно на этих серверах хранятся записи вида

  *.yandex.ru   A IP_N

например запросим оттуда запись  news.yandex.ru   A  


$ dig  @ns1.yandex.RU  A  news.yandex.ru. 

;; flags: qr aa rd ra; QUERY: 1, ANSWER: 4, AUTHORITY: 0, ADDITIONAL: 1

;news.yandex.ru.			IN	A

;; ANSWER SECTION:
news.yandex.ru.		300	IN	A	87.250.250.12
news.yandex.ru.		300	IN	A	87.250.251.12

все верно. мы видим вответе "аа"  флаг. и две записи

news.yandex.ru.		300	IN	A	87.250.250.12
news.yandex.ru.		300	IN	A	87.250.251.12

которые физически храняться на этом сервере.

а есть ли на этом серверер NS записи вида

  *.yandex.ru NS  ....

неузнать. нужно знать имя такой записи
для этого нужно знать имя домена 4 уровня. тогда можно будет указать NS имя 


посмотрим еще пример. вот у меня есть ссылка

huskiecommons.lib.niu.edu

на корневом сервере на котором хостятся записи вида NS   *.
найдем запись 
  edu.    NS    сервер

тоесть о сервере  который хостит домен *.edu


 	$ dig  @c.root-servers.net  NS edu. 

;edu.				IN	NS

edu.			172800	IN	NS	g.edu-servers.net.


внутри этого сервера g.edu-servers.net. найдем запись NS  *.edu 
а именно 

	niu.edu   NS  сервер

которая нам скажем сервер который хостит внутри себя записи *.niu.edu


$ dig  @g.edu-servers.net  NS niu.edu.

;niu.edu.			IN	NS

niu.edu.		172800	IN	NS	dns-ext1.niu.edu.


итак у нас есть сервер 

		dns-ext1.niu.edu

который внутри себя хранит записи вида

	*.niu.edu      A     .......
	*.niu.edu      CNAME .......
	*.niu.edu      NS     .......

будем там искать 

  lib.niu.edu  NS    server


	$ dig  @dns-ext1.niu.edu  NS lib.niu.edu
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 1

;lib.niu.edu.			IN	NS

;; AUTHORITY SECTION:
niu.edu.		3600	IN	SOA	dns-ext1.niu.edu. empty.empty. 2024042074 3600 600 1209600 3600

он говорит о том что нет такой NS записи

будем искаьт на нем запись вида

	huskiecommons.lib.niu.edu   CNAME  ...


	$ dig @dns-ext1.niu.edu. CNAME  huskiecommons.lib.niu.edu

;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;huskiecommons.lib.niu.edu.	IN	CNAME

;; ANSWER SECTION:
huskiecommons.lib.niu.edu. 86400 IN	CNAME	dcniu.bepress.com.


получается внутри *.nit.edu создан CNAME

	huskiecommons.lib.niu.edu. CNAME -->	dcniu.bepress.com.

который перенаправляет на другой домен

	$ dig NS   bepress.com

;bepress.com.			IN	NS

;; ANSWER SECTION:
bepress.com.		5556	IN	NS	ns-739.awsdns-28.net.


проверим что на сервеере    ns-739.awsdns-28.net. лежит запись dcniu.bepress.com


$ dig @ns-739.awsdns-28.net   A   dcniu.bepress.com

;; flags: qr aa rd; QUERY: 1, ANSWER: 2, AUTHORITY: 4, ADDITIONAL: 1

;dcniu.bepress.com.		IN	A

;; ANSWER SECTION:
dcniu.bepress.com.	60	IN	A	13.57.92.51
dcniu.bepress.com.	60	IN	A	50.18.241.247

видим флаг "аа" значит да. на этом сервере хранится эта запись
в итоге получается домен huskiecommons.lib.niu.edu. должен резволится в 
IP 

	13.57.92.51
    50.18.241.247


$ dig A huskiecommons.lib.niu.edu

;; flags: qr rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 1, ADDITIONAL: 1

;huskiecommons.lib.niu.edu.	IN	A

;; ANSWER SECTION:
huskiecommons.lib.niu.edu. 336	IN	CNAME	dcniu.bepress.com.
dcniu.bepress.com.	60	IN	A	13.57.92.51
dcniu.bepress.com.	60	IN	A	50.18.241.247

ага так и есть.



забавно что когда мы запршиваем запись NS с сервера на котором она реально
хранится


$ dig  @c.root-servers.net  NS ru. 

;; flags: qr rd; QUERY: 1, ANSWER: 0, AUTHORITY: 5, ADDITIONAL: 11
;; WARNING: recursion requested but not available

;ru.				IN	NS

;; AUTHORITY SECTION:
ru.			172800	IN	NS	a.dns.ripn.net.

то почему то в ответе нет флага "аа"
но ведь запись 

	ru.				IN	NS	a.dns.ripn.net.


хранится на коренвом серевере

	c.root-servers.net

почему же в ответе нет флага аа ?


зато если обратиться на уже найденный серввер и запросить ту же самую запись NS
то он уже выдаст флаг "аа"

~$ dig  @a.dns.ripn.net.  NS ru. 

;; flags: qr aa rd; QUERY: 1, ANSWER: 5, AUTHORITY: 0, ADDITIONAL: 1

;ru.				IN	NS

;; ANSWER SECTION:
RU.			345600	IN	NS	a.dns.ripn.net.


получается на сервере который указан в NS записи хранится точно такая же запись NS
указывающая сама на себя. 

давай с яндексом проверим

находим сервер хранит NS записи вида  *.ru
	$ dig  @c.root-servers.net  NS ru. 

;ru.				IN	NS

;; AUTHORITY SECTION:
ru.			172800	IN	NS	b.dns.ripn.net.


на этом сервере ищем запись о сервере который хостит зону yandex.ru

	$ dig  @b.dns.ripn.net  NS yandex.ru. 

;yandex.ru.			IN	NS

;; AUTHORITY SECTION:
YANDEX.RU.		345600	IN	NS	ns1.yandex.RU.
YANDEX.RU.		345600	IN	NS	ns2.yandex.RU.


получается на сервере   b.dns.ripn.net хранится запись о том что зону yandex.ru
хостит сервер ns1.yandex.RU

	$ dig  @ns1.yandex.RU.  NS yandex.ru. 

;; flags: qr aa rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 5

;yandex.ru.			IN	NS

;; ANSWER SECTION:
yandex.ru.		604800	IN	NS	ns1.yandex.ru.
yandex.ru.		604800	IN	NS	ns2.yandex.ru.


и на сервере ns1.yandex.RU тоже хранится точно такая же запись о том что он 
сервер ns1.yandex.RU хостит зону yandex.ru
смешно. 
причем ответ с флагом "aa" прилетает при запросе к ns1.yandex.RU а не к серверу
 b.dns.ripn.net.
смешно


далее я хотел показать через DSA как это подписывать файл и проерять подпись
с оригиналом. 

вначале нужно вот так это файло параметров ( что это ?)
	 $ openssl dsaparam -out dsaparam.pem 2048

теперь генерация приватного ключа (че такое des3?)
     $ openssl gendsa -des3 -out priv-dsa.pem dsaparam.pem

теперь генерация приватного ключа
    $ openssl dsa   -in priv-dsa.pem -pubout -out pub-dsa.pem

теперь генерация цифровой подписи
    $ openssl dgst -sha256 -sign priv-dsa.pem  -out arecord.txt.sha256 arecord.txt

теперь проверка оригинала по цифровой подписи
    $ openssl dgst -sha256 -verify pub-dsa.pem   -signature arecord.txt.sha256 arecord.txt


главное чтот тут нужно увидеть это то что для проверки участвуют
		1) цифрова подпись
		2) публичный ключ
		3) оригинал

если чегто из этого нет. то проверка неполучится

теперь я вовзращаюсь к dnnsec
берем запись A cloudflare.com

найдем сервер который хостит эту запись

	$ dig  @h.root-servers.net  NS com.

;com.				IN	NS

;; AUTHORITY SECTION:
com.			172800	IN	NS	h.gtld-servers.net.



	$ dig  @h.gtld-servers.net  NS cloudflare.com.

;cloudflare.com.			IN	NS

;; AUTHORITY SECTION:
cloudflare.com.		172800	IN	NS	ns3.cloudflare.com.


	

	$ dig  @ns3.cloudflare.com  A  cloudflare.com.  +dnssec +multi

;; flags: qr aa rd; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1

;cloudflare.com.		IN A


cloudflare.com.		300 IN A 104.16.132.229
cloudflare.com.		300 IN A 104.16.133.229
cloudflare.com.		300 IN RRSIG A 13 2 300 (
				20240903130233 20240901110233 34505 cloudflare.com.
				jNrY7KD11fQ7hBJeRv2G2OfuVkB5SXFE1i2Cr39fjSP1
				TLlhMPWdo8UdDJWb+gXpeY2mK3Mhan6QsdfzIwAoVg== )



так вот у нас есть "оригинальный текст " это записи 

cloudflare.com.		300	IN	A	104.16.132.229
cloudflare.com.		300	IN	A	104.16.133.229

у нас есть цифровая подпись

cloudflare.com.		300 IN RRSIG A 13 2 300 (
				20240903130233 20240901110233 34505 cloudflare.com.
				jNrY7KD11fQ7hBJeRv2G2OfuVkB5SXFE1i2Cr39fjSP1
				TLlhMPWdo8UdDJWb+gXpeY2mK3Mhan6QsdfzIwAoVg== )


щас мы скачаем публичный ключ

	$ dig  @ns3.cloudflare.com  DNSKEY  cloudflare.com. +multi

;; flags: qr aa rd; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1
;cloudflare.com.		IN DNSKEY

;; ANSWER SECTION:
cloudflare.com.		3600 IN	DNSKEY 257 3 13 (
				mdsswUyr3DPW132mOi8V9xESWE8jTo0dxCjjnopKl+Gq
				JxpVXckHAeF+KkxLbxILfDLUT0rAK9iUzy1L53eKGQ==
				) ; KSK; alg = ECDSAP256SHA256 ; key id = 2371
cloudflare.com.		3600 IN	DNSKEY 256 3 13 (
				oJMRESz5E4gYzS/q6XDrvU1qMPYIjCWzJaOau8XNEZeq
				CYKD5ar0IRd8KqXXFJkqmVfRvMGPmM1x8fGAa2XhSA==
				) ; ZSK; alg = ECDSAP256SHA256 ; key id = 34505

из этих двух публичный ключ которым защфирована цифровая подпись это 

cloudflare.com.		3600 IN	DNSKEY 256 3 13 (
				oJMRESz5E4gYzS/q6XDrvU1qMPYIjCWzJaOau8XNEZeq
				CYKD5ar0IRd8KqXXFJkqmVfRvMGPmM1x8fGAa2XhSA==
				) ; ZSK; alg = ECDSAP256SHA256 ; key id = 34505


ксттии видно что в RRSIG  есть поле 34505
и в DNSKEY есть тоже самое поле key id = 34505
тоесть в DNSKEY указыается key id, а потом в цифровой подписи заосится признак какой
публичный ключ может быть  использован для расшифровки этой цифровой подписи

итак получается

RRSIG - это цировая подрпись зашифрованная неким приватным ключом

записи типа A это оригиналы
	cloudflare.com.		300	IN	A	104.16.132.229
	cloudflare.com.		300	IN	A	104.16.133.229


DNSKEY это публичный ключ  который получен из приватного и которым можно проверить 
цифроую подпись

DS это хэш от DNSKEY. DS запись хранится в парент домене. 

значит на одном сервере1 хранятся:
   ориг текст A 
   RRSIG1 от A  
   DNSKEY1  

в сервере2 парент домена хранится
   DS1 от DNSKEY1

также в парент домене хранися 
   RRSIG2 от DS1 
зашиорванный пртватным ключом сервера2. значит на нем лежит публичный ключ от него 
   DNSKEY2
которым можно расшифрвать RRSIG2

как я понимаю он как делает. он берет DNSKEY2 с парент домена. расшифровает RRSIG2
находит в нем DS1 сравнивает его с DS1 который хранится на этом же парент домене. 
и приходитк выводу что DS1 настоящий. потом он идет в наш домен и там берет DNSKEY 
вычиляет от него хеш и сравнивает с DS1 который мы "проверили" что он настоящий.
если хеш от DNSKEY1 совпадает с DS1 значит DNSKEY1 принимается настойщим. тогда
он с помощью него расшфировыает RRSIG1 и сравнивает с оригиналным текстом.
еси оно совпадает то оригнальный текст считается настоящим. в этой схеме только нужно
убедитьс что DNSKEY2 настоящий. для этого надо подняться выше, найти там DS2 проверить 
что он настоящий..... итд итп. пока мы до корневого сервера не дойдем и его DS
все это можно увидеть в delv что и я сделаю но попозже. да.. dnssec это несупер сложно
но непросто и муторно.

прикол в том что лишь небльшая часть доменов имеют настроенные все эти записи

	RRSIG
	DNSKEY
	DS

чтобы можно было проверить аутентичность записи через dnssec
поэтому включив dnssec в systemd-resolved   не стоит радотваться что теперь каждый 
днс реквест будет проверен на аутентичность через dnssec
лишь очень малая часть запросов будет иметь возможсность быть проверенной на аутентичность
вот в чем прикол. это как ipv6 если его на компе включить то лишь небольшая часть 
серверрв в интенет его имеет. так что толку от этого ipv6 также и активация dnssec
на днс клиенте на нотбуке даст выхлоп лишь на небьлбшом числе реквестов. взять 
тот же самый gmail или google. важнейшие домены но их не проверить через dnnsec

 $ delv  google.com
; unsigned answer
google.com.		92	IN	A	142.250.181.238

 $ delv  gmail.com
; unsigned answer
gmail.com.		82	IN	A	142.250.186.37


 $ delv  mail.ru
; unsigned answer
mail.ru.		59	IN	A	94.100.180.200
mail.ru.		59	IN	A	217.69.139.202
mail.ru.		59	IN	A	217.69.139.200
mail.ru.		59	IN	A	94.100.180.201

 
 $ delv  ya.ru
; unsigned answer
ya.ru.			87	IN	A	77.88.44.242
ya.ru.			87	IN	A	5.255.255.242
ya.ru.			87	IN	A	77.88.55.242

 $ delv  youtube.com
; unsigned answer
youtube.com.		60	IN	A	142.250.186.46


тоесть все основные сайты неимеют у себя настроенных записей dnssec. так что для них
проверка dnssec аутентичности НЕРАБОТАЕТ ХАХАХАХ!!!!

  $ delv -4  www.usa.gov
; fully validated
www.usa.gov.		277	IN	CNAME	www.usa.gov.external-domains-production.cloud.gov.
www.usa.gov.		277	IN	RRSIG	CNAME 8 3 300 20240929215952 20240830215452 2971 usa.gov. ZnXHhkcpKTNfJKP9CX1EC6GtxG82ivIck5LJQcHsAeYUiCFbcGafP1gV ByLpM8YIBqia79dP7pU5dQsyE/2T7IKU7KGWaK33VO+Znoo3umkWQ/Zz oYbHzSwizpiadwFY1ezx666zMk5NNOB6IWPc9vz1atzxo18emiTDx0cn w+Q=




еще раз посмотрим на работу delv как он производит dnssec   валидацию

	$ delv  cloudflare.com +mtrace

на первом этапе delv запрашивает  A      запись с именем  cloudflare.com
и вместе с этим также запрашивает RRSIG  запись с именем  cloudflare.com



;; fetch: cloudflare.com/A

;cloudflare.com.			IN	A

;; ANSWER SECTION:
;cloudflare.com.		287	IN	A	104.16.132.229
;cloudflare.com.		287	IN	A	104.16.133.229
;cloudflare.com.		287	IN	RRSIG	A 13 2 300 (
;						20240903171149 20240901151149 34505 cloudflare.com.
;						HIBUSQVlveUE96VhzxoWE0xdsqRJ
;						5kl8gW/+cOJ1LxwqXrRtn4YjG2AZ
;						YHmc0In0WbwWsBEehdmltTuHt3fU
;						mA== )


таким макаром мы получили две A записи и цифровую подпись удостоверяющую их.

цифровая подпись  посмотрим на нее 

cloudflare.com   RRSIG	A 13 2 300 (
;						20240903171149 20240901151149 34505 cloudflare.com.
;						HIBUSQVlveUE96VhzxoWE0xdsqRJ
;						5kl8gW/+cOJ1LxwqXrRtn4YjG2AZ
;						YHmc0In0WbwWsBEehdmltTuHt3fU
;						mA== )

в этой записи есть интересная информация. A означает что RRSIG подписала запись 
типа А(хорошо RRSIG подписала кучку А записей), число 13 означает тип алгоритма
цифровой подписи . щас скажу какой

3 = DSA/SHA-1
5 = RSA/SHA-1
6 = DSA/SHA-1/NSEC3
7 = RSA/SHA-1/NSEC3
8 = RSA/SHA-256
10 = RSA/SHA-512
12 = GOST R 34.10-2001
13 = ECDSA/Curve P-256/SHA-256
14 = ECDSA/Curve P-384/SHA-384
15 = Ed25519 (EdDSA/Curve25519/SHA-512)[1][2]
16 = Ed448 (EdDSA/Curve448/SHAKE256)[1][2]

получается 13 означает что в цифровой подписи использован алогоритм DSA основанный
на эллиптических кривых ECDSA на основе эллиптической кривой P-256 , и цифровая подпись
расчитывается на базе хеша стандарта SHA-256 . тоесть берется оригинальный текст. 
в нашем случае это обьедиенная серия записей типа А  из которых получили sha-256.
и вот цифровая подпись ECDSA рассчитывается из хэше sha-256 
это все записано в цифре 13. теперь все понятно как примерно цфироавя подпись 
рассчыается.  цифра 2 означает что имя А записи имеет две части разеленные точкой.
и дейтвительно вот наш RRset

	cloudflare.com.		A	104.16.132.229
	cloudflare.com.		A	104.16.133.229

и у них имя   cloudflare.com и видно что да. оно состоит из двух частей разделенных
точкой. 

кстати запись RRSIG имеет сама ровно тоже самое название (это поле называется owner)
что и в оригинальных А записях входящих в RRset

300 это TTL который был у оригинальной записи А которую подписываем.

так с цифровой подписью более менее разобрались. что в этой записи какая полезная
информация в ней зашита помимо самого тела цифровой подписи.



далее нам чтобы проверить эти две А записи из RRset по цифровой подписи нам нужен публичный ключ который сможет расшифровать эту цифровую подпись . цифровой ключ можно руками 
найти вот по такому запросу

    тип=DNSKEY имя=cloudflare.com 
тоесть мы ищем

    DNSKEY  cloudflare.com 

эта запись  хранится на том же сервере который хранит в себе и записи 
которые мы уже скачали

;cloudflare.com.		A	104.16.132.229
;cloudflare.com.		A	104.16.133.229
;cloudflare.com.		RRSIG	A 

который мы уже скачали.  это сервер как можно найти самомму руками? 
этот тот сервер который содержится в NS записи

   тип записи=NS  имя записи=cloudflare.com тоесть

   cloudflare.com  NS     имя_сервера



итак delv получает записи DNSKEY 

;; fetch: cloudflare.com/DNSKEY

;cloudflare.com.			IN	DNSKEY


;cloudflare.com.		1673	IN	DNSKEY	256 3 13 (
;						oJMRESz5E4gYzS/q6XDrvU1qMPYI
;						jCWzJaOau8XNEZeqCYKD5ar0IRd8
;						KqXXFJkqmVfRvMGPmM1x8fGAa2Xh
;						SA==
;						) ; ZSK; alg = ECDSAP256SHA256 ; key id = 34505


;cloudflare.com.		1673	IN	DNSKEY	257 3 13 (
;						mdsswUyr3DPW132mOi8V9xESWE8j
;						To0dxCjjnopKl+GqJxpVXckHAeF+
;						KkxLbxILfDLUT0rAK9iUzy1L53eK
;						GQ==
;						) ; KSK; alg = ECDSAP256SHA256 ; key id = 2371


;cloudflare.com.		1673	IN	RRSIG	DNSKEY 13 2 3600 (
;						20241012045415 20240812045415 2371 cloudflare.com.
;						EGAV8jdo2rRj9Tl5hTM7c4FVKQX2
;						Llep3yQ61cPKqyLSBFpnkJQA2Twh
;						Acng2FfrWMKQ1SzXnppJni6X8W91
;						pg== )


еще раз скажу что мы скачали к этому моменту и где это хранится. мы
скачали записи


	;cloudflare.com.		A	     104.16.132.229
	;cloudflare.com.		A	     104.16.133.229
	;cloudflare.com.		RRSIG	 A ... 

	;cloudflare.com.		DNSKEY	 ...
	;cloudflare.com.		DNSKEY	 ...
	;cloudflare.com.		RRSIG	 DNSKEY  ...


все эти записи хранятся на условно говоря NS сервере. что такое NS сервер. это такой
сервер который хостит записи зоны\домена. этот сервер можно найти вот как. он записан 
в днс записи типа NS у которой имя  cloudflare.com , этот NS сервер его можно найти через запрос


   $ dig  NS  cloudflare.com

	cloudflare.com.		NS	ns5.cloudflare.com.
	cloudflare.com.		NS	ns4.cloudflare.com.
	cloudflare.com.		NS	ns6.cloudflare.com.
	cloudflare.com.		NS	ns7.cloudflare.com.
	cloudflare.com.		NS	ns3.cloudflare.com.

вот на любом из этих серверов хранятся все эти записи



рассмотрим подробнее DNSKEY записи которые мы скачали

;cloudflare.com.		1673	IN	DNSKEY	256 3 13 (
;						oJMRESz5E4gYzS/q6XDrvU1qMPYI
;						jCWzJaOau8XNEZeqCYKD5ar0IRd8
;						KqXXFJkqmVfRvMGPmM1x8fGAa2Xh
;						SA==
;						) ; ZSK; alg = ECDSAP256SHA256 ; key id = 34505

;cloudflare.com.		1673	IN	DNSKEY	257 3 13 (
;						mdsswUyr3DPW132mOi8V9xESWE8j
;						To0dxCjjnopKl+GqJxpVXckHAeF+
;						KkxLbxILfDLUT0rAK9iUzy1L53eK
;						GQ==
;						) ; KSK; alg = ECDSAP256SHA256 ; key id = 2371


во первых что это значит 

		alg = ECDSAP256SHA256

это значит что данный публичный ключ предназначен для рашифровки цифровой подписи 
которая основана на ECDSA тоесть dsa на эллиптической кривой P-256 которая сделана
над хешем sha-256
далее key id = показывает кей id у цифровой подписи RRSIG от которой этот публичный
ключ. 
отсюда четко видно что публичный ключ с key id = 34505 это публичный ключ от нашего
исходного RRSIG

;cloudflare.com.		1673	IN	DNSKEY	256 3 13 (
;						oJMRESz5E4gYzS/q6XDrvU1qMPYI
;						jCWzJaOau8XNEZeqCYKD5ar0IRd8
;						KqXXFJkqmVfRvMGPmM1x8fGAa2Xh
;						SA==
;						) ; ZSK; alg = ECDSAP256SHA256 ; key id = 34505


и вот напоминаю этот RSIG

cloudflare.com   RRSIG	A 13 2 300 (
;						20240903171149 20240901151149 34505 cloudflare.com.
;						HIBUSQVlveUE96VhzxoWE0xdsqRJ
;						5kl8gW/+cOJ1LxwqXrRtn4YjG2AZ
;						YHmc0In0WbwWsBEehdmltTuHt3fU
;						mA== )

итак delv считал публичный ключ от нашей цифровой подписи.
ZSK переводится как  zone signing key . тоесть это про ключ который шифрует днс записи RR

KSK перводится как key signing key. на самом деле это копия DS записи. которая собой
представляет хэш от DNSKEY записи. нахуй эта DS копия нужна я не знаю. ведь по хорошему
днс клиент должен считывать DS из парент домена. а зачем мне DS считанный из исходного
домена хрен знает


рассмотрю еще одну запись которую мы уже скачали

;cloudflare.com.		1673	IN	RRSIG	DNSKEY 13 2 3600 (
;						20241012045415 20240812045415 2371 cloudflare.com.
;						EGAV8jdo2rRj9Tl5hTM7c4FVKQX2
;						Llep3yQ61cPKqyLSBFpnkJQA2Twh
;						Acng2FfrWMKQ1SzXnppJni6X8W91
;						pg== )


это цифровая подпись ключа DNSKEY , вопрос только какого ключа. тот который ZSK
или KSK

я вижу 2371 и уменя впечатление что это цифровая подпись KSK ключа. 
а нахуй мне цифровая подпись копии DS записи непонятно.




далее идем в парент домен .com и скачиваем DS запись

;; fetch: cloudflare.com/DS
;cloudflare.com.			IN	DS

;; ANSWER SECTION:
;cloudflare.com.		5533	IN	DS	2371 13 2 (
;						32996839A6D808AFE3EB4A795A0E
;						6A7A39A76FC52FF228B22B76F6D6
;						3826F2B9 )

;cloudflare.com.		5533	IN	RRSIG	DS 13 2 86400 (
;						20240908011735 20240901000735 59354 com.
;						Hb4Zkf8qiklvQzEEp6RmjSzJMa9M
;						H8VQdEmerL+G6IIUJ6tZPkJtgNbc
;						YFRu5QYnJ+x0PgEdKaPqAkTaspJK
;						VA== )


вот он этот ключ DS

;cloudflare.com.		5533	IN	DS	2371 13 2 (
;						32996839A6D808AFE3EB4A795A0E
;						6A7A39A76FC52FF228B22B76F6D6
;						3826F2B9 )

видим что у него key id=2371 и он обозначает номер DNSKEY на основе которого создан 
этот DS.
ешще раз про : DNSKEY record contains a public signing key, and the DS record contains a hash* of a DNSKEY record

значит из того что я прочитал получается вот что. создается две пары ассиметричных ключей
пара ZSK , пара KSK.
с помощью приватного ZSK ключа создается цифровая подпись для днс записей , и эта 
цифровая подпись сохраняется в запись RRSIG1.
публичный ключ ZSK запиывается в запись DNSKEY1.
с помощью приватного ключа KSK создается цифровая подпись RRSIG2 от DNSKEY1 или другими
словами от публичного ZSK ключа. публичная часть KSK ключа запиывывается на этом же
серверер во второй DNSKEY2. таким образом днс клиент считывается RRSIG1 и с помощью
DNSKEY1 публчиног ключа провряет эту цифровую подпись RRSIG1. подлинность DNSKEY1
проверяется на основе  цифровой подписи RRSIG2 и публичного ключа KSK от нее DNSKEY2
DS в парент зоне содержит хэш от публичного KSK ключа тоест хэш от DNSKEY2
пара ключей ZSK она небоьлшоая по размеру. поэтому шфирование на основе ZSK раобает
быстро. и эти ключи надо менять часто. пара KSK ключей имеет болльшую длинну. и 
их часто менять ненужно. получается при заменее ZSK пары нужно перегенерироттвать RRSIG1
и RRSIG2 
при перегененрации KSK пары нужно заменить DS запиь в парент домене.

получаетя  мы скачиваем RRSIG1, RRSIG2, DNSKEY1, DNSKEY2 все с текущего сервера. 
далее мы с помоью DNSKEY1 проверяем RRSIG1. а далее мы проверяем достоверность
ключа DNSKEY1 через RRSIG2 и ключа от этой цифроваой подписи DNSKEY2.
а потом мы скыычсмем с парента DS и сравниваем его с DNSKEY2

  RRSIG1  <---- DNSKEY1
  DNSKEY1 <---- RRSIG2 <---- DNSKEY1 <---- DS

можно было бы бойтист одной парой но с двумя парами удбонее вроде как. при замене ZSK 
пару нам ненужно перегененировать DS в парень домене. 


>>>>> задача переделать текс с самого верха так как я неверно понимал до этого
что такое ZSK и KSK пара





;; fetch: com/DNSKEY
;; received packet from 127.0.0.53#53
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id:  61827
;; flags: qr rd ra cd; QUESTION: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1
;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags: do; udp: 65494
; PAD: (173 bytes)
;; QUESTION SECTION:
;com.				IN	DNSKEY

;; ANSWER SECTION:
;com.			8280	IN	DNSKEY	256 3 13 (
;						Nps5nxuQHRbY3e9hcbH36kxiELJH
;						5wil+6dC4K1keQI9ci1nqyCP4k1X
;						oXBBn2aeSK4KxwPEs0Opqc0dicuu
;						jg==
;						) ; ZSK; alg = ECDSAP256SHA256 ; key id = 59354
;com.			8280	IN	DNSKEY	257 3 13 (
;						tx8EZRAd2+K/DJRV0S+hbBzaRPS/
;						G6JVNBitHzqpsGlz8huE61Ms9ANe
;						6NSDLKJtiTBqfTJWDAywEp1FCsEI
;						NQ==
;						) ; KSK; alg = ECDSAP256SHA256 ; key id = 19718
;com.			8280	IN	RRSIG	DNSKEY 13 1 86400 (
;						20240909140235 20240825135735 19718 com.
;						8dBNzd4TFQj35TTQr1/6MM+BG2mm
;						mgGZfgn231XORw7M2r67xSzo0D5o
;						jdvl5ufLm8guJmKQKG20mbSSTnpu
;						Tw== )


;; fetch: com/DS
;; received packet from 127.0.0.53#53
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id:  51632
;; flags: qr rd ra cd; QUESTION: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1
;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags: do; udp: 65494
; PAD: (97 bytes)
;; QUESTION SECTION:
;com.				IN	DS

;; ANSWER SECTION:
;com.			75650	IN	DS	19718 13 2 (
;						8ACBB0CD28F41250A80A49138942
;						4D341522D946B0DA0C0291F2D3D7
;						71D7805A )
;com.			75650	IN	RRSIG	DS 8 1 86400 (
;						20240915050000 20240902040000 20038 .
;						FKTYPlPejqvpS00J7nfdhr8BEAP/
;						ZSeWh5CCjmgaSylys1i5WmrISXm1
;						CYeKEzOpnMI0IqAqDtjNB9AMj0dl
;						PfuLN9eGCWnDG2MZNl2aR6wodi8N
;						cA0sFN8rw8MVrWa8zsuSFKapJxKI
;						s3QhPdOYBK4SumGHq7tB13PEugvY
;						icIHSUTh0mdYKhhEUMsg61dwFVe3
;						3RihKpXk4xqSdUvviNpJMzc5d3DA
;						UBZAZ2YTuP7S/wuQVdakxdFbE7+j
;						z3+/EYWca8T4B0wDZGH02TjfEqbO
;						1opyPNedQf7vAfWAXYSRuuxBUQYK
;						M9X0nlTGDUpu5V4yOFFgnv+EVdi/
;						M4ta6g== )


;; fetch: ./DNSKEY
;; received packet from 127.0.0.53#53
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id:  13294
;; flags: qr rd ra cd; QUESTION: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1
;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags: do; udp: 65494
; PAD: (68 bytes)
;; QUESTION SECTION:
;.				IN	DNSKEY

;; ANSWER SECTION:
;.			846	IN	DNSKEY	256 3 8 (
;						AwEAAdSiy6sslYrcZSGcuMEK4DtE
;						8DZZY1A08kAsviAD49tocYO5m37A
;						vIOyzeiKBWuPuJ4m9u5HonCM/ntx
;						klZKYFyMftv8XoRwbiXdpSjfdpNH
;						iMYTTV2oDUNMjdLFnF6HYSY48xrP
;						bevQOYbAFGHpxqcXAQT0+BaBiAx3
;						Ls6lXBQ3/hSVOprvDWJCQiI2OT+9
;						+saKLddSIX6DwTVy0S5T4YY4EGg5
;						R3c/eKUb2/8XgKWUzlOIZsVAZZUS
;						TKW0tX54ccAALO7Grvsx/NW62jc1
;						xv6wWAXocOEVgB7+4Lzb7q9p5o30
;						+sYoGpOsKgFvMSy4oCZTQMQx2Sjd
;						/NG2bMMw6nM=
;						) ; ZSK; alg = RSASHA256 ; key id = 20038
;.			846	IN	DNSKEY	257 3 8 (
;						AwEAAaz/tAm8yTn4Mfeh5eyI96WS
;						VexTBAvkMgJzkKTOiW1vkIbzxeF3
;						+/4RgWOq7HrxRixHlFlExOLAJr5e
;						mLvN7SWXgnLh4+B5xQlNVz8Og8kv
;						ArMtNROxVQuCaSnIDdD5LKyWbRd2
;						n9WGe2R8PzgCmr3EgVLrjyBxWezF
;						0jLHwVN8efS3rCj/EWgvIWgb9tar
;						pVUDK/b58Da+sqqls3eNbuv7pr+e
;						oZG+SrDK6nWeL3c6H5Apxz7LjVc1
;						uTIdsIXxuOLYA4/ilBmSVIzuDWfd
;						RUfhHdY6+cn8HFRm+2hM8AnXGXws
;						9555KrUB5qihylGa8subX2Nn6UwN
;						R1AkUTV74bU=
;						) ; KSK; alg = RSASHA256 ; key id = 20326
;.			846	IN	RRSIG	DNSKEY 8 0 172800 (
;						20240920000000 20240830000000 20326 .
;						EaIMPt/CkTr3713no0YhuwCSwpn4
;						+CcpVh3w2tezZ9iAft6ynifFTyWe
;						jvJX+61X5XHmvjSbgzGNuPdnveIq
;						2GIeK669S9+NHw0IKUS+KYc14tTg
;						g3I6yVFCuzH89QWigyT7aQdUvxwV
;						AujGflfE0sF2qgiQWlbg+t+iVwiT
;						TGK10rjgHIA/S6BWA0ihoUUI/eCn
;						iojGTUx+sWvqwx4BHSjJT3NsTkfs
;						O44+d9RiDPB277BwHcj11jq3KD44
;						xz2KR24z6dlHJSykYrP7zuLGkeSN
;						wo6/IflA9g7kRZnLYL2ynwrCiz3S
;						wb+EA+gYkN+FIvX0Ud+JGGstmnp8
;						1p+F2g== )


; fully validated
cloudflare.com.		287	IN	A	104.16.132.229
cloudflare.com.		287	IN	A	104.16.133.229
cloudflare.com.		287	IN	RRSIG	A 13 2 300 20240903171149 20240901151149 34505 cloudflare.com. HIBUSQVlveUE96VhzxoWE0xdsqRJ5kl8gW/+cOJ1LxwqXrRtn4YjG2AZ YHmc0In0WbwWsBEehdmltTuHt3fUmA==
 1 掖  $ 






| proxmox

как рабтает файрволл тоткоторый в веб морде можно активровать.

во первых это все тот же iptables\nftables
проксокмс тольк в него свои праивила наталкивает. не более тогго. нет магии.



его можно активровать в трех местах в трех уровнях.

 * на уровне датацентра
 * на уровне хоста
 * на уровне ВМ


на каэом уровне можно задавать свои правила.


что будет если актировать файрволл на уровне хоста.
на нем активруются правила которые будут ксаться ТЛЬКО ХОСТА! тоесть сет карточек
и ип самого хоста. тоесть доступнось и трафик на ВМ активация этого файвролла НИКАК 
НЕЗАТРООНЕТ. тут нужно еще вот как понимать. - те правила которые мы уаызваем
в св2оствах файвролла они применяются к портам/картчокам которые на данном уровне
файрволла есть. если мы работмем с файвролоом на уровне хоста то поразумевается что
праивла касатся 	КАРТОЧЕК СЕТВОГ СЕТКА ХОСТА . тоесть те которые хост видит в своем
сетевом  сетеке. и правила можно задвать только для INPUT или OUTOUT трафика. поэтому 
трафик которые течет от виртулок с их портов которые хост просто невидит (так как они
сидят за вирт свичом) эти настройки не затарагивают! потому что трафик от виртуалок
с точки зрения иптбейлс хоста это FORWARD (тразтный трафик). поэтому суммарно активация 
файрволла на уровне хоста никак не зтаргиуавает трафик на вртулки или с виртуалок.


активация файрволла на уровне датаетра это по сути активация правил для хостов!  а не виртулок.
единсвтенное что файрволл на уровне датацетра как бы задает общие правила для всех хостов.
тоесть праила которые мы впишем на уровне датацетра они опять же будут регуилирвать
INOPUT, OUTPUT трафик сет карточек хоста. 


тоесть правила фарйволла на уровне датацетра это общие правиала для каждого хоста.
правила айрваолла на уровне хоста это праила индивидульные для хоста.


ест такой момент - если файвролл на уровне датцентра неактивровн то бесподезно его активровать
на уровне хоста!

итак ещераз.  правла файрвола на уровне датацентра касаются INPUT OUTPUT трафика 
сет картчоек хоста.  просто там укзыают общие правила для всех хостов.

правила файрволала на уровне хоста это тоже праила хоста но уже индицалные для именно
этого хоста. тотже INPUT\OUTPUT трафик.

чтобы на хосте заработал файвррволл нужно обязательно активровать файрволл и на уровне
жатацентра и на уровне хоста! иначе нихуя он не включится.


активация файволлна на уровне вм  имеет силу толко если файрволл активрован на всех
трех уровнях - датацетр, хост, вм.
на уровне вм мы присывеваем правила котроые будут прмиенться для INPUT\OUTPUT трафика 
сет карточек этой вм. именно тутошние праивла будут резать ее трафик. правила уровня хоста
ит датацентра на трафик вм нихуя не влияеют. каждая вм у нас выткется своими картчками
в вирт свич. так вот на хосте прокспкос будут созданы правила которые 
привзяаные именно к эьтим портам свича.

скажем вм сточки зрения хоста имеет порты

tap108i0
tap108i1



котоыре воткнуты в бридж

тогда под них образуются вот такие цепочки 

:tap108i0-IN - [0:0]
:tap108i0-OUT - [0:0]
-A PVEFW-FWBR-IN -m physdev --physdev-out tap108i0 --physdev-is-bridged -j tap108i0-IN
-A PVEFW-FWBR-OUT -m physdev --physdev-in tap108i0 --physdev-is-bridged -j tap108i0-OUT


и в этих цепочках будут вот такие правила
прописанные в файрволле на уровне вм

-A tap108i0-OUT -j GROUP-sg1-OUT
-A tap108i1-OUT -j GROUP-sg1-OUT

:GROUP-sg1-OUT - [0:0]
-A GROUP-sg1-OUT -j MARK --set-xmark 0x0/0x80000000
-A GROUP-sg1-OUT -d 10.200.10.1/32 -g PVEFW-SET-ACCEPT-MARK
-A GROUP-sg1-OUT -d 10.10.60.1/32 -g PVEFW-SET-ACCEPT-MARK
-A GROUP-sg1-OUT -d 10.200.10.0/24 -j DROP
-A GROUP-sg1-OUT -d 81.177.164.125/32 -j DROP
-A GROUP-sg1-OUT -d 10.10.60.0/24 -j DROP
-A GROUP-sg1-OUT -m comment --comment "PVESIG:dOX4kTBNgaGI1mpADAS8FdgK+nI"



тоесть правила которые мы прописываем на файвроллле уровня вм
они привязываются к портам


tap108i0
tap108i1


которыми эта карта воткнута в вирт свич

поэтому именно праивла описанные на уровне вм влияют не ее трафик исходящий
и входящий. приавла опмсннные на файрволеел урвня хоста или датацентра привзяются к 
сет карточкам хоста а не вм. и пэтому на трафик для вм никак вобщемто не влияют.

когда мы захдоим на файрволл уровня датацентра/хоста/вм надо себя спросить
на какие порты прокспкос навесить эти правила. тогда станет понятно на что полияют
этипраивла.

  в файрволле датацентра правила навещиюстя на сет карты хоста
  в файрволле хоста правила навещиюстя на сет карты хоста
  в файрволле вм правила навещиюстя на сет карты вм !


чтобы зараотали праивла файвролла хоста нужно активровать файрволл на уровне 
датацетна и на уровне хоста.

чтобы заработали правила пприсанные в фарволле вм нужно активровать файвролл на датацентре,
хосте, вм. при этом праивла котоыре будт влиять на трафик вм  указаны в свойствах 
файрволла вм. правила укзанные в файвроллах выше уровней на вм нахуй не влияют.

в своствах файрвлла вм есть дефлотовые политики 

   input : DROP
   outpue : ACCEPT


поэтму еслимы активируем фарволл на уровне вм то входящий трафик на вм 
сразу вобшемто будет дропаться если тлокьо мы в свойствах фаврллла не указали
явные разрешабщие правила.
тким обарзм как тлько мы актируем файрволл на вм то на нее достучаться мы хер сможем
а вот она сможет как и прежде ходиьт куда угодно.

также в свойствах портов вм там лдя кжадого портаукзывается  применять ли праила
файвролла на этот порт. поэтому если мы ъхотим чтобы правила файврлла уровня вм 
прмиенядись для всех портов вм то нужно в свойствах каждого ееногопорта поставить 
обязательно галку 

   "FIREWALL"




оттвет на вопрос - чтр будет еслия вктиврую фавролл на уровне датцентра.
ответ не будет нихера. вообще ниехра.

что если потом активовать также файвролл на уровне хоста - ответ в хост подтянуться
правила уровня датцентра плюс правила для хоста и они активруются на хосте в иптбелс.
оникоснутся тлоько INPUT\OUTPUT трафика сет карточек хоста но  портов воктнутых в вирт
свич тоесть трафика ВМ это никак не затронет. все вм должны будут быть доступны как и 
прежде.

что будет если потом дополенительнро активровать фарволл на отдельной вм.
правила уровня датацентра и правила уровня хоста никак не будут "пришиты" к этой вм. они ей
похер. будут прикленеены к вирт портам вм правила указные в свойситвах файрволла 
этой вм.  также по дефлуту к этой вм применпися политика 

  input : DROP
  output: ACCEPT


если нет явных разершающих правила для этой вм на фароволле уровня этой вм то связь 
к этой вм будет потеряна входящая.



в свотвах фавроллла хоста указано через какое механизм навещивать правила
на хосте.  по дефолту это  старый ипбейтблс. но там же можно поменять 
чтобы онинавешивались через nftables

в лююбом случае и правила уравоня хоста и праивла урвоня вм в конесном итоге
суются в иптбелс/нфтейблс хоста.  смотрим их воттак

   iptables-save
   nft list ruleset


там буутдут указные все правила. и уровня хоста и уровня вм. просто они бубудут укзываться
для разных карточек - лиьбо хоста, либо вирт портов на бридже.







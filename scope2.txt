| scope
| ip
| iproute2

дан хост и на нем дано маршруты
и ип адреса


	маршруты
default via 172.16.10.1 dev enp0s3 onlink 
172.16.10.0/24 dev enp0s3 proto kernel scope link 
172.16.70.0/24 dev enp0s3 proto kernel scope link 


	ип адреса
enp0s3:
    inet 172.16.70.15/24 brd 172.16.70.255 scope link enp0s3
    inet 172.16.10.15/24 brd 172.16.10.255 scope global enp0s3:0




	делаю пинг
# ping -4 -c1 172.16.70.14

ядро выберет маршрут
172.16.70.0/24 dev enp0s3 proto kernel scope link 
что логично

так вот видим что  у этого маршрута нет src_IP
значит ядро смотри на скоуп маргшрута. это scope=link
и смтрит какая карта показана на выход это enp0s3
тогда ядро идет к этой карте и ищет первый попавшийся
ip у котрого scope=link
смотрим

enp0s3:
    inet 172.16.70.15/24 brd 172.16.70.255 scope link enp0s3
    inet 172.16.10.15/24 brd 172.16.10.255 scope global enp0s3:0

значит этот ип будет  172.16.70.15 этот ип и будет
выбран как src_ip у пакета

можно это еще вот так увидеть
# ip -c r get  172.16.70.14
172.16.70.14 dev enp0s3 src 172.16.70.15 uid 0 

вот он так четко и написал что src 172.16.70.15
итак я делаю 

# ping -4 -c1 172.16.70.14

и будет послан пакет 
  src_ip=172.16.70.15 dst_ip=172.16.70.14


теперь я делаю другой пинг
# ping -4 -c1 172.16.10.11

мы попадаем на маршрут 
172.16.10.0/24 dev enp0s3 proto kernel scope link 

для него указана выходная карта enp0s3 и  scope=link

идем в эту карту и ищем первый ип с таким скоуп
enp0s3:
    inet 172.16.70.15/24 brd 172.16.70.255 scope link enp0s3
    inet 172.16.10.15/24 brd 172.16.10.255 scope global enp0s3:0


это вот такой ип

    inet 172.16.70.15/24 brd 172.16.70.255 scope link enp0s3

значит 
# ping -4 -c1 172.16.10.11
породит пакет 

  src_ip=172.16.70.15 dst_ip=172.16.10.11  (!!)

проверяю это еще и вот так
# ip -c r get  172.16.10.11
172.16.10.11 dev enp0s3 src 172.16.70.15 uid 0 

получается что у нас если роуты вот такие

  ...... dev enp0s3  scope link
  ...... dev enp0s3  scope link

и вот такие ип

  ......  scope link
  ......  scope global


то при пинге любого указанного маршрута у нас
ядро будет выбирать ип где scope link и неважно
входит ли выбраный ип в туже есть что и ип в
маршруте или нет.
еще раз покажу результат

маршруты
172.16.10.0/24 dev enp0s3 scope link 
172.16.70.0/24 dev enp0s3 scope link 

ип
172.16.70.15/24 scope link enp0s3
172.16.10.15/24 scope global enp0s3:0

пинг
ping 172.16.10.11 
 src_ip=172.16.70.15-->dst_ip=172.16.10.11

ping 172.16.70.14 
  src_ip=172.16.70.15-->dst_ip=172.16.70.14


теперь я делаю вот такие маршруты
172.16.10.0/24 dev enp0s3 scope link 
172.16.70.0/24 dev enp0s3 scope link

и вот такой ип на карте
172.16.70.15/24 scope host enp0s3

и получается при пинге любого хоста из этих 
двух маршрутов. так как маршурты имеют scope=link
то ядро ищет на карте ип с таким скоуп и ненайдет.
поэтому src_ip будет ненайден подходяий на этой карте
и ядро тогда подставит 

  src_ip=0.0.0.0


ВАЖНО сказать что вся этя штука со скоупами имеет
силу только если в маршруте не указан src_ip. только
в этом случае скоупы начинают учитываться ядром.
иначе они полностью игнорируются.








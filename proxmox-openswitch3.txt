| proxmox
| ifupdown
| ifupdown2
| open switch
| openvswitch
| openswitch
| InternalPort

после того как поставили проксомкс с его ISO диска 
мы входим в консоль и в плане сети мы видим что установкщик создал vmbr0
вирт свич на базе стандартного линукс свича. назначил ему IP и добавиил физ карту
как аплинк карту.

так вот линукс стадантрый свич это полная хуета. особенно VLAN AWARE станадртный свич. 
например придобавлении нового вилана нужно его полностью гасить а потом все его 
порты заново поднимать. что полный пзидец.

поэтому нужно на хосте устанвоить open switch и раобтать только с ним


 # apt-get install openvswitch-switch


так вот второй момент что ISO диск с прокмокс он неиспользует ifupdown как network manager
а использует ifupdown2
так вот выяснлся неождлианный на пустом месте пиздец он состоит в том что это надо пебаться
и найти еще такой набор парамтров который нужно вставить в /etc/network/interfaces чтобы
ifupdown2 читая этот конфиг коректно поднял опенсвич и его порты! в сети инфо мало
иона хуй знает какая. главня проблема с которой столкнулся я это то что если я в interfaces
вставляю Internal Port оенсвича то  systemctl restart networking хрен этот порт заведет.
тоесть помсле перезапуска сети порты опенсвича так как нужно не поднималсись!
Итак вот пример конфига который работает все остальные варианты нихуя не работают



	# cat /etc/network/interfaces


auto lo
iface lo inet loopback




auto vmbr0
iface vmbr0 inet manual
        ovs_type OVSBridge
        ovs_ports enp0s3 int0




auto enp0s3
iface enp0s3 inet manual
        ovs_bridge vmbr0
        ovs_type OVSPort



auto int0
iface int0 inet static
	    address 192.168.2.50
		netmask 255.255.255.248
		gateway 192.168.2.49
        ovs_type OVSIntPort
        ovs_bridge vmbr0
		ovs_options tag=100




auto int2
iface int2 inet static
        address 192.168.2.58
		netmask 255.255.255.248
        ovs_type OVSIntPort
        ovs_bridge vmbr0
		ovs_options tag=101





source /etc/network/interfaces.d/*





это пример когда мы создаем openswitch br0
в него выткаем в качестве аплинка физ порт enp0s3
и также мы создаем два Internal порта int0 и int2
каждый из них имеет свой IP и каждый из них акцесный и сидит в своем вилане.


порт enp0s3 с точки зрения опенсвич имеет тип OVSPort тоесть это означает что 
это порт который уже существует на компе и мы просто его вставляе в наш свич
как я понимаю такой порт авмтоматом считается транковым и разрешает пропускать
через себя все транки.


вот как это выглядит с токи зрения опенсвича


root@pr-h1:/etc/network#        ovs-vsctl --columns=name,tag,trunks,vlan_mode list port
name                : int2
tag                 : 101
trunks              : []
vlan_mode           : []

name                : enp0s3
tag                 : []
trunks              : []
vlan_mode           : []

name                : vmbr0
tag                 : []
trunks              : []
vlan_mode           : []

name                : int0
tag                 : 100
trunks              : []
vlan_mode           : []



в целом мы можем более в явном виде задать что enp0s3 это транковый порт 
опцией

		ovs_options vlan_mode=trunks

или целиком секция


auto enp0s3
iface enp0s3 inet manual
        ovs_bridge vmbr0
        ovs_type OVSPort
		ovs_options vlan_mode=trunk



я проверил все раобтает. 
также при желании можно огарнивить какие транки мы рарешаем на вылет из этой транк карты
через опцию

    		ovs_options trunks='[22,33,]'


но обычно так не делают. делают что можно чтобы все вылетали.



насколкьо я понял вместо длинной и тяжелой операции 

  # systemcl restart networking

есть более быстрая леговесная это 

  # ifreload -a -v


значит я еще наебаляся с одной мелкой ошибкой вот какой. 
опенсвич интенал порт он зачем создается зачем нужен. это не tap порт потэтому к нему
нельзя прицепить виртуалку а создается он только для того что на него можно навесить
IP адрес и вилан с ХОСТА таким образом подрубиться проникнуть в сеть такогото вилана
который ходить внутри свича. говоря проще - таким макаром можно с хоста подрубиться в сеть
такото виртулки.
так вот я наебаля с тем что я выставил интернал порт в режиме транк! а это гипершикбка!
потому что режим транк означает что изнутри свича наружу тоесть в мою ос поток подается
тегированный. и обратный процесс с моего хоста всвич ожиается уже тегированый поток.
поэтому если я назначаю со стороны свича что этот порт он транковый вот такими способами

	ovs-vsctl set port PORT1 vlan_mode=trunk
	ovs-vsctl set port PORT1 trunks=[99]


а потом со стороны хоста я этому же порту вот так ип назначаю

5: int0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UNKNOWN group default qlen 1000
    link/ether f6:a4:48:2e:0d:aa brd ff:ff:ff:ff:ff:ff
    inet 192.168.2.50/29 scope global int0
       valid_lft forever preferred_lft forever


то связь по этому порту НЕЗАРАБОТАЕТ! потому что со сторны ОС я натсроил этот порт 
как акцессный!

мне тогда со сторны ОС нужно насрваивать этот порт примерно вот так



2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether ba:ec:24:ee:04:03 brd ff:ff:ff:ff:ff:ff

4: enp0s3.100@enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether ba:ec:24:ee:04:03 brd ff:ff:ff:ff:ff:ff
    inet 192.168.2.52/29 scope global enp0s3.100
       valid_lft forever preferred_lft forever


тоесть я выделаю субинтерфейс. и на него уже вешаю ИП. и тогда линукс понимает что 
в физ порт enp0s3 нужно пихать трафик тегировный.


поэтому вот это надо четко понимать.  если я нехочу ебатья со стороны ос с транками 
и субинтфрйесами то нужно на стороне свича порт образначать как АКЦЕССНЫЙ.
а если я со стороны свича назначил порт как транковый то тогда со сторны ОС нужно выделатья
на порту субинфтрейс по такомуто транку. !!!!!
а я со сторны свича обозначил что порт транковый а со стороны ос работал с ним как с ацесныйм
в итоге пинги неходили!


но все таким соамое главное это вот вид эотого конифга


	# cat /etc/network/interfaces


auto lo
iface lo inet loopback




auto vmbr0
iface vmbr0 inet manual
        ovs_type OVSBridge
        ovs_ports enp0s3 int0




auto enp0s3
iface enp0s3 inet manual
        ovs_bridge vmbr0
        ovs_type OVSPort



auto int0
iface int0 inet static
	    address 192.168.2.50
		netmask 255.255.255.248
		gateway 192.168.2.49
        ovs_type OVSIntPort
        ovs_bridge vmbr0
		ovs_options tag=100




auto int2
iface int2 inet static
        address 192.168.2.58
		netmask 255.255.255.248
        ovs_type OVSIntPort
        ovs_bridge vmbr0
		ovs_options tag=101



имено тогда при таком конфиге все порты поднимутся без проблем.
в сети полновсякой шняги с неработающими ключами вконфиге
например пишу что нужно использовать ключи

  allow-XXX 

но эта хуйня нахуй ненужна. все работает именно с такими ключами.

еще есть какието всякие полезные нюансы.
например.
когда мы создали опенсвич то его порт тоже является internal портом. и при 
желании можно ИП навесить на него. делается это вот так



auto vmbr0
iface vmbr0 inet static
        address 192.168.2.50
    	netmask 255.255.255.248
        ovs_type OVSBridge
        ovs_ports enp0s3 int0
        ovs_extra set port vmbr0 tag=100


тоесть вот эта строка
	iface vmbr0 inet manual
меняется на 
	iface vmbr0 inet static


и добавляются вот эти строки
        address 192.168.2.50
    	netmask 255.255.255.248
        ovs_extra set port vmbr0 tag=100

причем важна вот эта строка
        ovs_extra set port vmbr0 tag=100
она говорит что наш интернал порт является акцессным и его вилан 100

как сделать этот же порт транковым хуй знает.
засада еще в том что обычный интернал порт оборзанчается как акцснный через запись
		ovs_options tag=101
но конкртено в случае главного бриджевого порта это несработает и нужна именно
опция
        ovs_extra set port vmbr0 tag=100


я читал такие ужасы что типа имеем хост прокксокс плюс опенсвич. 
люди меняют конфиг interfaces потом рестартутют сеть и у них часть портв не поднимается
итп. ужас.  я считаю что дерагать сет настройки на раблтающем с виурталкаами прокоскос хосте
это самоубсийттво. еси хочешь чтото пменят с сетью делаю это через cli утилиты

   # ip ...
   # ovs-vsctl ....

и задним числом вности изменеиы в файл interfaces

но не так что измеяешь interfaces и рестартуешь сеть . НЕТ!



| zfs
| recordsize

значит коротко.

как работает recordsize.

мы создаем пул. это просто куча блоков. едиснвтенное что мы указываем ashift
то есть типа размер физ блока. тоесть пул это типа куча блоков кажый из которых имеет
размер ashift.(ашифт после создания пула менять никак нельзя)


   # dd if=/dev/urandom of=./file1  bs=1M count=100 status=progress
   # zpool create -o ashift=13  testpool   ./file1

потом на пуле мы создаем датасет.

   # zfs create testpool/ds1


для датасета задется параметр recordsize по дефолту он 128к. и его можно менять в любой момент.


# zfs get recordsize testpool/ds1
NAME          PROPERTY    VALUE    SOURCE
testpool/ds1  recordsize  16K      local

# zfs get recordsize testpool/ds2-128k
NAME               PROPERTY    VALUE    SOURCE
testpool/ds2-128k  recordsize  128K     local


при создании датасета его автмоатом зфс монтиуерует в папку. например датасет testpool/ds1
будет авматомтатом сонтирован в ппку testpool/ds1

так величайшая тайна что дает и что делает и на что влиеет рекордсайз.

значит датасет это уже файловая система. она состоит из блоков файловой системы.
эти блокиФС они в свою очредь состояи из блоков пула тоесть физ блоков уже на дисках.
так вот каждый блокФС он не сам по себе болтается а он принадлжеить файлу.
также в одном блокеФС может лежать толко тело одного файла. тела от двух файлов не моугтут
лежать в одном блокеФС. файл минимально состоит из одного блокаФС. или из многих.
когда мы создаем файл на фС. то зфс под него создает блокиФС на фс.

одна из важных свойств блокаФС в том что он имеет контроьну сумму. (более того после создания
блокаФС ряд других блоков будет иметь обновление контрьльных сумм из за этой контронойо сумммы
чтоттот типа кругогвой поруки или блокчейна.но щас все аткие не об этом)

предположим мы содздаем в начале маленткйи файл с крошечным телом. 
файл с телом 2K.


   # dd if=/dev/urandom bs=2K count=1 of=/testpool/ds1/t10-2k.dat


так вот если запрос на запись меньше чем рекордсайз , тоесть у нас в данном случае
мы просим создать файл и записать на диск 2К данных а рекордсайз на этом датасете равен 16К
ТО зфс создает блокФС равный размеру рквеста на запись то есть зфс созадаст блокФС размером 2К.
как я уже сказал этот блокФС будет иметь контроьну сумму. а это сразу значит то что 
если мы хотим пото считать из этого блокаФС 500байт то зфс по факту прочтет с диска все 2К
потому что ей надо сверить контроьную сумму. но щас не об этом.
итак у нас запрос на запись был 2К а рекордсет 16К и пофатку на диске создася блоакФС 
размером 2К. вроде как пока влияение роекрдсета нулевое.

щас я покажу как узнать сколько блоковФС занимет тело файла и какого они размера



при замене рекродмесета файлу похуй на этом 
